<!-- Version 97 -- Fixes JSON Loading Error, Image Centering, Quantity Logic -->
<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8"/>
<title>Offert</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<style>
/* ------------------ PRINT STYLES ------------------ */
@media print {
    @page { size: A4; margin: 10mm; }
    body { font-family: 'Arial', sans-serif; font-size: 10.5pt; line-height: 1.2; }
    body * { visibility: hidden; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    #quoteContent, #quoteContent * { visibility: visible; }
    #quoteContent { position: absolute; left: 0; top: 0; width: 100%; padding: 0; margin: 0; }
    
    /* WYSIWYG Image Layout for Print */
    #infoImagesList {
        display: flex !important;
        flex-wrap: wrap !important;
        justify-content: flex-start;
        align-items: flex-start;
        width: 100%;
        gap: 10px;
    }
    
    .info-block {
        page-break-inside: avoid !important;
        box-sizing: border-box;
        margin-bottom: 10px;
    }

    .info-block-fullwidth {
        width: 100% !important;
        flex-basis: 100% !important;
        display: block !important;
    }

    /* Alignment Logic for Print */
    .info-block.align-center {
        flex-basis: 100% !important;
        width: 100% !important;
        display: flex !important;
        flex-direction: column;
        align-items: center !important;
        text-align: center !important;
    }
    
    .info-block.align-left {
        flex-basis: auto !important;
        width: auto !important;
        display: inline-flex !important;
        flex-direction: column;
        align-items: flex-start !important;
        text-align: left !important;
    }

    .info-image-container img {
        max-width: 100% !important;
        height: auto !important;
        max-height: 250mm !important;
    }

    b { font-weight: bold; }
    i { font-style: italic; }
    .print-only { display: block !important; }
    #printMultiplier { position: relative !important; bottom: auto !important; right: auto !important; margin-top: 1mm !important; font-size: 8pt !important; color: white !important; text-align: right; width:100%; }
    .quote-section { margin: 5mm 0; page-break-inside: avoid !important; }

    .item-header, .item-meta {
        display: grid;
        grid-template-columns: 50px 1fr 80px 100px;
        gap: 5mm;
        align-items: start;
        padding-bottom: 1.5mm;
    }
    .item-header { border-bottom: 1pt solid #000; margin-top: 3mm; font-weight: bold; }
    .item-header > div, .item-meta > div { word-wrap: break-word; overflow-wrap: break-word; }
    .item-number { text-align: left; }
    .item-name { text-align: left; }
    .quantity, .quantity-header { text-align: center; justify-content: center; padding-right:0; }
    .targetPrice, .price-header, .subItemTargetPrice { text-align: right; justify-content: flex-end; padding-right: 2mm; box-sizing: border-box; }

    .included-item {
        background-color: #fafafa !important;
        margin: 2px 0 2px 10mm !important;
        padding: 2mm !important;
        border-radius: 0 !important;
        width: calc(100% - 10mm);
        box-sizing: border-box;
    }
    .included-item .item-meta {
        margin-left: 0;
        grid-template-columns: 40px 1fr 75px 95px;
        gap: 2.5mm;
        padding-left: 0;
    }
    .included-item.baked-in .subItemTargetPrice { display: none !important; }
    .quote-item.baked-in .targetPrice { display: none !important; }
    body.show-baked-item-prices .quote-item.baked-in .targetPrice,
    body.show-baked-subitem-prices .included-item.baked-in .subItemTargetPrice { display: flex !important; }

    .item-details, .included-item .item-details {
        word-wrap: break-word !important; overflow-wrap: break-word !important;
        white-space: normal !important;
        max-width: calc(100% - (50px + 5mm)); 
        margin-left: calc(50px + 5mm); 
        margin-right: 0;
        padding: 1mm 0;
    }
     .included-item .item-details {
        margin-left: calc(40px + 2.5mm); 
        max-width: calc(100% - (40px + 2.5mm));
    }

    .term-item { margin: 0.2mm 0; padding-bottom: 0.2mm; padding-left: 0 !important; }
    .term-item .editable { width: 100% !important; } 
    .info-text { word-wrap: break-word !important; overflow-wrap: break-word !important; }
    .total-price { margin-top: 4mm; padding-top: 2mm; border-top: 1pt solid #000; text-align: right; padding-right: 0; page-break-inside: avoid !important; }
    h3 { page-break-before: auto !important; page-break-after: avoid !important; margin-top: 6mm; margin-bottom: 3mm !important; }
    
    .screen-only { display: none !important; }
    .hidden-from-print { display: none !important; }
    .controls-row .remove-icon { display: none !important; }
    #infoImagesList .info-block { padding-left: 0 !important; }
    #signatureSection { margin-top: 10mm; page-break-before: auto; }
    
    .vendor-price-details, .vendor-item-notes { display: none; }
    body.vendor-print-mode .vendor-price-details,
    body.vendor-print-mode .vendor-item-notes {
        display: block !important;
        font-size: 8pt;
        color: #444;
        border-top: 1px dotted #ccc;
        margin-top: 2mm;
        padding-top: 1.5mm;
        margin-left: calc(50px + 5mm);
        grid-column: 2 / 5;
    }
    body.vendor-print-mode .included-item .vendor-price-details,
    body.vendor-print-mode .included-item .vendor-item-notes { margin-left: calc(40px + 2.5mm); }
    body.vendor-print-mode .vendor-price-details div { margin-bottom: 0.5mm; }
    .vendor-item-notes { white-space: pre-wrap; background-color: #fefee9 !important; padding: 1.5mm; }
    .page-break-element { page-break-before: always !important; visibility: hidden !important; height: 0 !important; margin: 0 !important; padding: 0 !important; }
    .separator-item .print-only { page-break-before: always !important; height: 0; display: block !important; }
}

@media screen {
  .print-only { display: none !important; }
}

/* ------------------ SCREEN STYLES ------------------ */
body { font-family: 'Arial', sans-serif; margin: 0; padding: 20px; max-width: 210mm; margin: auto; font-size: 12pt; background-color: #fff; }
.targetPrice span, .subItemTargetPrice span { width: 90% !important; }
.bold, b { font-weight: bold; } 
i { font-style: italic; }
.zero-text { color: white !important; }
.header { display: flex; align-items: flex-start; justify-content: space-between; gap: 20px; margin-top: 20px; }
.header img { max-width: none; margin-right: 20px; }
.quote-title { font-size: 24px; font-weight: bold; text-align: right; flex-grow: 1; }
.quote-number, .date, .project-number { text-align: right; }
.quote-section { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: flex-start; }
.quote-section strong { display: block; margin-bottom: 2px; }
.quote-section p { margin-top: 2px; }
.swap-button { font-size: 24px; cursor: pointer; margin: 0 20px; user-select: none; }
.quote-item { position: relative; width: 100%; box-sizing: border-box; padding: 5px 0; }
.included-item { 
    position: relative; width: calc(100% - 30px); box-sizing: border-box;
    font-weight: normal; background-color: #fefefe; margin-left: 30px; margin-top: 5px; margin-bottom: 5px; padding: 8px; border-radius: 4px; 
}
.quote-item.hidden-from-print, .included-item.hidden-from-print { opacity: 0.6; border-left: 3px solid #ff9800; padding-left: 5px; }
.included-item.baked-in .subItemTargetPrice span, .quote-item.baked-in .targetPrice span { color: #ccc !important; text-decoration: line-through; }
body.show-baked-item-prices .quote-item.baked-in .targetPrice span,
body.show-baked-subitem-prices .included-item.baked-in .subItemTargetPrice span { color: inherit !important; text-decoration: none; }

.quote-item:hover .item-actions, .included-item:hover .item-actions { display: flex; }
.item-header { display: grid; grid-template-columns: 70px minmax(200px, 1fr) 100px 120px; gap: 10px; font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 10px; margin-top: 20px; align-items: center; }
.item-header > div { padding: 5px; }
.item-meta { display: grid; grid-template-columns: 70px minmax(200px,1fr) 100px 120px; gap: 10px; align-items: center; position: relative; margin: 5px 0; padding-left: 0; }
.included-item .item-meta { background-color: transparent; margin-left: 0; grid-template-columns: 70px minmax(170px,1fr) 100px 120px; padding-left: 0; } 
.item-meta div { display: flex; align-items: center; padding: 5px; justify-content: flex-start; }
.item-number { text-align: left; width: 100%; user-select: text; }
.item-name { text-align: left; padding-right: 10px; word-wrap: break-word; }
.item-name.bold { font-weight: 700; } 
.subitem-name-style { font-weight: 600; } 
.baked-in-icon { margin-left: 8px; cursor: help; }

.targetPrice, .price-header, .subItemTargetPrice { text-align: right; padding-right: 15px; font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; min-width: 80px; white-space: nowrap; position: relative; justify-content: flex-end; }
.quantity, .quantity-header { text-align: center; justify-content: center; font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; min-width: 80px; white-space: nowrap; position: relative; }
.input-container { display: inline-flex; align-items: center; position: relative; }
.button-container { position: absolute; bottom: 100%; right: 0; display: none; flex-direction: row; gap: 1px; }
.input-container:hover .button-container, .input-container.mobile-active .button-container { display: flex; }
.button-container button { width: 20px; height: 20px; font-size: 12px; line-height: 18px; cursor: pointer; border: 1px solid #ccc; background-color: #f8f8f8; border-radius: 3px; display: flex; align-items: center; justify-content: center; }
.button-container button:hover { background-color: #e8e8e8; }
input[type="number"] { width: 60px; padding: 5px; text-align: right; border: none; background-color: transparent; font-size: 12pt; vertical-align: middle; }
input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; display: none; }
input[type="number"] { -moz-appearance: textfield; }
.item-details, .included-item .item-details { margin-top: 5px; font-weight: normal; position: relative; grid-column: 2 / 5; padding-left: 5px; padding-right: 260px; max-width: calc(100% - (70px + 10px + 260px)); word-wrap: break-word; margin-left: calc(70px + 10px); }
.included-item .item-details { margin-left: calc(70px + 10px); max-width: calc(100% - (70px + 10px + 260px)); }
.editable { border: 1px solid transparent; padding: 5px; width: 100%; word-wrap: break-word; }
.editable:hover { border: 1px solid #ddd; background-color: #f9f9f9; }
.editable:focus { outline: 2px solid #007bff; border-radius: 3px; background-color: #fff; }
.p-editable { white-space: pre-wrap; min-height: 1.2em; }
.terms, .footer { margin-top: 20px; }
.footer { text-align: center; }
#fileInput { margin-bottom: 20px; }
.add-button, .remove-button, .add-optional-button, .add-term-button, .footer-button { cursor: pointer; padding: 5px 10px; background-color: green; color: white; border: none; border-radius: 5px; margin: 5px; font-size: 12pt; }
.remove-button { background-color: red; }
.footer-button:hover { background-color: #45a049; }
.remove-icon { display: none; color: white; background-color: red; font-size: 16px; cursor: pointer; position: absolute; right: 10px; top: 10px; width: 20px; height: 20px; border-radius: 10px; text-align: center; line-height: 18px; }
.term-item:hover .remove-icon { display: block; }
.status-message { margin-top: 10px; font-weight: bold; color: green; font-size: 12pt; }
.total-price { text-align: right; font-weight: bold; margin-top: 20px; font-size: 12pt; padding-right: 15px; margin-right: 0; border-top: 2px solid #000; padding-top: 10px; font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; width: 100%; position: relative; }
.term-item { position: relative; padding-left: 30px; min-height: 30px; display: flex; align-items: center; margin-bottom: 1px; }
.term-item:hover { background-color: #fafafa; }
.term-item .controls-row { display: none; position:absolute; left:2px; top: 50%; transform: translateY(-50%); flex-direction:column; gap: 2px; }
.term-item:hover .controls-row { display: inline-flex; }
.term-item .content-wrapper { width: 100%; }
.term-item .editable { width: 100% !important; }
.reference { margin: 20px 0; }
.currency-multiplier { margin-top: 20px; margin-bottom: 20px; text-align: right; }
.currency-multiplier label { font-weight: bold; }
.currency-multiplier input { width: 60px; padding: 5px; font-size: 12pt; text-align: right; }
#multipleCurrencyRatesDiv input { width: 80px; }
#multipleCurrencyRatesDiv div { margin-bottom: 5px;}
.description-remove-icon { display: none; color: white; background-color: red; font-size: 16px; cursor: pointer; width: 20px; height: 20px; border-radius: 10px; text-align: center; line-height: 18px; position: absolute; right: 10px; top: 10px; }
.item-details:hover .description-remove-icon, .included-item:hover .description-remove-icon { display: block; }
.checkbox-group { display: flex; gap: 20px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
#optionalItemsList { margin-top: 0; padding-top: 0; }
#termsList { margin-top: 0px; padding-top: 10px;}
h3.name.editable { margin-bottom: 0 !important; }

/* --- INFO IMAGES LAYOUT --- */
.info-images { margin: 20px 0; }
#infoImagesList {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    gap: 10px;
}
.info-block { position: relative; min-height: 30px; box-sizing: border-box; }

/* Text blocks take full width by default */
.info-block-fullwidth { width: 100%; flex-basis: 100%; padding-left: 30px; }

/* Image blocks */
.info-block-image {
    margin: 0;
    padding-left: 0;
}

/* Alignment Classes - WYSIWYG */
.info-block.align-center {
    flex-basis: 100%;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.info-block.align-left {
    flex-basis: auto;
    width: auto;
    display: inline-flex;
    flex-direction: column;
    align-items: flex-start;
    text-align: left;
}

.info-block:hover { background-color: #fafafa; }
.info-block .content-wrapper { position: relative; width: 100%; } 

#infoImagesList .info-block-image .info-image-container {
    display: block; line-height: 0; margin: 0; position: relative;
}
#infoImagesList .info-block-image .info-image-container img {
    display: block; max-width: 100%; width: auto; height: auto; object-fit: cover; border:1px solid transparent;
}
#infoImagesList .info-block-image:hover .info-image-container img { border:1px solid #ddd; }

.info-text-block { min-height: 30px; padding: 5px; border: 1px solid transparent; }
.info-text-block:hover { background-color: #f9f9f9; border: 1px solid #ddd; }
.image-resize-handle {
    width: 20px; height: 20px; background-color: rgba(255,255,255,0.8); border: 2px solid #007bff;
    border-radius: 50%; position: absolute; bottom: 5px; right: 5px;
    cursor: se-resize; z-index: 15; pointer-events: all; display:none;
}
.info-image-container:hover .image-resize-handle, #logoContainer:hover .image-resize-handle { display: block; }

.controls-row { display: none; align-items: center; gap: 5px; z-index: 10; background: rgba(230,230,230,0.85); padding:3px; border-radius: 3px; border:1px solid #ccc; }
.info-block:hover .controls-row { display: inline-flex; }

#infoImagesList .info-block-image .controls-row { position: absolute; top: 5px; right: 5px; flex-direction: row; }
#infoImagesList .info-block-fullwidth .controls-row { position:absolute; left:2px; top: 50%; transform: translateY(-50%); flex-direction:column; }

.controls-row .control-btn { cursor: pointer; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; font-size: 14px; }
.controls-row .control-btn:hover { background-color: #e0e0e0; border-color: #999; }
.controls-row .remove-icon { position: static; display: inline-flex; align-items:center; justify-content:center; width: 20px; height: 20px; font-size: 14px; line-height: 20px; }
.info-block:hover .controls-row .remove-icon { display: inline-flex; } 

.drag-handle { background-color: #333; color: white; border-radius: 50%; text-align: center; line-height: 18px; cursor: move; width:20px; height:20px; display:inline-flex; align-items:center; justify-content:center; user-select:none;}
.info-image-up, .info-image-down { border-radius: 50%; text-align: center; line-height: 18px; cursor: pointer; font-size: 16px; background-color: #f0f0f0; width:20px; height:20px; display:inline-flex; align-items:center; justify-content:center; border: 1px solid #ccc;}
.info-image-up:hover, .info-image-down:hover { background-color: #e0e0e0; }

#mainItemsSectionContainer, #optionalSectionContainer, #infoSectionContainer, #termsSectionContainer { position: relative; }
.section-remove-icon { display: none; position: absolute; left:10px; top:5px; background-color:red; width:20px; height:20px; border-radius:10px; text-align:center; line-height:18px; color:white; cursor:pointer; font-size:16px; z-index:100; }
#mainItemsSectionContainer:hover .section-remove-icon, #optionalSectionContainer:hover .section-remove-icon, #infoSectionContainer:hover .section-remove-icon, #termsSectionContainer:hover .section-remove-icon { display: block; }
.horizontal-line { border: none; border-top: 2px solid black; margin: 5px 0; width: 100%; }
.info-table { width: 100%; border-collapse: collapse; background-color: white; margin-top: 10px; }
.info-table td { border: 1px solid #ccc; padding: 8px; min-width: 50px; position: relative; }
.info-table td[contenteditable="true"]:hover { background-color: #f9f9f9; }
.info-table td[contenteditable="true"]:focus { outline: 2px solid #007bff; background-color: #fff; }
.image-upload-button { background-color: green; color: white; padding: 5px 10px; border: none; border-radius: 5px; margin: 5px; font-size: 12pt; cursor: pointer; }
.image-upload-button:hover { background-color: #45a049; }
#reduceImageFileSizesBtn { background-color: #3b82f6; }
#reduceImageFileSizesBtn:hover { background-color: #2563eb; }
#liveCurrencyRates { font-size: 12px !important; }

.item-meta .item-tooltip { display: none; position: absolute; top: -18px; right: 5px; background: rgba(255, 255, 255, 0.95); border-radius: 4px; padding: 2px 5px; font-size: 11px; display: flex; gap: 8px; align-items: center; z-index: 10; border: 1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.item-meta:hover .item-tooltip { display: flex; }
.item-tooltip .original-price-display, .item-tooltip .margin-display { white-space: nowrap; border: 1px solid transparent; border-radius: 3px; padding: 1px 3px; min-width: 40px; text-align: right; }
.item-tooltip .original-price-display { color: blue; }
.item-tooltip .margin-display { color: green; font-weight: bold; }
.item-tooltip .margin-display.discount { color: #b78a00; }
.item-tooltip .editable:hover { border-color: #ccc; background-color: #f9f9f9; }
.item-tooltip .editable:focus { border-color: #007bff; background-color: white; box-shadow: 0 0 0 1px #007bff; }
.item-actions { display: none; position: absolute; right: -285px; top: 50%; transform: translateY(-50%); flex-direction: row; gap: 4px; z-index: 10; }
.item-actions .control-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight:bold; }
.item-actions .control-btn:hover { background-color: #e0e0e0; border-color: #999; }
.control-btn[id^="immuneBtn_"] { cursor: pointer; user-select: none; }
#formatting-toolbar { position: absolute; display: none; z-index: 1000; background: #333; border-radius: 5px; padding: 5px; }
#formatting-toolbar button { background: #444; color: white; border: 1px solid #555; border-radius: 3px; padding: 5px 10px; cursor: pointer; font-size: 14px; }
#formatting-toolbar button.active { background: #007bff; border-color: #0056b3; }
#formatting-toolbar button:hover { background: #555; }
#signatureSection { display: none; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; }
.signature-date { margin-bottom: 40px; }
.signature-row { display: flex; justify-content: space-between; text-align: center; }
.signature-block { width: 40%; position: relative; }
.signature-line { border-bottom: 1px solid black; min-height: 40px; margin-bottom: 5px; }
#sectionVisibilityControls { border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; }

/* Logo specific styles */
#logoContainer { position: relative; display: inline-block; line-height: 0; flex-shrink: 0; }
#logoContainer .remove-icon { top: -10px; right: -10px; z-index: 20; width: 24px; height: 24px; line-height: 24px; font-size: 14px; }
#logoContainer:hover .remove-icon { display: block; }
#logoContainer:hover #resetLogoSizeBtn { display: inline-block; }
#uploadLogoBtn { padding: 10px; background-color: #f0f0f0; border: 2px dashed #ccc; cursor: pointer; }
#uploadLogoBtn:hover { background-color: #e9e9e9; }
#resetLogoSizeBtn { display: none; position: absolute; top: -10px; right: 20px; z-index: 20; padding: 2px 6px; font-size: 10px; cursor: pointer; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; }

.vendor-price-details, .vendor-item-notes { display: none; font-size: 9pt; color: #333; background-color: #fdfdfd; border: 1px solid #e1e1e8; border-radius: 4px; margin-top: 5px; padding: 8px; margin-left: calc(70px + 10px); grid-column: 2 / 5; }
.included-item .vendor-price-details, .included-item .vendor-item-notes { margin-left: 0; }
body.vendor-print-mode .vendor-price-details, body.vendor-print-mode .vendor-item-notes { display: block !important; }
.vendor-price-details div { margin-bottom: 3px; }
.vendor-price-details i { font-style: italic; color: #666; }
.vendor-price-details b { font-weight: bold; color: #000; }
.vendor-item-notes { background-color: #fefee9; min-height: 20px; white-space: pre-wrap; }
.info-tooltip-icon { display: inline-block; position: relative; cursor: help; margin-left: 5px; font-weight: bold; color: #007bff; }
.info-tooltip-icon .info-tooltip-text { visibility: hidden; width: 250px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s; font-size: 10pt; font-weight: normal; }
.info-tooltip-icon:hover .info-tooltip-text { visibility: visible; opacity: 1; }
#compressionStatus { font-size: 10pt; margin-top: 10px; padding: 8px; background-color: #f0f8ff; border: 1px solid #b0c4de; border-radius: 4px; }

/* Cropper Modal */
.modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
.modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 5px; }
.cropper-container-wrapper { max-height: 60vh; overflow: hidden; margin-bottom: 15px; }
.modal-footer { text-align: right; }
.modal-footer button { padding: 8px 16px; margin-left: 10px; cursor: pointer; border: none; border-radius: 4px; font-size: 14px; }
.btn-save { background-color: #28a745; color: white; }
.btn-cancel { background-color: #dc3545; color: white; }

/* Vendor Mode Tooltip */
.vendor-mode-tooltip {
    position: relative;
    display: inline-block;
    margin-left: 5px;
    cursor: help;
    color: #007bff;
    font-weight: bold;
}
.vendor-mode-tooltip .tooltip-text {
    visibility: hidden;
    width: 300px;
    background-color: #333;
    color: #fff;
    text-align: left;
    border-radius: 6px;
    padding: 10px;
    position: absolute;
    z-index: 100;
    bottom: 125%;
    left: 50%;
    margin-left: -150px;
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 9pt;
    font-weight: normal;
    line-height: 1.4;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
.vendor-mode-tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }

</style>
</head>
<body class="">

<div id="formatting-toolbar" class="screen-only">
  <button id="bold-btn" title="Fet (Ctrl+B)"><b>B</b></button>
  <button id="italic-btn" title="Kursiv (Ctrl+I)"><i>I</i></button>
  <button id="bullet-btn" title="Punktlista">•</button>
  <button id="dash-btn" title="Strecklista">-</button>
  <button id="ul-btn" title="Punktlista (HTML)">&#x2022; List</button>
  <button id="ol-btn" title="Numrerad lista (HTML)">1. List</button>
</div>

<!-- Cropper Modal -->
<div id="cropperModal" class="modal screen-only">
    <div class="modal-content">
        <h3>Beskär Bild</h3>
        <div class="cropper-container-wrapper">
            <img id="imageToCrop" src="" style="max-width: 100%;">
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeCropperModal()">Avbryt</button>
            <button class="btn-save" onclick="saveCroppedImage()">Spara</button>
        </div>
    </div>
</div>

<div id="quoteContent">
    <div class="header">
        <div id="logoContainer">
            <img alt="Company Logo" id="companyLogo" src="logo.png"/>
            <span class="remove-icon screen-only" id="removeLogoBtn">✖</span>
            <button id="resetLogoSizeBtn" class="screen-only">Reset Size</button>
            <div class="image-resize-handle screen-only"></div>
        </div>
        <button id="uploadLogoBtn" class="screen-only" style="display:none;">Ladda upp logotyp</button>
        <input type="file" id="logoUpload" accept="image/*" style="display:none;" />

        <div class="quote-title editable" contenteditable="true" id="quoteTitle" data-field="quoteTitle">Offert</div>
    </div>
    <div class="quote-number" id="quoteNumberLabel">Offert nr:
        <span class="editable" contenteditable="true" id="quoteNumber"></span>
    </div>
    <div class="date" id="dateLabel">Datum:
        <span class="editable" contenteditable="true" id="quoteDate"></span>
    </div>
    <div class="project-number screen-only" id="projectNumberDiv" style="display:none;">
        Projekt Nummer:
        <span class="editable" contenteditable="true" id="projectNumber"></span>
    </div>

    <div class="checkbox-group screen-only">
        <label><input type="checkbox" id="showProjectNumber" /> Visa Projekt Nummer</label>
        <label><input type="checkbox" id="showDecimals" /> Visa decimaler</label>
        <div id="compressionOptionsWrapper" style="display: inline-flex; align-items: center; gap: 5px;">
             <label><input type="checkbox" id="compressImagesChk" checked /> Komprimera bilder</label>
             <div id="compressionOptions" style="display: inline-flex; align-items: center; gap: 5px;">
                <label for="compressionQuality" style="font-size: 10pt;">Kvalitet:</label>
                <input type="number" id="compressionQuality" value="0.7" min="0.1" max="1.0" step="0.1" style="width: 50px; font-size: 10pt; padding: 2px;">
                <label for="compressionMaxWidth" style="font-size: 10pt;">Max bredd:</label>
                <input type="number" id="compressionMaxWidth" value="1280" min="100" step="100" style="width: 60px; font-size: 10pt; padding: 2px;">
             </div>
             <label for="defaultLogoWidthInput" id="defaultLogoWidthLabel" style="margin-left: 10px;">Standard logobredd (px):</label>
             <input type="number" id="defaultLogoWidthInput" value="200" step="10" />
        </div>
    </div>
     <div class="checkbox-group screen-only">
        <label id="removeTotalCheckboxLabel">
            <input type="checkbox" id="removeTotalCheck" /> Ta bort totalen
        </label>
        <label id="addSignatureCheckboxLabel">
            <input type="checkbox" id="addSignatureCheck" /> Lägg till signatur
        </label>
        <label id="toggleTillLabel">
            <input type="checkbox" id="toggleTillSectionChk" checked /> Visa 'Till'
        </label>
        <label><input type="checkbox" id="showBakedItemPrices" /> Visa inbakade artikelpriser</label>
        <label><input type="checkbox" id="showBakedSubItemPrices" /> Visa inbakade underpostpriser</label>
        <label>
            <input type="checkbox" id="vendorModeCheck" /> Vendor-läge (utskrift)
            <span class="vendor-mode-tooltip">?
                <span class="tooltip-text">
                    <b>Vendor-läge:</b> Visar detaljerade beräkningar på utskriften.<br><br>
                    <b>Påslag (Markup):</b> Pris = Kostnad * (1 + %).<br>
                    <i>Ex: 100kr * 1.20 = 120kr (20% påslag)</i><br><br>
                    <b>Marginal (Margin):</b> Pris = Kostnad / (1 - %).<br>
                    <i>Ex: 100kr / 0.80 = 125kr (20% marginal)</i>
                </span>
            </span>
        </label>
    </div>
    <div id="sectionVisibilityControls" class="checkbox-group screen-only">
        <span id="showSectionsLabel">Visa sektioner:</span>
        <label><input type="checkbox" id="showOptionalSectionChk" data-section="optional" /><span id="showOptionalLabel">Alternativ</span></label>
        <label><input type="checkbox" id="showInfoSectionChk" data-section="info" /><span id="showInfoLabel">Info/Bilder</span></label>
        <label><input type="checkbox" id="showTermsSectionChk" data-section="terms" /><span id="showTermsLabel">Villkor</span></label>
    </div>
    <div class="currency-multiplier screen-only" style="position: relative;">
        <div id="liveCurrencyRates" style="display:inline-block; margin-right:10px; font-size: 10px;"></div>
        <div id="singleCurrencyMultiplierDiv">
            <label for="currencyMultiplierInput">Valutakurs:</label>
            <input type="number" id="currencyMultiplierInput" value="11.8" step="0.01" />
        </div>
        <label for="marginPercentageInput" id="marginLabel" style="margin-left: 10px;">Påslag (%):</label>
        <input type="number" id="marginPercentageInput" value="0" step="1" />
        <label style="font-size: 10pt; margin-left: 5px; user-select: none;">
            <input type="checkbox" id="marginModeChk" />
            <span id="marginModeLabel">Beräkna som marginal</span>
        </label>

        <label style="display:block; margin-top:10px;">
            <input type="checkbox" id="useMultipleCurrenciesChk" />
            <span id="useMultipleCurrenciesLabel">Använd multipla valutakurser</span>
        </label>
        <div id="multipleCurrencyRatesDiv" style="display:none; margin-top:5px; text-align:left; padding-left:20px;">
            <div>
                <label for="usdRateInput" id="usdRateLabel">USD-SEK Kurs:</label>
                <input type="number" id="usdRateInput" step="0.01" />
            </div>
            <div>
                <label for="eurRateInput" id="eurRateLabel">EUR-SEK Kurs:</label>
                <input type="number" id="eurRateInput" step="0.01" />
            </div>
        </div>
    </div>


    <div class="screen-only" style="text-align:right; margin-bottom:20px;">
        <button id="toggleLanguageBtn">Byt Språk (SV/EN)</button>
        <label style="margin-left:15px;">
            <input type="checkbox" id="useCustomCurrencyChk" />
            <span id="customCurrencyLabel">Använd egen valuta</span>
        </label>
        <input type="text" id="customCurrencyInput" value="EUR" style="width:80px; display:none; margin-left:10px;"/>
    </div>

    <div class="quote-section" id="quoteSection">
        <div id="companyA_wrapper"><strong id="toLabel">Till:</strong><p class="editable p-editable" contenteditable="true" id="companyA"></p></div>
        <div class="swap-button screen-only" id="swapButton"><-></div>
        <div><strong id="fromLabel">Från:</strong><p class="editable p-editable" contenteditable="true" id="companyB"></p></div>
    </div>

    <div class="reference"><strong id="refLabel">Ref:</strong><span class="editable" contenteditable="true" id="reference"></span></div>

    <div id="mainItemsSectionContainer">
        <span class="section-remove-icon screen-only" onclick="removeMainSection()">✖</span>
        <div class="item-header">
            <div id="nrHeader" class="editable" contenteditable="true" data-field="nrHeader">Nr</div>
            <div id="articleNameHeader" class="editable" contenteditable="true" data-field="articleNameHeader">Artikel / Namn</div>
            <div id="quantityHeader" class="quantity-header editable" contenteditable="true" data-field="quantityHeader">Antal</div>
            <div id="priceHeader" class="price-header editable" contenteditable="true" data-field="priceHeader">Pris (SEK)</div>
        </div>
        <div id="itemsList"></div>
        <div class="total-price" id="totalPrice"><span id="totalLabel" class="editable" contenteditable="true" data-field="totalLabel">Total:</span><span id="totalValue">0 SEK</span></div>
        <button class="add-button screen-only" id="addItemButton">+ Lägg till ny artikel</button>
        <button class="add-button screen-only" id="addSeparatorButton">+ Lägg till separator</button>
    </div>

    <div id="optionalSectionContainer">
        <h3 id="optionalItemsHeading" class="name editable" contenteditable="true" data-field="optionalItemsHeading">Alternativ / Ytterligare Artiklar</h3>
        <span class="section-remove-icon screen-only" onclick="hideOptionalSection()">✖</span>
        <div class="item-header">
            <div id="optNrHeader" class="editable" contenteditable="true" data-field="optNrHeader">Nr</div>
            <div id="optArticleHeader" class="editable" contenteditable="true" data-field="optArticleHeader">Artikel / Namn</div>
            <div id="optQuantityHeader" class="quantity-header editable" contenteditable="true" data-field="optQuantityHeader">Antal</div>
            <div id="optPriceHeader" class="price-header editable" contenteditable="true" data-field="optPriceHeader">Pris (SEK)</div>
        </div>
        <div id="optionalItemsList"></div>
        <button class="add-optional-button screen-only" id="addOptionalItemButton">+ Lägg till ny artikel</button>
        <button class="add-optional-button screen-only" id="addOptionalSeparatorButton">+ Lägg till separator</button>
    </div>

    <div id="infoSectionContainer">
        <h3 id="infoImagesHeading" class="name editable" contenteditable="true" data-field="infoImagesHeading">Info / Bilder</h3>
        <hr class="horizontal-line" /><span class="section-remove-icon screen-only" onclick="hideInfoSection()">✖</span>
        <div id="infoImagesList"></div>
        <div class="image-upload-container screen-only">
            <input type="file" id="imageUpload" accept="image/*" multiple style="display:none;" />
            <button class="image-upload-button" onclick="document.getElementById('imageUpload').click()">Lägg till bild (fil)</button>
            <button class="image-upload-button" onclick="autoLayoutImages()">Smart Layout (Auto)</button>
            <button class="image-upload-button" onclick="recompressAllImages()">Komprimera om bilder</button>
            <span class="info-tooltip-icon">ⓘ<span class="info-tooltip-text" id="recompressTooltipText"></span></span>
            <button class="image-upload-button" id="reduceImageFileSizesBtn" onclick="reduceImageFileSizes()">Minska filstorlek (kvalitet)</button>
            <span class="info-tooltip-icon">ⓘ<span class="info-tooltip-text" id="reduceSizeTooltipText"></span></span>
            <button class="image-upload-button" style="display:none;" onclick="addImageFromUrl()">Lägg till bild (URL)</button>
            <button class="image-upload-button" onclick="addInfoText()">Lägg till text</button>
            <button class="image-upload-button" onclick="addTable()">Lägg till tabell</button>
            <button class="image-upload-button" onclick="addPageBreak()">Lägg till sidbrytning</button>
            <div id="compressionStatus" class="screen-only" style="display: none;"></div>
        </div>
    </div>

    <div id="termsSectionContainer">
        <h3 id="termsHeading" class="name editable" contenteditable="true" data-field="termsHeading">Villkor</h3>
        <span class="section-remove-icon screen-only" onclick="hideTermsSection()">✖</span>
        <hr class="horizontal-line" />
        <div id="termsList"></div>
        <button class="add-term-button screen-only" id="addTermButton">+ Lägg till villkor</button>
    </div>

    <div id="signatureSection">
        <div class="signature-date">
            <span id="signatureDateLabel">Datum</span>:
            <span class="editable" contenteditable="true" id="signatureDate" style="border-bottom: 1px solid black; padding: 0 10px;">                    </span>
        </div>
        <div id="signatureBlocksContainer" class="signature-row">
            <div class="signature-block info-block">
                 <div class="controls-row screen-only" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%);">
                    <span class="drag-handle">≡</span>
                    <span class="remove-icon" onclick="removeSignatureBlock(0)">✖</span>
                </div>
                <div class="signature-line editable" contenteditable="true" data-field="signatureLessorLine"></div>
                <div id="signatureLessorLabel" class="editable" contenteditable="true" data-field="signatureLessorText">Uthyrare</div>
            </div>
            <div class="signature-block info-block">
                 <div class="controls-row screen-only" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%);">
                    <span class="drag-handle">≡</span>
                    <span class="remove-icon" onclick="removeSignatureBlock(1)">✖</span>
                </div>
                <div class="signature-line editable" contenteditable="true" data-field="signatureLesseeLine"></div>
                <div id="signatureLesseeLabel" class="editable" contenteditable="true" data-field="signatureLesseeText">Hyrestagare</div>
            </div>
        </div>
    </div>

<div id="printMultiplier" class="print-only"><span id="multiplierValue"></span></div>

</div>

<div class="footer screen-only">
    <input type="file" id="fileInput" accept=".json" style="display: none;" />
    <button class="footer-button" onclick="document.getElementById('fileInput').click()">Ladda JSON</button>
    <button id="saveJson" class="footer-button">Spara JSON</button>
    <button id="copyJsonBtn" class="footer-button">Kopiera JSON (text)</button>
    <button class="footer-button" id="uploadPdfBtn">Ladda PDF-offert</button>
    <input type="file" id="pdfUploadInput" accept=".pdf" style="display:none;" />
    <div class="screen-only" style="margin-top: 10px; text-align: center;">
        <label for="pdfFileNameInput" id="pdfFileNameLabel">PDF Filnamn:</label>
        <input type="text" id="pdfFileNameInput" size="60" style="padding: 5px;"/>
    </div>
    <button class="footer-button" id="savePdfBtn">Spara som PDF</button>
    <button id="printBtn" class="footer-button">Print</button>
    <br>
    <button id="saveJsonUnencrypted" class="footer-button" style="background-color: #f0ad4e;">Spara JSON (okrypterad)</button>
    <button id="saveJsonUnencryptedNoImg" class="footer-button" style="background-color: #f0ad4e;">Spara JSON (okrypterad, utan bilder)</button>
    <div id="dateWarningContainer" style="margin-top: 10px; color: red; font-weight: bold; display: none;">
        <span id="dateWarningText"></span>
        <button id="updateDateBtn" class="footer-button" style="margin-left: 10px; background-color: #5bc0de;">Uppdatera datum</button>
    </div>
    <div class="status-message" id="statusMessage"></div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
</script>

<script>
const translations = {
  sv: {
    quoteTitle: "Offert", quoteNumberLabel: "Offert nr:", dateLabel: "Datum:", projectNumberLabel: "Projekt Nummer:",
    toLabel: "Till:", fromLabel: "Från:", refLabel: "Ref:", nrHeader: "Nr", articleNameHeader: "Artikel / Namn",
    quantityHeader: "Antal", priceHeader: "Pris", addItemButton: "+ Lägg till ny artikel",
    optionalItemsHeading: "Alternativ / Ytterligare Artiklar", infoImagesHeading: "Info / Bilder",
    termsHeading: "Villkor", addOptionalItemButton: "+ Lägg till ny artikel", addTermButton: "+ Lägg till villkor",
    customCurrencyLabelText: "Använd egen valuta", toggleLangBtn: "Byt Språk (SV/EN)", newTermText: "<b>Nytt villkor:</b> Klicka för att redigera",
    newArticleName: "Artikel Namn", newAltArticleName: "Alternativ Artikel Namn", newDescription: "Beskrivning",
    newOptionalItemDescription: "Standardbeskrivning för alternativ artikel", 
    newSubItemName: "Underpost Namn", 
    newSubItemDescription: "Standardbeskrivning för underpost", 
    newInfoText: "Klicka för att redigera text", promptImageUrl: "Ange bildens URL:", removeTotalLabelText: "Ta bort totalen",
    addSignatureLabelText: "Lägg till signatur",
    hideTillSectionLabelText: "Visa 'Till'", bakeInPriceLabel: "Baka in pris i andra artiklar",
    bakedInPriceTooltip: "Priset för denna artikel har fördelats på andra artiklar.",
    signatureDateLabel: "Datum", signatureLessorLabel: "Uthyrare", signatureLesseeLabel: "Hyrestagare",
    totalLabel: "Total:", marginLabel: "Påslag (%):", copyJsonBtn: "Kopiera JSON (text)",
    statusJsonCopied: "Status: JSON kopierad till urklipp!",
    statusRecompressing: "Komprimerar om bilder...", statusRecompressDone: "Alla bilder har komprimerats om.",
    statusFileSizeReducing: "Minskar filstorlek...", statusFileSizeReduceDone: "Filstorlekar har minskats.",
    duplicateItem: "Duplicera rad", removeRow: "Ta bort rad",
    moveUp: "Flytta upp", moveDown: "Flytta ner",
    useMultipleCurrenciesLabelText: "Använd multipla valutakurser",
    usdRateLabelText: "USD-SEK Kurs:", eurRateLabelText: "EUR-SEK Kurs:",
    editItemNumberPrompt: "Ange nytt artikelnummer:",
    addSubItem: "Lägg till underpost", 
    removeAllSubItems: "Ta bort alla underposter",
    showSectionsLabel: "Visa sektioner:", showOptionalLabel: "Alternativ", showInfoLabel: "Info/Bilder", showTermsLabel: "Villkor",
    optNrHeader: "Nr", optArticleHeader: "Artikel / Namn", optQuantityHeader: "Antal", optPriceHeader: "Pris",
    hideFromPrint: "Göm från utskrift",
    vendorNotesHeading: "Vendoranteckningar",
    defaultLogoWidthLabel: "Standard logobredd (px):",
    resetLogoSize: "Återställ storlek",
    addPageBreak: "Lägg till sidbrytning",
    reduceImageFileSizes: "Minska filstorlek (kvalitet)",
    toggleCompressionImmune: "Skydda från komprimering",
    pdfFileNameLabel: "PDF Filnamn:",
    addSeparator: "+ Lägg till separator",
    downloadImage: "Ladda ner bild",
    recompressTooltipText: "Komprimerar om alla icke-skyddade bilder till den angivna kvaliteten och maxbredden. Bra för att standardisera bilder.",
    reduceSizeTooltipText: "Minskar filstorleken för alla icke-skyddade bilder genom att sänka deras JPEG-kvalitet med 10%. Kan användas flera gånger. Visuell storlek ändras ej.",
    marginModeLabelText: "Beräkna som marginal",
    markupLabel: "Påslag (%)",
    marginLabel: "Marginal (%)",
    cropImage: "Beskär bild",
  },
  en: {
    quoteTitle: "Quote", quoteNumberLabel: "Quote No:", dateLabel: "Date:", projectNumberLabel: "Project Number:",
    toLabel: "To:", fromLabel: "From:", refLabel: "Ref:", nrHeader: "No", articleNameHeader: "Article / Name",
    quantityHeader: "Quantity", priceHeader: "Price", addItemButton: "+ Add new item",
    optionalItemsHeading: "Alternative / Additional Items", infoImagesHeading: "Info / Images",
    termsHeading: "Terms", addOptionalItemButton: "+ Add new item", addTermButton: "+ Add a term",
    customCurrencyLabelText: "Use custom currency", toggleLangBtn: "Toggle Language (SV/EN)", newTermText: "<b>New term:</b> Click to edit",
    newArticleName: "Article Name", newAltArticleName: "Alternative Article Name", newDescription: "Description",
    newOptionalItemDescription: "Default description for optional item", 
    newSubItemName: "Sub Item Name", 
    newSubItemDescription: "Default description for sub item", 
    newInfoText: "Click to edit text", promptImageUrl: "Enter image URL:", removeTotalLabelText: "Remove total",
    addSignatureLabelText: "Add signature",
    hideTillSectionLabelText: "Show 'To'", bakeInPriceLabel: "Bake price into other items",
    bakedInPriceTooltip: "The price for this item has been distributed to other items.",
    signatureDateLabel: "Date", signatureLessorLabel: "Lessor", signatureLesseeLabel: "Lessee",
    totalLabel: "Total:", marginLabel: "Margin (%):", copyJsonBtn: "Copy JSON (text)",
    statusJsonCopied: "Status: JSON copied to clipboard!",
    statusRecompressing: "Re-compressing images...", statusRecompressDone: "All images have been re-compressed.",
    statusFileSizeReducing: "Reducing file sizes...", statusFileSizeReduceDone: "File sizes have been reduced.",
    duplicateItem: "Duplicate item", removeRow: "Remove row",
    moveUp: "Move up", moveDown: "Move down",
    useMultipleCurrenciesLabelText: "Use multiple currency rates",
    usdRateLabelText: "USD-SEK Rate:", eurRateLabelText: "EUR-SEK Rate:",
    editItemNumberPrompt: "Enter new item number:",
    addSubItem: "Add Sub Item", 
    removeAllSubItems: "Remove All Sub Items",
    showSectionsLabel: "Show sections:", showOptionalLabel: "Optional", showInfoLabel: "Info/Images", showTermsLabel: "Terms",
    optNrHeader: "No", optArticleHeader: "Article / Name", optQuantityHeader: "Quantity", optPriceHeader: "Price",
    hideFromPrint: "Hide from print",
    vendorNotesHeading: "Vendor Notes",
    defaultLogoWidthLabel: "Default Logo Width (px):",
    resetLogoSize: "Reset Size",
    addPageBreak: "Add Page Break",
    reduceImageFileSizes: "Reduce file size (quality)",
    toggleCompressionImmune: "Immune from compression",
    pdfFileNameLabel: "PDF Filename:",
    addSeparator: "+ Add Separator",
    downloadImage: "Download image",
    recompressTooltipText: "Re-compresses all non-immune images to the specified quality and max width. Good for standardizing images.",
    reduceSizeTooltipText: "Reduces the file size for all non-immune images by lowering their JPEG quality by 10%. Can be used multiple times. Visual size does not change.",
    marginModeLabelText: "Calculate as margin",
    markupLabel: "Markup (%)",
    marginLabel: "Margin (%)",
    cropImage: "Crop image",
  }
};

let currentLanguage = "sv"; 
let jsonData = null;
let currentFileName = null; 
window.liveExchangeRates = { usd: null, eur: null };
const caesarShift = 17;
let cropper = null;
let currentCropIndex = -1;

function encryptCaesar(text, shift) {
    return text.split('').map(char => {
        const code = char.charCodeAt(0);
        return String.fromCharCode(code + shift);
    }).join('');
}

function decryptCaesar(text, shift) {
    return text.split('').map(char => {
        const code = char.charCodeAt(0);
        return String.fromCharCode(code - shift);
    }).join('');
}

(function initData(){
    let localData = localStorage.getItem('quoteData');
    if(localData){
        try {
            jsonData = JSON.parse(localData);
        } catch (e) {
            try {
                jsonData = JSON.parse(decryptCaesar(localData, caesarShift));
            } catch (e2) {
                console.error("Failed to parse or decrypt local storage data.", e2);
                localData = null; 
            }
        }
    }

    if(!localData){
        jsonData={ quote:{ currencyMultiplicator: 11.8, marginPercentage: 0, useMultipleCurrencies: false, usdToSekRate: 10.50, eurToSekRate: 11.50, showSignature: false, showTillSection: true, removeTotal: false, labels: {}, visibility: { optional: true, info: true, terms: true }, defaultLogoWidth: 200, useCustomCurrency: false, customCurrency: 'EUR', centerImagesByDefault: true, marginCalculationMode: 'markup' }, companyA:{}, companyB:{}, items:[], optionalItems:[], terms:[], infoImages:[], signature: { date: "", lessorLine: "", lesseeLine: "", lessorText: translations.sv.signatureLessorLabel, lesseeText: translations.sv.signatureLesseeLabel } };
    } else {
        if(!jsonData.quote)jsonData.quote={currencyMultiplicator:11.8, marginPercentage: 0, useMultipleCurrencies: false, usdToSekRate: 10.50, eurToSekRate: 11.50, showSignature: false, showTillSection: true, removeTotal: false, labels: {}, visibility: { optional: true, info: true, terms: true }, defaultLogoWidth: 200, useCustomCurrency: false, customCurrency: 'EUR', centerImagesByDefault: true, marginCalculationMode: 'markup' };
        if(jsonData.quote.marginPercentage === undefined) jsonData.quote.marginPercentage = 0;
        if(jsonData.quote.currencyMultiplicator === undefined) jsonData.quote.currencyMultiplicator = 11.8;
        if(jsonData.quote.useMultipleCurrencies === undefined) jsonData.quote.useMultipleCurrencies = false;
        if(jsonData.quote.usdToSekRate === undefined) jsonData.quote.usdToSekRate = 10.50;
        if(jsonData.quote.eurToSekRate === undefined) jsonData.quote.eurToSekRate = 11.50;
        if(jsonData.quote.showSignature === undefined) jsonData.quote.showSignature = false;
        if(jsonData.quote.showTillSection === undefined) jsonData.quote.showTillSection = true;
        if(jsonData.quote.removeTotal === undefined) jsonData.quote.removeTotal = false;
        if(jsonData.quote.defaultLogoWidth === undefined) jsonData.quote.defaultLogoWidth = 200;
        if(jsonData.quote.useCustomCurrency === undefined) jsonData.quote.useCustomCurrency = false;
        if(jsonData.quote.customCurrency === undefined) jsonData.quote.customCurrency = 'EUR';
        if(jsonData.quote.centerImagesByDefault === undefined) jsonData.quote.centerImagesByDefault = true;
        if(jsonData.quote.marginCalculationMode === undefined) jsonData.quote.marginCalculationMode = 'markup';
        if(!jsonData.quote.labels) jsonData.quote.labels = {};
        if (jsonData.quote.totalLabel) { 
            jsonData.quote.labels.totalLabel = jsonData.quote.totalLabel;
            delete jsonData.quote.totalLabel;
        }
        if (!jsonData.quote.visibility) {
            jsonData.quote.visibility = { optional: true, info: true, terms: true };
        }
        if(!jsonData.companyA)jsonData.companyA={}; if(!jsonData.companyB)jsonData.companyB={};
        if(!Array.isArray(jsonData.items))jsonData.items=[]; 
        jsonData.items.forEach(it => { 
            if(it.isPriceBakedIn === undefined) it.isPriceBakedIn = false; 
            if(it.isHiddenFromPrint === undefined) it.isHiddenFromPrint = false;
            if(it.vendorNotes === undefined) it.vendorNotes = "";
            if(it.type === undefined && it.name !== undefined) it.type = 'item';
            (it.subItems || []).forEach(sIt => { 
                if(sIt.isPriceBakedIn === undefined) sIt.isPriceBakedIn = false; 
                if(sIt.isHiddenFromPrint === undefined) sIt.isHiddenFromPrint = false;
                if(sIt.vendorNotes === undefined) sIt.vendorNotes = "";
            });
        });
        if(!Array.isArray(jsonData.optionalItems))jsonData.optionalItems=[];
        jsonData.optionalItems.forEach(it => { 
            if(it.isPriceBakedIn === undefined) it.isPriceBakedIn = false; 
            if(it.isHiddenFromPrint === undefined) it.isHiddenFromPrint = false;
            if(it.vendorNotes === undefined) it.vendorNotes = "";
            if(it.type === undefined && it.name !== undefined) it.type = 'item';
            (it.subItems || []).forEach(sIt => { 
                if(sIt.isPriceBakedIn === undefined) sIt.isPriceBakedIn = false; 
                if(sIt.isHiddenFromPrint === undefined) sIt.isHiddenFromPrint = false;
                if(sIt.vendorNotes === undefined) sIt.vendorNotes = "";
            });
        });
        if(!Array.isArray(jsonData.terms))jsonData.terms=[]; if(!Array.isArray(jsonData.infoImages))jsonData.infoImages=[];
        (jsonData.infoImages || []).forEach(it => {
            if (it.type === 'image' && it.compressionImmune === undefined) it.compressionImmune = false;
            if (it.centering === undefined) it.centering = 'center'; // Default to center
        });
        if(!jsonData.signature) jsonData.signature = { date: "", lessorLine: "", lesseeLine: "", lessorText: translations.sv.signatureLessorLabel, lesseeText: translations.sv.signatureLesseeLabel };
    }
})();

function deepTraverseAndGetString(obj) {
    let result = [];
    if (typeof obj !== 'object' || obj === null) return [];
    for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
            const value = obj[key];
            if (typeof value === 'object' && value !== null) {
                result = result.concat(deepTraverseAndGetString(value));
            } else if (value) {
                result.push(value);
            }
        }
    }
    return result;
}

function formatCompanyInfo(companyObj) {
    if (!companyObj) return '';
    return deepTraverseAndGetString(companyObj).join('<br>');
}

function loadQuoteData(data, loadedFileName=null){
    jsonData=JSON.parse(JSON.stringify(data));
    const q = jsonData.quote || {};
    if(!q.quoteNumber)q.quoteNumber=Math.floor(Math.random()*100000).toString();
    if(q.marginPercentage === undefined) q.marginPercentage = 0;
    if(q.currencyMultiplicator === undefined) q.currencyMultiplicator = 11.8;
    if(q.useMultipleCurrencies === undefined) q.useMultipleCurrencies = false;
    if(q.usdToSekRate === undefined) q.usdToSekRate = 10.50; 
    if(q.eurToSekRate === undefined) q.eurToSekRate = 11.50; 
    if(q.showSignature === undefined) q.showSignature = false;
    if(q.showTillSection === undefined) q.showTillSection = true;
    if(q.removeTotal === undefined) q.removeTotal = false;
    if(q.defaultLogoWidth === undefined) q.defaultLogoWidth = 200;
    if(q.useCustomCurrency === undefined) q.useCustomCurrency = false;
    if(q.customCurrency === undefined) q.customCurrency = 'EUR';
    if(q.centerImagesByDefault === undefined) q.centerImagesByDefault = true;
    if(q.marginCalculationMode === undefined) q.marginCalculationMode = 'markup';
    if(!q.labels) q.labels = {};
    if (q.totalLabel) { 
        q.labels.totalLabel = q.totalLabel;
        delete q.totalLabel;
    }
    if (!q.visibility) {
        q.visibility = { optional: true, info: true, terms: true };
    }

    jsonData.quote = q;
    if(!Array.isArray(jsonData.terms))jsonData.terms=[];
    if(!jsonData.signature) jsonData.signature = { date: "", lessorLine: "", lesseeLine: "", lessorText: translations.sv.signatureLessorLabel, lesseeText: translations.sv.signatureLesseeLabel };
    
    (jsonData.items || []).forEach(it => { 
        if(it.isPriceBakedIn === undefined) it.isPriceBakedIn = false; 
        if(it.isHiddenFromPrint === undefined) it.isHiddenFromPrint = false;
        if(it.vendorNotes === undefined) it.vendorNotes = "";
        if(it.type === undefined && it.name !== undefined) it.type = 'item';
        (it.subItems || []).forEach(sIt => { 
            if(sIt.isPriceBakedIn === undefined) sIt.isPriceBakedIn = false; 
            if(sIt.isHiddenFromPrint === undefined) sIt.isHiddenFromPrint = false;
            if(sIt.vendorNotes === undefined) sIt.vendorNotes = "";
        });
    });
    (jsonData.optionalItems || []).forEach(it => { 
        if(it.isPriceBakedIn === undefined) it.isPriceBakedIn = false; 
        if(it.isHiddenFromPrint === undefined) it.isHiddenFromPrint = false;
        if(it.vendorNotes === undefined) it.vendorNotes = "";
        if(it.type === undefined && it.name !== undefined) it.type = 'item';
        (it.subItems || []).forEach(sIt => { 
            if(sIt.isPriceBakedIn === undefined) sIt.isPriceBakedIn = false; 
            if(sIt.isHiddenFromPrint === undefined) sIt.isHiddenFromPrint = false;
            if(sIt.vendorNotes === undefined) sIt.vendorNotes = "";
        });
    });
    (jsonData.infoImages || []).forEach(it => {
        if (it.type === 'image' && it.compressionImmune === undefined) it.compressionImmune = false;
        if (it.centering === undefined) it.centering = 'center';
    });


    document.getElementById('quoteNumber').textContent = q.quoteNumber || '';
    document.getElementById('quoteDate').textContent = q.date || new Date().toLocaleDateString('sv-SE');
    document.getElementById('projectNumber').textContent = q.projectNumber || '';
    document.getElementById('companyA').innerHTML = formatCompanyInfo(jsonData.companyA);
    document.getElementById('companyB').innerHTML = formatCompanyInfo(jsonData.companyB);
    document.getElementById('reference').textContent = q.reference||'';
    
    document.getElementById('currencyMultiplierInput').value = q.currencyMultiplicator||11.8;
    document.getElementById('marginPercentageInput').value = q.marginPercentage || 0;
    document.getElementById('defaultLogoWidthInput').value = q.defaultLogoWidth || 200;
    
    document.getElementById('useMultipleCurrenciesChk').checked = q.useMultipleCurrencies || false;
    document.getElementById('usdRateInput').value = parseFloat(q.usdToSekRate || 10.50).toFixed(2);
    document.getElementById('eurRateInput').value = parseFloat(q.eurToSekRate || 11.50).toFixed(2);
    toggleMultipleCurrencyUI(q.useMultipleCurrencies || false);


    document.getElementById('showDecimals').checked=q.showDecimals || false;
    document.getElementById('showProjectNumber').checked = q.projectNumberVisible || false; 
    document.getElementById('projectNumberDiv').style.display = (q.projectNumberVisible) ? 'block' : 'none';
    document.getElementById('addSignatureCheck').checked = q.showSignature || false;
    document.getElementById('signatureSection').style.display = (q.showSignature) ? 'block' : 'none';
    document.getElementById('toggleTillSectionChk').checked = q.showTillSection;
    applyTillSectionVisibility();
    document.getElementById('removeTotalCheck').checked = q.removeTotal || false;
    document.getElementById('useCustomCurrencyChk').checked = q.useCustomCurrency || false;
    document.getElementById('customCurrencyInput').value = q.customCurrency || 'EUR';
    document.getElementById("customCurrencyInput").style.display = (q.useCustomCurrency || false) ? 'inline-block' : 'none';
    document.getElementById('marginModeChk').checked = q.marginCalculationMode === 'margin';
    
    currentFileName = loadedFileName;
    currentLanguage = q.language || 'sv';
    reRenderAll();
    updateDocumentTitle();
}

function reRenderAll(){
    renumberAllItems(); 
    const { distributionRatio } = updatePrices();
    loadItems(jsonData.items,'itemsList', distributionRatio);
    loadItems(jsonData.optionalItems,'optionalItemsList', 1);
    loadTerms(jsonData.terms);
    loadInfoImages();
    loadSignature();
    calculateTotalPrice();
    makeEditable(); 
    initializeDragAndDrop();
    updateLanguageUI(currentLanguage);
    updatePrintMultiplier(); 
    applySectionVisibility();
    updateSectionVisibilityCheckboxes();
    checkQuoteDate();
    updateMarginLabel();
}

function buildPdfFileName() {
    const title = (document.getElementById('quoteTitle')?.textContent || 'Offert').trim();
    const ref = (document.getElementById('reference')?.textContent || '').trim();
    const quoteNum = (document.getElementById('quoteNumber')?.textContent || '0000').trim();
    
    let tillWords = '';
    if (document.getElementById('toggleTillSectionChk').checked) {
        const companyA_html = document.getElementById('companyA')?.innerHTML || '';
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = companyA_html;
        const companyA_text = tempDiv.textContent || tempDiv.innerText || '';
        tillWords = companyA_text.trim().split(/\s+/).slice(0, 2).join(' ');
    }

    const parts = [ title, ref, tillWords, quoteNum ];
    const safeParts = parts.filter(Boolean).map(p => {
        const withReplacements = p
            .replace(/ä/gi, 'a')
            .replace(/å/gi, 'a')
            .replace(/ö/gi, 'o');
        return withReplacements.replace(/[^\w\s\-]/gi, '').replace(/\s+/g, ' ').trim();
    });
    return safeParts.join(' - ') + '.pdf';
}

function updatePdfFileNameInput() {
    const input = document.getElementById('pdfFileNameInput');
    if (input) {
        input.value = buildPdfFileName();
    }
}

function updateDocumentTitle(){
    let baseTitle = document.getElementById('quoteTitle').textContent.trim() || ((currentLanguage==='sv') ? 'Offert' : 'Quote');
    let refVal = document.getElementById('reference').textContent.trim();
    document.title = (refVal) ? `${baseTitle} - ${refVal}` : baseTitle;
    updatePdfFileNameInput();
}

function updateLanguageUI(lang){
    document.documentElement.setAttribute('lang', lang);
    const t = translations[lang];
    const labels = jsonData.quote.labels || {};

    if(!t)return;

    document.getElementById('quoteTitle').textContent = labels.quoteTitle || t.quoteTitle;
    document.getElementById('quoteNumberLabel').childNodes[0].nodeValue = `${t.quoteNumberLabel} `;
    document.getElementById('dateLabel').childNodes[0].nodeValue = `${t.dateLabel} `;
    document.getElementById('toLabel').textContent = t.toLabel;
    document.getElementById('fromLabel').textContent = t.fromLabel;
    document.getElementById('refLabel').textContent = t.refLabel;
    document.getElementById('articleNameHeader').textContent = labels.articleNameHeader || t.articleNameHeader;
    document.getElementById('nrHeader').textContent = labels.nrHeader || t.nrHeader;
    document.getElementById('quantityHeader').textContent = labels.quantityHeader || t.quantityHeader;
    document.getElementById('optionalItemsHeading').textContent = labels.optionalItemsHeading || t.optionalItemsHeading;
    document.getElementById('optArticleHeader').textContent = labels.optArticleHeader || t.optArticleHeader;
    document.getElementById('optNrHeader').textContent = labels.optNrHeader || t.optNrHeader;
    document.getElementById('optQuantityHeader').textContent = labels.optQuantityHeader || t.optQuantityHeader;
    document.getElementById('infoImagesHeading').textContent = labels.infoImagesHeading || t.infoImagesHeading;
    document.getElementById('termsHeading').textContent = labels.termsHeading || t.termsHeading;
    document.getElementById('totalLabel').textContent = labels.totalLabel || t.totalLabel;
    
    document.getElementById('addItemButton').textContent = t.addItemButton;
    document.getElementById('addSeparatorButton').textContent = t.addSeparator;
    document.getElementById('addOptionalItemButton').textContent = t.addOptionalItemButton;
    document.getElementById('addOptionalSeparatorButton').textContent = t.addSeparator;
    document.getElementById('addTermButton').textContent = t.addTermButton;
    document.querySelector('.image-upload-container button[onclick="addPageBreak()"]').textContent = t.addPageBreak;
    document.querySelector('.image-upload-container button[onclick="reduceImageFileSizes()"]').textContent = t.reduceImageFileSizes;
    document.getElementById('toggleLanguageBtn').textContent = t.toggleLangBtn;
    document.getElementById('copyJsonBtn').textContent = t.copyJsonBtn;
    document.getElementById('defaultLogoWidthLabel').textContent = `${t.defaultLogoWidthLabel} `;
    document.getElementById('resetLogoSizeBtn').textContent = t.resetLogoSize;
    document.getElementById('pdfFileNameLabel').textContent = t.pdfFileNameLabel;
    document.getElementById('recompressTooltipText').textContent = t.recompressTooltipText;
    document.getElementById('reduceSizeTooltipText').textContent = t.reduceSizeTooltipText;
    
    document.querySelector('#removeTotalCheckboxLabel').lastChild.nodeValue = ` ${t.removeTotalLabelText}`;
    document.querySelector('#addSignatureCheckboxLabel').lastChild.nodeValue = ` ${t.addSignatureLabelText}`;
    document.querySelector('#toggleTillLabel').lastChild.nodeValue = ` ${t.hideTillSectionLabelText}`;
    document.querySelector('#customCurrencyLabel').textContent = ` ${t.customCurrencyLabelText}`;
    document.querySelector('#useMultipleCurrenciesLabel').textContent = ` ${t.useMultipleCurrenciesLabelText}`;
    document.querySelector('#usdRateLabel').textContent = `${t.usdRateLabelText} `;
    document.querySelector('#eurRateLabel').textContent = `${t.eurRateLabelText} `;
    document.querySelector('#marginModeLabel').textContent = ` ${t.marginModeLabelText}`;

    document.getElementById('showSectionsLabel').textContent = t.showSectionsLabel;
    document.getElementById('showOptionalLabel').textContent = t.showOptionalLabel;
    document.getElementById('showInfoLabel').textContent = t.showInfoLabel;
    document.getElementById('showTermsLabel').textContent = t.showTermsLabel;

    if (jsonData.signature) {
        if (!jsonData.signature.lessorText || jsonData.signature.lessorText === translations[lang === 'sv' ? 'en' : 'sv'].signatureLessorLabel) {
            jsonData.signature.lessorText = t.signatureLessorLabel;
        }
        if (!jsonData.signature.lesseeText || jsonData.signature.lesseeText === translations[lang === 'sv' ? 'en' : 'sv'].signatureLesseeLabel) {
            jsonData.signature.lesseeText = t.lesseeLabel;
        }
    }

    updatePriceHeaders();
    calculateTotalPrice();
    updateDocumentTitle();
    loadSignature();
    updateMarginLabel();
}

function updatePriceHeaders(){
    const customChk = document.getElementById("useCustomCurrencyChk");
    const currencyVal = document.getElementById("customCurrencyInput").value;
    const labels = jsonData.quote.labels || {};
    const t = translations[currentLanguage];
    
    const priceHeaderText = labels.priceHeader || t.priceHeader;
    const optPriceHeaderText = labels.optPriceHeader || t.optPriceHeader;

    const curSymbol = (customChk.checked && currencyVal) ? `(${currencyVal})` : "(SEK)";
    
    document.getElementById('priceHeader').textContent = `${priceHeaderText} ${curSymbol} `;
    document.getElementById('optPriceHeader').textContent = `${optPriceHeaderText} ${curSymbol} `;
}

function getPriceBreakdown(item, parentCurrencyOrigin) {
    const breakdown = {};
    const q = jsonData.quote;
    const marginPercentage = parseFloat(q.marginPercentage) || 0;
    let globalMultiplier = 1;

    if (q.marginCalculationMode === 'margin') {
        if (marginPercentage < 100) {
            globalMultiplier = 1 / (1 - (marginPercentage / 100));
        }
    } else { // markup
        globalMultiplier = 1 + (marginPercentage / 100);
    }

    const itemMarginMultiplier = 1 + ((item.marginPercentage || 0) / 100);

    breakdown.originalPrice = item.originalPrice ?? item.subItemOriginalPrice ?? 0;
    breakdown.currencyOrigin = (item.currencyOrigin || parentCurrencyOrigin || (q.useCustomCurrency && q.customCurrency) || 'SEK').toUpperCase();

    breakdown.rate = 1;
    breakdown.rateText = '';
    if (breakdown.currencyOrigin !== 'SEK') {
        if (q.useMultipleCurrencies) {
            if (breakdown.currencyOrigin === 'USD') breakdown.rate = parseFloat(q.usdToSekRate) || 1;
            else if (breakdown.currencyOrigin === 'EUR') breakdown.rate = parseFloat(q.eurToSekRate) || 1;
            else breakdown.rate = parseFloat(q.currencyMultiplicator) || 1;
        } else {
            breakdown.rate = parseFloat(q.currencyMultiplicator) || 1;
        }
        breakdown.rateText = `1 ${breakdown.currencyOrigin} = ${breakdown.rate.toFixed(2)} SEK`;
    }

    breakdown.priceInSEK = breakdown.originalPrice * breakdown.rate;
    breakdown.priceAfterLocalMargin = breakdown.priceInSEK * itemMarginMultiplier;
    breakdown.localMarginValue = breakdown.priceAfterLocalMargin - breakdown.priceInSEK;
    const priceAfterGlobalMargin = breakdown.priceAfterLocalMargin * globalMultiplier;
    breakdown.globalMarginValue = priceAfterGlobalMargin - breakdown.priceAfterLocalMargin;
    
    breakdown.finalPricePerUnit = priceAfterGlobalMargin;
    breakdown.marginModeUsed = q.marginCalculationMode;

    return breakdown;
}


function loadItems(items, containerId, distributionRatio = 1){
    const container = document.getElementById(containerId);
    if(!container) return;
    container.innerHTML = '';
    const fallbackCurrency = (jsonData.quote.useCustomCurrency && jsonData.quote.customCurrency) ? jsonData.quote.customCurrency : 'SEK';

    items.forEach((it, idx) => {
        if (it.type === 'separator') {
            const sepDiv = document.createElement('div');
            sepDiv.className = 'quote-item separator-item';
            sepDiv.dataset.index = idx;
            sepDiv.innerHTML = `
                <div class="screen-only" style="text-align:center; border-top: 2px dashed #ccc; padding: 8px; margin: 15px 0; position:relative;">
                    --- SIDBRYTNING / SEPARATOR ---
                    <span class="remove-icon" style="display:inline-block; top: 50%; transform: translateY(-50%);" onclick="removeItem('${containerId}', ${idx})">✖</span>
                </div>
                <div class="print-only"></div>
            `;
            container.appendChild(sepDiv);
            return;
        }

        if (it.isPriceBakedIn === undefined) it.isPriceBakedIn = false;
        if (it.isHiddenFromPrint === undefined) it.isHiddenFromPrint = false;
        if (it.marginPercentage === undefined) it.marginPercentage = 0;
        if (it.vendorNotes === undefined) it.vendorNotes = "";
        const margin = parseFloat(it.marginPercentage) || 0;
        const itemDiv = document.createElement('div');
        itemDiv.className = `quote-item ${it.isPriceBakedIn ? 'baked-in' : ''} ${it.isHiddenFromPrint ? 'hidden-from-print' : ''}`;
        itemDiv.dataset.index = idx; 
        itemDiv.dataset.itemId = it.id || `item-${containerId}-${idx}`; 

        const meta = document.createElement('div'); meta.className = 'item-meta';

        const bakeInButtonHTML = containerId === 'itemsList' ? `<button class="control-btn" title="${translations[currentLanguage].bakeInPriceLabel}" onclick="toggleBakeInPrice('${containerId}', ${idx})">👨‍🍳</button>` : '';
        const bakedInIconHTML = it.isPriceBakedIn ? `<span class="screen-only baked-in-icon" title="${translations[currentLanguage].bakedInPriceTooltip}">👨‍🍳</span>` : '';

        meta.innerHTML = `
            <div class="item-number editable" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-field="itemNumber" title="Klicka för att redigera nummer">${it.itemNumber}</div>
            <div class="item-name bold editable" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-field="name">${it.name||''} ${bakedInIconHTML}</div>
            <div class="quantity" data-item="${containerId}" data-index="${idx}" data-field="quantity"><div class="input-container"><input type="number" min="0" step="1" value="${it.quantity || 0}" class="${(it.quantity || 0) === 0 ? 'zero-text' : ''}"/><div class="button-container screen-only"><button type="button" class="increment-btn">+</button><button type="button" class="decrement-btn">-</button></div></div></div>
            <div class="targetPrice" data-item="${containerId}" data-index="${idx}" data-field="targetPrice" style="text-align:right;"><span class="editable ${(it.targetPrice || 0) === 0 && !it.isPriceBakedIn ? 'zero-text' : ''}" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-field="targetPrice" style="text-align:right;display:inline-block;width:100%;">${formatPrice(it.targetPrice || 0)}</span></div>
            <div class="item-tooltip screen-only">
                <span class="original-price-display editable" contenteditable="true" data-field="originalPriceAndCurrency" data-item="${containerId}" data-index="${idx}">${it.originalPrice != null ? it.originalPrice : 0} ${it.currencyOrigin || fallbackCurrency}</span>
                <span class="margin-display editable ${margin < 0 ? 'discount' : ''}" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-field="marginPercentage">${margin >= 0 ? '+' : ''}${margin}%</span>
            </div>
            <div class="item-actions screen-only">
                <button class="control-btn control-btn-move" title="${translations[currentLanguage].moveUp}" onclick="moveItemUp('${containerId}', ${idx})">▲</button>
                <button class="control-btn control-btn-move" title="${translations[currentLanguage].moveDown}" onclick="moveItemDown('${containerId}', ${idx})">▼</button>
                <button class="control-btn" title="${translations[currentLanguage].addSubItem}" onclick="addSubItemToParent('${containerId}', ${idx})">⊕</button>
                <button class="control-btn" title="${translations[currentLanguage].removeAllSubItems}" onclick="removeAllSubItems('${containerId}', ${idx})">🗑️</button>
                <button class="control-btn" title="${translations[currentLanguage].hideFromPrint}" onclick="toggleHiddenFromPrint('${containerId}', ${idx})">👁️</button>
                ${bakeInButtonHTML}
                <button class="control-btn" title="Gör till underpost" onclick="toggleItemHierarchy('${containerId}', ${idx})">↳</button>
                <button class="control-btn" title="Flytta till/från Alternativ" onclick="toggleItemOptionality('${containerId}', ${idx})">⇅</button>
                <button class="control-btn" title="${translations[currentLanguage].duplicateItem}" onclick="duplicateItem('${containerId}', ${idx})">❏</button>
                <button class="control-btn" title="${translations[currentLanguage].removeRow}" style="background-color:red; color:white;" onclick="removeItem('${containerId}', ${idx})">✖</button>
            </div>
        `;
        itemDiv.appendChild(meta);
        
        const breakdown = getPriceBreakdown(it, null);
        const localSign = breakdown.localMarginValue >= 0 ? '+' : '-';
        const globalSign = breakdown.globalMarginValue >= 0 ? '+' : '-';
        const globalMarginLabel = breakdown.marginModeUsed === 'margin' ? 'Marginal' : 'Pålägg';
        const priceAfterGlobalMargin = breakdown.finalPricePerUnit * (it.quantity || 0);
        const bakedAmount = it.targetPrice - priceAfterGlobalMargin;

        let bakedInRow = '';
        if (containerId === 'itemsList' && !it.isPriceBakedIn && !it.isHiddenFromPrint && Math.abs(bakedAmount) > 0.01) {
            bakedInRow = `<div>Inbakat: <i>${formatPrice(priceAfterGlobalMargin, true)}</i> + ${formatPrice(bakedAmount, true)} = <b>${formatPrice(it.targetPrice, true)} SEK</b></div>`;
        }

        const breakdownDiv = document.createElement('div');
        breakdownDiv.className = 'vendor-price-details';
        breakdownDiv.innerHTML = `
            <div>Original: ${formatNumber(breakdown.originalPrice.toFixed(2))} ${breakdown.currencyOrigin}</div>
            ${breakdown.rateText ? `<div>Kurs: ${breakdown.rateText} ➞ ${formatPrice(breakdown.priceInSEK, true)} SEK</div>` : ''}
            <div>Lokal (${(it.marginPercentage || 0)}%): <i>${formatPrice(breakdown.priceInSEK, true)}</i> ${localSign} ${formatPrice(Math.abs(breakdown.localMarginValue), true)} = <b>${formatPrice(breakdown.priceAfterLocalMargin, true)} SEK</b></div>
            <div>Global (${globalMarginLabel} ${jsonData.quote.marginPercentage || 0}%): <i>${formatPrice(breakdown.priceAfterLocalMargin, true)}</i> ${globalSign} ${formatPrice(Math.abs(breakdown.globalMarginValue), true)} = <b>${formatPrice(breakdown.finalPricePerUnit, true)} SEK</b></div>
            ${bakedInRow}
            <div style="border-top: 1px solid #ddd; margin-top: 3px; padding-top: 3px;">Total (Antal x Pris): <b>${formatPrice(breakdown.finalPricePerUnit * (it.quantity || 0), true)} SEK</b></div>
        `;
        itemDiv.appendChild(breakdownDiv);

        if(it.itemDescription){
            const details = document.createElement('div');
            details.className = 'item-details editable'; details.contentEditable = true;
            details.dataset.item = containerId; details.dataset.index = idx; details.dataset.field = 'itemDescription';
            details.innerHTML = it.itemDescription.replace(/\n/g,'<br>');
            const descRemove = document.createElement('span');
            descRemove.className = 'description-remove-icon screen-only'; descRemove.textContent = '✖'; descRemove.onclick = () => removeDescription(details);
            details.appendChild(descRemove); itemDiv.appendChild(details);
        }

        const vendorNotesDiv = document.createElement('div');
        vendorNotesDiv.className = 'vendor-item-notes editable p-editable';
        vendorNotesDiv.contentEditable = true;
        vendorNotesDiv.dataset.item = containerId;
        vendorNotesDiv.dataset.index = idx;
        vendorNotesDiv.dataset.field = 'vendorNotes';
        vendorNotesDiv.innerHTML = it.vendorNotes || '';
        itemDiv.appendChild(vendorNotesDiv);

        (it.subItems || []).forEach((sItem, sIdx) => { 
            if (sItem.marginPercentage === undefined) sItem.marginPercentage = 0;
            if (sItem.isPriceBakedIn === undefined) sItem.isPriceBakedIn = false;
            if (sItem.isHiddenFromPrint === undefined) sItem.isHiddenFromPrint = false;
            if (sItem.vendorNotes === undefined) sItem.vendorNotes = "";
            const subMargin = parseFloat(sItem.marginPercentage) || 0;
            const included = document.createElement('div'); 
            included.className = `included-item ${sItem.isPriceBakedIn ? 'baked-in' : ''} ${sItem.isHiddenFromPrint ? 'hidden-from-print' : ''}`;
            const sMeta = document.createElement('div'); sMeta.className = 'item-meta';
            const subBakedInIconHTML = sItem.isPriceBakedIn ? `<span class="screen-only baked-in-icon" title="${translations[currentLanguage].bakedInPriceTooltip}">👨‍🍳</span>` : '';

            sMeta.innerHTML = `
                <div class="item-number editable" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}" data-field="subItemNumber" title="Klicka för att redigera nummer">${sItem.subItemNumber}</div>
                <div class="item-name editable subitem-name-style" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}" data-field="subItemName">${sItem.subItemName||''} ${subBakedInIconHTML}</div>
                <div class="quantity" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}" data-field="subItemQuantity"><div class="input-container"><input type="number" min="0" step="1" value="${sItem.subItemQuantity || 0}" class="${(sItem.subItemQuantity || 0) === 0 ? 'zero-text' : ''}"/><div class="button-container screen-only"><button type="button" class="increment-btn">+</button><button type="button" class="decrement-btn">-</button></div></div></div>
                <div class="subItemTargetPrice" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}" data-field="subItemTargetPrice" style="text-align:right;"><span class="editable ${(sItem.subItemTargetPrice || 0) === 0 ? 'zero-text' : ''}" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}" data-field="subItemTargetPrice" style="text-align:right;display:inline-block;width:100%;">${formatPrice(sItem.subItemTargetPrice || 0)}</span></div>
                <div class="item-tooltip screen-only">
                    <span class="original-price-display editable" contenteditable="true" data-field="originalPriceAndCurrency" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}">${sItem.subItemOriginalPrice != null ? sItem.subItemOriginalPrice : 0} ${sItem.currencyOrigin || it.currencyOrigin || fallbackCurrency}</span>
                    <span class="margin-display editable ${subMargin < 0 ? 'discount' : ''}" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}" data-field="marginPercentage">${subMargin >= 0 ? '+' : ''}${subMargin}%</span>
                </div>
                <div class="item-actions screen-only">
                    <button class="control-btn control-btn-move" title="${translations[currentLanguage].moveUp}" onclick="moveSubItemUp('${containerId}', ${idx}, ${sIdx})">▲</button>
                    <button class="control-btn control-btn-move" title="${translations[currentLanguage].moveDown}" onclick="moveSubItemDown('${containerId}', ${idx}, ${sIdx})">▼</button>
                    <button class="control-btn" title="${translations[currentLanguage].hideFromPrint}" onclick="toggleHiddenFromPrintSubItem('${containerId}', ${idx}, ${sIdx})">👁️</button>
                    <button class="control-btn" title="${translations[currentLanguage].bakeInPriceLabel}" onclick="toggleBakeInSubItemPrice('${containerId}', ${idx}, ${sIdx})">👨‍🍳</button>
                    <button class="control-btn" title="Gör till huvudpost" onclick="toggleItemHierarchy('${containerId}', ${idx}, ${sIdx})">↰</button>
                    <button class="control-btn" title="${translations[currentLanguage].duplicateItem}" onclick="duplicateSubItem('${containerId}', ${idx}, ${sIdx})">❏</button>
                    <button class="control-btn" title="${translations[currentLanguage].removeRow}" style="background-color:red; color:white;" onclick="removeSubItem('${containerId}',${idx},${sIdx})">✖</button>
                 </div>
            `;
            included.appendChild(sMeta);
            
            const subBreakdown = getPriceBreakdown(sItem, it.currencyOrigin);
            const subLocalSign = subBreakdown.localMarginValue >= 0 ? '+' : '-';
            const subGlobalSign = subBreakdown.globalMarginValue >= 0 ? '+' : '-';
            const subGlobalMarginLabel = subBreakdown.marginModeUsed === 'margin' ? 'Marginal' : 'Pålägg';
            const subPriceAfterGlobalMargin = subBreakdown.finalPricePerUnit * (sItem.subItemQuantity || 0);
            const subBakedAmount = sItem.subItemTargetPrice - subPriceAfterGlobalMargin;

            let subBakedInRow = '';
            if (containerId === 'itemsList' && !sItem.isPriceBakedIn && !sItem.isHiddenFromPrint && Math.abs(subBakedAmount) > 0.01) {
                subBakedInRow = `<div>Inbakat: <i>${formatPrice(subPriceAfterGlobalMargin, true)}</i> + ${formatPrice(subBakedAmount, true)} = <b>${formatPrice(sItem.subItemTargetPrice, true)} SEK</b></div>`;
            }

            const subBreakdownDiv = document.createElement('div');
            subBreakdownDiv.className = 'vendor-price-details';
            subBreakdownDiv.innerHTML = `
                <div>Original: ${formatNumber(subBreakdown.originalPrice.toFixed(2))} ${subBreakdown.currencyOrigin}</div>
                ${subBreakdown.rateText ? `<div>Kurs: ${subBreakdown.rateText} ➞ ${formatPrice(subBreakdown.priceInSEK, true)} SEK</div>` : ''}
                <div>Lokal (${(sItem.marginPercentage || 0)}%): <i>${formatPrice(subBreakdown.priceInSEK, true)}</i> ${subLocalSign} ${formatPrice(Math.abs(subBreakdown.localMarginValue), true)} = <b>${formatPrice(subBreakdown.priceAfterLocalMargin, true)} SEK</b></div>
                <div>Global (${subGlobalMarginLabel} ${jsonData.quote.marginPercentage || 0}%): <i>${formatPrice(subBreakdown.priceAfterLocalMargin, true)}</i> ${subGlobalSign} ${formatPrice(Math.abs(subBreakdown.globalMarginValue), true)} = <b>${formatPrice(subBreakdown.finalPricePerUnit, true)} SEK</b></div>
                ${subBakedInRow}
                <div style="border-top: 1px solid #ddd; margin-top: 3px; padding-top: 3px;">Total (Antal x Pris): <b>${formatPrice(subBreakdown.finalPricePerUnit * (sItem.subItemQuantity || 0), true)} SEK</b></div>
            `;
            included.appendChild(subBreakdownDiv);

            if(sItem.subItemDescription){
                const sDetails = document.createElement('div');
                sDetails.className = 'item-details editable'; sDetails.contentEditable = true;
                sDetails.dataset.item = containerId; sDetails.dataset.index = idx; sDetails.dataset.includedIndex = sIdx; sDetails.dataset.field = 'subItemDescription';
                sDetails.innerHTML = sItem.subItemDescription.replace(/\n/g,'<br>');
                const sDescRem = document.createElement('span');
                sDescRem.className = 'description-remove-icon screen-only'; sDescRem.textContent = '✖'; sDescRem.onclick = () => removeDescription(sDetails);
                sDetails.appendChild(sDescRem); included.appendChild(sDetails);
            }
            
            const subVendorNotesDiv = document.createElement('div');
            subVendorNotesDiv.className = 'vendor-item-notes editable p-editable';
            subVendorNotesDiv.contentEditable = true;
            subVendorNotesDiv.dataset.item = containerId;
            subVendorNotesDiv.dataset.index = idx;
            subVendorNotesDiv.dataset.includedIndex = sIdx;
            subVendorNotesDiv.dataset.field = 'vendorNotes';
            subVendorNotesDiv.innerHTML = sItem.vendorNotes || '';
            included.appendChild(subVendorNotesDiv);

            itemDiv.appendChild(included);
        });
        container.appendChild(itemDiv);
    });
    
    // Attach event listeners for direct input on quantity fields
    container.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', () => handleQuantityChange(input));
        input.addEventListener('change', () => handleQuantityChange(input));
    });
}
function removeItem(containerId, idx){ const arr = (containerId ==='itemsList') ? jsonData.items : jsonData.optionalItems; arr.splice(idx,1); saveToLocal(); reRenderAll(); }
function removeSubItem(containerId, idx, sIdx){ const arr=(containerId==='itemsList')?jsonData.items:jsonData.optionalItems; arr[idx].subItems.splice(sIdx,1); saveToLocal(); reRenderAll(); }

function duplicateItem(containerId, index) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    if (list && list[index]) {
        const itemToCopy = list[index];
        if (itemToCopy.type === 'separator') return;
        const newItem = JSON.parse(JSON.stringify(itemToCopy));
        delete newItem.id; 
        list.splice(index + 1, 0, newItem);
        saveToLocal();
        reRenderAll();
    }
}

function duplicateSubItem(containerId, mainIndex, subIndex) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    const parentItem = list[mainIndex];
    if (parentItem && parentItem.subItems) {
        const subItemsList = parentItem.subItems;
        if (subItemsList && subItemsList[subIndex]) {
            const subItemToCopy = subItemsList[subIndex];
            const newSubItem = JSON.parse(JSON.stringify(subItemToCopy));
            subItemsList.splice(subIndex + 1, 0, newSubItem);
            saveToLocal();
            reRenderAll();
        }
    }
}

function removeDescription(el){ const {item: cId, index: i, includedIndex: si, field} = el.dataset; const it = (cId==='itemsList' ? jsonData.items : jsonData.optionalItems)[i]; (si ? (it.subItems)[si] : it)[field] = ''; saveToLocal(); reRenderAll(); }

function loadTerms(terms){
    const list=document.getElementById('termsList'); list.innerHTML='';
    (terms || []).forEach((t, i)=>{
        const termDiv = document.createElement('div');
        termDiv.className = 'term-item info-block';
        termDiv.dataset.index = i;
        termDiv.innerHTML = `
            <div class="controls-row screen-only">
                <span class="info-image-up" onclick="moveTermUp(${i})">▲</span>
                <span class="drag-handle">≡</span>
                <span class="info-image-down" onclick="moveTermDown(${i})">▼</span>
                <button class="control-btn" title="Klona" style="font-size:12px; width:20px; height:20px;" onclick="duplicateTerm(${i})">❏</button>
                <span class="remove-icon" onclick="removeTerm(${i})">✖</span>
            </div>
            <div class="content-wrapper">
                <div class="editable" contenteditable="true" data-field="term" data-index="${i}">${t}</div>
            </div>
        `;
        list.appendChild(termDiv);
    });
}
function removeTerm(i){ jsonData.terms.splice(i,1); saveToLocal(); reRenderAll(); }
function duplicateTerm(index) {
    if (jsonData.terms && jsonData.terms[index] !== undefined) {
        const termToCopy = jsonData.terms[index];
        jsonData.terms.splice(index + 1, 0, termToCopy);
        saveToLocal();
        reRenderAll();
    }
}

function loadInfoImages(){
    const c=document.getElementById('infoImagesList'); 
    c.innerHTML='';
    
    (jsonData.infoImages||[]).forEach((obj, idx)=>{
        const block=document.createElement('div');
        const centering = obj.centering || 'center';
        block.className=`info-block align-${centering}`; 
        block.dataset.index=idx;

        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'content-wrapper';

        if(obj.type==='text'){
            block.classList.add('info-block-fullwidth');
            const txt=document.createElement('div');
            txt.className='info-text-block editable'; txt.contentEditable=true; txt.dataset.index=idx; txt.innerHTML=obj.content||'';
            txt.addEventListener('input',()=>{ jsonData.infoImages[idx].content=txt.innerHTML; saveToLocal(); });
            contentWrapper.appendChild(txt);
        } else if(obj.type==='table'){
            block.classList.add('info-block-fullwidth');
            const table=document.createElement('table'); table.className='info-table';
            for(let r=0;r<obj.rows;r++){
                const row=document.createElement('tr');
                for(let cc=0;cc<obj.cols;cc++){
                    const cell=document.createElement('td');
                    cell.contentEditable=true; cell.innerHTML=obj.data[r]?.[cc]||'';
                    cell.addEventListener('input',()=>{ if(!obj.data[r])obj.data[r]=[]; obj.data[r][cc]=cell.innerHTML; saveToLocal(); });
                    row.appendChild(cell);
                }
                table.appendChild(row);
            }
            contentWrapper.appendChild(table);
        } else if (obj.type === 'page-break') {
            block.classList.add('info-block-fullwidth', 'page-break-element');
            contentWrapper.innerHTML = `<div class="screen-only" style="text-align:center; border: 2px dashed #ccc; padding: 10px; margin: 10px 0;">--- SIDBRYTNING ---</div>`;
        } else { // Image
            block.classList.add('info-block-image');
            const imgContainer=document.createElement('div');
            imgContainer.className='info-image-container';
            const img=document.createElement('img');
            img.src=obj.src; img.style.width=(obj.width||400)+'px';
            const resizeH=document.createElement('div');
            resizeH.className='image-resize-handle screen-only'; 
            imgContainer.append(img, resizeH); 
            contentWrapper.appendChild(imgContainer);
            initializeResize(resizeH,img,idx);
        }
        
        const controls = document.createElement('div');
        controls.className = 'controls-row screen-only';
        const immune = obj.compressionImmune || false;
        
        let centeringIcon = '◧'; // Left
        if (centering === 'center') centeringIcon = '●';

        let commonControls = `
            <span class="control-btn" title="Justering (Vänster/Center)" onclick="toggleInfoItemCentering(${idx})">${centeringIcon}</span>
            <span class="control-btn" title="Flytta längst upp" onclick="moveInfoItemToTop(${idx})">🔝</span>
            <span class="info-image-up" onclick="moveImageUp(${idx})">▲</span>
            <span class="drag-handle">≡</span>
            <span class="info-image-down" onclick="moveImageDown(${idx})">▼</span>
            <button class="control-btn" title="Klona" onclick="duplicateInfoItem(${idx})">❏</button>
            <span class="remove-icon" onclick="removeInfoItem(${idx})">✖</span>`;

        if (obj.type === 'image') {
            controls.innerHTML = `
                <span class="control-btn" title="${translations[currentLanguage].cropImage}" onclick="openCropper(${idx})">✂️</span>
                <span class="control-btn" title="${translations[currentLanguage].downloadImage}" onclick="downloadImage(${idx})">⤓</span>
                <span class="control-btn" id="immuneBtn_${idx}" title="${translations[currentLanguage].toggleCompressionImmune}" onclick="toggleCompressionImmune(${idx})" style="background-color: ${immune ? '#6c757d' : ''}; color: ${immune ? 'white' : ''};">🛡️</span>
                <span class="info-image-up" title="Större (+10%)" onclick="adjustImageSize(${idx}, 1.10)">+</span>
                <span class="info-image-down" title="Mindre (-5%)" onclick="adjustImageSize(${idx}, 0.95)">-</span>
                ${commonControls}`;
        } else {
             controls.innerHTML = commonControls;
        }
        
        block.appendChild(controls); 
        block.appendChild(contentWrapper); 
        c.appendChild(block);
    });
}
function loadSignature() {
    if (!jsonData.signature) return;
    const sig = jsonData.signature;
    document.getElementById('signatureDateLabel').textContent = translations[currentLanguage].signatureDateLabel;
    document.getElementById('signatureDate').innerHTML = sig.date || '                    ';
    
    const lessorBlock = document.querySelector('.signature-block:first-child');
    if (lessorBlock) {
        lessorBlock.querySelector('.signature-line').innerHTML = sig.lessorLine || '';
        lessorBlock.querySelector('.editable[data-field="signatureLessorText"]').innerHTML = sig.lessorText || translations[currentLanguage].signatureLessorLabel;
    }

    const lesseeBlock = document.querySelector('.signature-block:last-child');
     if (lesseeBlock) {
        lesseeBlock.querySelector('.signature-line').innerHTML = sig.lesseeLine || '';
        lesseeBlock.querySelector('.editable[data-field="signatureLesseeText"]').innerHTML = sig.lesseeText || translations[currentLanguage].signatureLesseeLabel;
    }
}
function removeInfoItem(idx){ jsonData.infoImages.splice(idx,1); saveToLocal(); reRenderAll(); }
function duplicateInfoItem(index) {
    if (jsonData.infoImages && jsonData.infoImages[index]) {
        const itemToCopy = jsonData.infoImages[index];
        const newItem = JSON.parse(JSON.stringify(itemToCopy));
        jsonData.infoImages.splice(index + 1, 0, newItem);
        saveToLocal();
        reRenderAll();
    }
}
function addInfoText(){ jsonData.infoImages.push({ type:'text', content: translations[currentLanguage].newInfoText, centering: 'center' }); saveToLocal(); reRenderAll(); }
function addTable(){
    const rows=prompt('Antal rader','3'); const cols=prompt('Antal kolumner','3');
    if(rows && cols){
        jsonData.infoImages.push({ type:'table', rows:parseInt(rows)||2, cols:parseInt(cols)||2, data:Array.from({length: parseInt(rows)||2}, () => new Array(parseInt(cols)||2).fill('')), centering: 'center' });
        saveToLocal(); reRenderAll();
    }
}
function addPageBreak() {
    jsonData.infoImages.push({ type: 'page-break' });
    saveToLocal();
    reRenderAll();
}
function addImageFromUrl(){
    const url=prompt(translations[currentLanguage].promptImageUrl);
    if(url){ jsonData.infoImages.push({ type:'image', src:url, width:400, description:'', compressionImmune: false, centering: 'center' }); saveToLocal(); reRenderAll(); }
}
document.getElementById('imageUpload').addEventListener('change',function(ev){
    for(let f of ev.target.files){
        const process = (src) => { jsonData.infoImages.push({ type:'image', src, width:400, description:'', compressionImmune: false, centering: 'center' }); saveToLocal(); reRenderAll(); };
        if(document.getElementById('compressImagesChk').checked){
            const quality = parseFloat(document.getElementById('compressionQuality').value) || 0.7;
            const maxWidth = parseInt(document.getElementById('compressionMaxWidth').value) || 1280;
            compressImageFromFile(f, quality, maxWidth, process); 
        } else { 
            const reader=new FileReader(); 
            reader.onload=(e)=>process(e.target.result); 
            reader.readAsDataURL(f); 
        }
    }
});
function initializeResize(handle,img,idxOrId){
    let startWidth, startX;
    const onDown=(ev)=>{ 
        ev.preventDefault(); 
        startWidth=img.offsetWidth; 
        startX=ev.clientX;
        document.addEventListener('mousemove',onMove); 
        document.addEventListener('mouseup',onUp);
    };
    const onMove=(ev)=>{ 
        ev.preventDefault(); 
        const newWidth = startWidth+(ev.clientX-startX);
        if(newWidth>40){ 
            img.style.width=newWidth+'px'; 
            if (typeof idxOrId === 'number') {
                jsonData.infoImages[idxOrId].width=newWidth; 
            } else if (idxOrId === 'logo') {
                localStorage.setItem('logoWidth', newWidth);
            }
        }
    };
    const onUp=()=>{ 
        if (typeof idxOrId === 'number') {
            saveToLocal(); 
        }
        document.removeEventListener('mousemove',onMove); 
        document.removeEventListener('mouseup',onUp);
    };
    handle.addEventListener('mousedown',onDown);
}

function hideInfoSection(){ jsonData.quote.visibility.info = false; saveToLocal(); applySectionVisibility(); updateSectionVisibilityCheckboxes(); }
function hideOptionalSection(){ jsonData.quote.visibility.optional = false; saveToLocal(); applySectionVisibility(); updateSectionVisibilityCheckboxes(); }
function hideTermsSection(){ jsonData.quote.visibility.terms = false; saveToLocal(); applySectionVisibility(); updateSectionVisibilityCheckboxes(); }
function removeMainSection(){ if(confirm('Är du säker på att du vill ta bort ALLA artiklar från huvudlistan?')) { jsonData.items = []; saveToLocal(); reRenderAll(); } }
function removeSignatureBlock(index) {
    alert("This block cannot be removed, only hidden by unchecking 'Lägg till signatur'.");
}


function moveImageUp(idx){ if(idx>0){ [jsonData.infoImages[idx], jsonData.infoImages[idx-1]] = [jsonData.infoImages[idx-1], jsonData.infoImages[idx]]; saveToLocal(); reRenderAll(); } }
function moveImageDown(idx){ if(idx<jsonData.infoImages.length-1){ [jsonData.infoImages[idx], jsonData.infoImages[idx+1]] = [jsonData.infoImages[idx+1], jsonData.infoImages[idx]]; saveToLocal(); reRenderAll(); } }
function moveInfoItemToTop(index) {
    if (index > 0 && jsonData.infoImages && jsonData.infoImages[index]) {
        const [itemToMove] = jsonData.infoImages.splice(index, 1);
        jsonData.infoImages.unshift(itemToMove);
        saveToLocal();
        reRenderAll();
    }
}

function compressImageFromFile(file, quality, maxWidth, callback){
    const reader=new FileReader();
    reader.onload=(e)=>{
        compressImageDataUrl(e.target.result, quality, maxWidth).then(callback);
    };
    reader.readAsDataURL(file);
}

function compressImageDataUrl(dataUrl, quality, maxWidth) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
                height = Math.round(height * (maxWidth / width));
                width = maxWidth;
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, width, height);
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.onerror = (err) => {
            console.error("Image load error:", err);
            reject("Kunde inte ladda bild för komprimering.");
        };
        img.src = dataUrl;
    });
}

function getBase64ByteSize(base64String) {
    if (!base64String.includes(',')) return 0;
    const base64 = base64String.split(',')[1];
    const padding = (base64.endsWith('==') ? 2 : (base64.endsWith('=') ? 1 : 0));
    return (base64.length * 0.75) - padding;
}

function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}

async function performCompression(action) {
    const statusDiv = document.getElementById('compressionStatus');
    statusDiv.style.display = 'none';

    const imageObjects = jsonData.infoImages.filter(obj => obj.type === 'image' && obj.src && !obj.compressionImmune);
    if (imageObjects.length === 0) {
        statusDiv.innerHTML = 'Inga bilder att bearbeta.';
        statusDiv.style.display = 'block';
        setTimeout(() => { statusDiv.style.display = 'none'; }, 4000);
        return;
    }

    let totalSizeBefore = imageObjects.reduce((sum, img) => sum + getBase64ByteSize(img.src), 0);

    if (action === 'recompress') {
        statusDiv.textContent = translations[currentLanguage].statusRecompressing;
    } else {
        statusDiv.textContent = translations[currentLanguage].statusFileSizeReducing;
    }
    statusDiv.style.display = 'block';

    const quality = parseFloat(document.getElementById('compressionQuality').value) || 0.7;
    const maxWidth = parseInt(document.getElementById('compressionMaxWidth').value) || 1280;

    const promises = imageObjects.map(async (imgObject) => {
        try {
            let newSrc;
            if (action === 'recompress') {
                newSrc = await compressImageDataUrl(imgObject.src, quality, maxWidth);
            } else { // reduce
                const dims = await getImageDimensions(imgObject.src);
                const currentQuality = imgObject.quality || 0.8;
                const newQuality = Math.max(0.1, currentQuality - 0.1);
                newSrc = await compressImageDataUrl(imgObject.src, newQuality, dims.width + 1);
                imgObject.quality = newQuality;
            }
            imgObject.src = newSrc;
        } catch (error) {
            console.error(`Failed to process image:`, error);
        }
    });

    await Promise.all(promises);

    let totalSizeAfter = imageObjects.reduce((sum, img) => sum + getBase64ByteSize(img.src), 0);
    const reduction = totalSizeBefore > 0 ? ((totalSizeBefore - totalSizeAfter) / totalSizeBefore) * 100 : 0;

    statusDiv.innerHTML = `
        Före: <b>${formatBytes(totalSizeBefore)}</b> | 
        Efter: <b>${formatBytes(totalSizeAfter)}</b> | 
        Minskning: <b>${reduction.toFixed(1)}%</b>
    `;

    saveToLocal();
    reRenderAll();
    
    setTimeout(() => { statusDiv.style.display = 'none'; }, 8000);
}

function recompressAllImages() {
    performCompression('recompress');
}

function reduceImageFileSizes() {
    performCompression('reduce');
}

function getImageDimensions(dataUrl) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve({ width: img.width, height: img.height });
        img.onerror = () => reject('Could not load image to get dimensions');
        img.src = dataUrl;
    });
}

function toggleCompressionImmune(index) {
    const img = jsonData.infoImages[index];
    if (img && img.type === 'image') {
        img.compressionImmune = !img.compressionImmune;
        saveToLocal();
        const btn = document.getElementById(`immuneBtn_${index}`);
        if (btn) {
            btn.style.backgroundColor = img.compressionImmune ? '#6c757d' : '';
            btn.style.color = img.compressionImmune ? 'white' : '';
        }
    }
}

function downloadImage(index) {
    const imgObject = jsonData.infoImages[index];
    if (!imgObject || imgObject.type !== 'image' || !imgObject.src) return;

    const ref = (document.getElementById('reference')?.textContent || 'bild').trim().replace(/[^\w\s\-]/gi, '');
    const qualityPart = imgObject.quality ? `_q${imgObject.quality.toFixed(1)}` : '';
    const fileName = `${ref} - Image ${index + 1}${qualityPart}.png`;

    const a = document.createElement('a');
    a.href = imgObject.src;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function updatePrices(){
    const q = jsonData.quote;
    const marginPercentage = parseFloat(q.marginPercentage) || 0;
    let globalMultiplier = 1;

    if (q.marginCalculationMode === 'margin') {
        if (marginPercentage < 100) {
            globalMultiplier = 1 / (1 - (marginPercentage / 100));
        }
    } else { // markup
        globalMultiplier = 1 + (marginPercentage / 100);
    }

    const useMultiCurrency = q.useMultipleCurrencies;
    const singleMultiplier = parseFloat(q.currencyMultiplicator) || 1;
    const usdRate = parseFloat(q.usdToSekRate) || 10.5;
    const eurRate = parseFloat(q.eurToSekRate) || 11.5;

    const calculateEntityPrice = (item, parentCurrencyOrigin) => {
        const itemMarginMultiplier = 1 + ((item.marginPercentage || 0) / 100);
        let originalPrice = item.originalPrice ?? item.subItemOriginalPrice ?? 0;
        let currencyOrigin = (item.currencyOrigin || parentCurrencyOrigin || (q.useCustomCurrency && q.customCurrency) || 'SEK').toUpperCase();
        
        let basePriceInSEK = originalPrice;
        if (currencyOrigin !== 'SEK') {
            if (useMultiCurrency) {
                if (currencyOrigin === 'USD') basePriceInSEK *= usdRate;
                else if (currencyOrigin === 'EUR') basePriceInSEK *= eurRate;
                else basePriceInSEK *= singleMultiplier; 
            } else {
                basePriceInSEK *= singleMultiplier;
            }
        }
        return (basePriceInSEK * itemMarginMultiplier) * globalMultiplier;
    };

    let totalToDistribute = 0;
    let distributionPoolTotal = 0;
    
    jsonData.items.filter(it => it.type !== 'separator').forEach(item => {
        let itemOwnPrice = calculateEntityPrice(item, null) * (item.quantity || 0);
        let subItemsPrice = 0;
        (item.subItems || []).forEach(s => {
            s.subItemTargetPrice = calculateEntityPrice(s, item.currencyOrigin) * (s.subItemQuantity || 0);
            subItemsPrice += s.subItemTargetPrice;
        });
        item.preBakeTargetPrice = itemOwnPrice + subItemsPrice;

        if (item.isPriceBakedIn || item.isHiddenFromPrint) {
            totalToDistribute += item.preBakeTargetPrice;
        } else {
            distributionPoolTotal += item.preBakeTargetPrice;
        }
    });
    
    const distributionRatio = distributionPoolTotal > 0 ? 1 + (totalToDistribute / distributionPoolTotal) : 1;

    jsonData.items.filter(it => it.type !== 'separator').forEach(item => {
        if (item.isPriceBakedIn || item.isHiddenFromPrint) {
            item.targetPrice = 0;
            (item.subItems || []).forEach(s => s.subItemTargetPrice = 0);
        } else {
            let itemOwnPrice = calculateEntityPrice(item, null) * (item.quantity || 0);
            let bakedInSubItemsPrice = 0;
            (item.subItems || []).forEach(s => {
                s.subItemTargetPrice = calculateEntityPrice(s, item.currencyOrigin) * (s.subItemQuantity || 0) * distributionRatio;
                if (s.isPriceBakedIn || s.isHiddenFromPrint) {
                    bakedInSubItemsPrice += s.subItemTargetPrice;
                }
            });
            item.targetPrice = (itemOwnPrice * distributionRatio) + bakedInSubItemsPrice;
        }
    });

    jsonData.optionalItems.filter(it => it.type !== 'separator').forEach(item => {
        let itemOwnPrice = calculateEntityPrice(item, null) * (item.quantity || 0);
        let bakedInSubItemsPrice = 0;
        (item.subItems || []).forEach(s => {
            s.subItemTargetPrice = calculateEntityPrice(s, item.currencyOrigin) * (s.subItemQuantity || 0);
            if (s.isPriceBakedIn || s.isHiddenFromPrint) {
                bakedInSubItemsPrice += s.subItemTargetPrice;
            }
        });
        item.targetPrice = itemOwnPrice + bakedInSubItemsPrice;
    });

    return { distributionRatio };
}

function calculateTotalPrice(){
    let total = 0;
    jsonData.items.filter(it => it.type !== 'separator').forEach(item => {
        total += (item.targetPrice || 0);
        (item.subItems || []).forEach(sItem => {
            if (!sItem.isPriceBakedIn && !sItem.isHiddenFromPrint) {
                total += (sItem.subItemTargetPrice || 0);
            }
        });
    });

    const currencyVal = document.getElementById("useCustomCurrencyChk").checked ? (document.getElementById("customCurrencyInput").value.trim() || "SEK") : "SEK";
    document.getElementById('totalValue').textContent= `${formatPrice(total)} ${currencyVal}`;
    document.getElementById('totalPrice').style.display = document.getElementById('removeTotalCheck').checked ? 'none' : '';
}
function formatPrice(price, forceSEK = false){
    let displayPrice = price || 0;
    const useCustom = document.getElementById('useCustomCurrencyChk').checked;

    if (useCustom && !forceSEK) {
        const multiplier = parseFloat(document.getElementById('currencyMultiplierInput').value) || 1;
        if (multiplier > 0) {
            displayPrice = displayPrice / multiplier;
        }
    }
    
    return formatNumber((document.getElementById('showDecimals').checked ? displayPrice.toFixed(2) : Math.round(displayPrice).toString()));
}
function formatNumber(numStr){ return numStr.replace(/\B(?=(\d{3})+(?!\d))/g,' '); }

document.addEventListener('click',e=>{
    if (e.target.matches('#copyJsonBtn')) { copyJsonToClipboard(); return; }
    const par = e.target.closest('.quantity');
    if (!par) return;
    const inp = par.querySelector('input[type="number"]');
    let val = parseInt(inp.value) || 0;
    if(e.target.classList.contains('increment-btn')){ inp.value = val + 1; handleQuantityChange(inp); }
    else if(e.target.classList.contains('decrement-btn')){ inp.value = Math.max(0, val - 1); handleQuantityChange(inp); }
});

function createHiddenJsonDiv(container) { const div = document.createElement('div'); div.id = 'hidden-json'; div.style.display = 'none'; div.textContent = encryptCaesar(JSON.stringify(jsonData), caesarShift); (container || document.getElementById('quoteContent')).appendChild(div); }
function removeHiddenJsonDiv() { document.getElementById('hidden-json')?.remove(); }
window.addEventListener('beforeprint', () => createHiddenJsonDiv());
window.addEventListener('afterprint', () => removeHiddenJsonDiv());
function handleQuantityChange(inp){
    const {item: containerId, index: idx, includedIndex: sIdx} = inp.closest('.quantity').dataset;
    const item = (containerId === 'itemsList' ? jsonData.items : jsonData.optionalItems)[idx];
    
    // Update quantity
    (sIdx ? item.subItems[sIdx] : item)[sIdx ? 'subItemQuantity' : 'quantity'] = parseInt(inp.value) || 0;
    
    // Safety check: If originalPrice is 0 but targetPrice is set, reverse calculate originalPrice
    // This handles cases where user typed a price manually before setting quantity
    const currentTarget = (sIdx ? item.subItems[sIdx].subItemTargetPrice : item.targetPrice) || 0;
    const currentOriginal = (sIdx ? item.subItems[sIdx].subItemOriginalPrice : item.originalPrice) || 0;
    const qty = parseInt(inp.value) || 0;
    
    if (currentOriginal === 0 && currentTarget > 0 && qty > 0) {
         if (sIdx) item.subItems[sIdx].subItemOriginalPrice = currentTarget / qty;
         else item.originalPrice = currentTarget / qty;
    }

    saveToLocal(); 
    // Force update of prices immediately
    updatePrices();
    calculateTotalPrice();
    updateLiveDOMPrices(containerId, idx, sIdx);
}

document.getElementById('swapButton').addEventListener('click',()=>{ [jsonData.companyA, jsonData.companyB] = [jsonData.companyB, jsonData.companyA]; saveToLocal(); loadQuoteData(jsonData, currentFileName); });
document.getElementById('showProjectNumber').addEventListener('change', function(){ document.getElementById('projectNumberDiv').style.display=this.checked?'block':'none'; jsonData.quote.projectNumberVisible = this.checked; saveToLocal(); });
document.getElementById('addSignatureCheck').addEventListener('change', function(){ document.getElementById('signatureSection').style.display=this.checked?'block':'none'; jsonData.quote.showSignature = this.checked; saveToLocal(); });
document.getElementById('toggleTillSectionChk').addEventListener('change', function(){ jsonData.quote.showTillSection = this.checked; applyTillSectionVisibility(); saveToLocal(); updatePdfFileNameInput(); });

document.getElementById('currencyMultiplierInput').addEventListener('input',function(){ const val=parseFloat(this.value); if(!isNaN(val)){ jsonData.quote.currencyMultiplicator=val; saveToLocal(); reRenderAll(); }});
document.getElementById('marginPercentageInput').addEventListener('input', function() { const val = parseFloat(this.value); if (!isNaN(val)) { jsonData.quote.marginPercentage = val; saveToLocal(); reRenderAll(); }});
document.getElementById('defaultLogoWidthInput').addEventListener('input', function() { const val = parseInt(this.value); if (!isNaN(val)) { jsonData.quote.defaultLogoWidth = val; saveToLocal(); }});

document.getElementById('useMultipleCurrenciesChk').addEventListener('change', function() {
    jsonData.quote.useMultipleCurrencies = this.checked;
    toggleMultipleCurrencyUI(this.checked);
    saveToLocal();
    reRenderAll();
});
document.getElementById('usdRateInput').addEventListener('input', function() {
    const val = parseFloat(this.value); if(!isNaN(val)) { jsonData.quote.usdToSekRate = val; saveToLocal(); reRenderAll(); }
});
document.getElementById('eurRateInput').addEventListener('input', function() {
    const val = parseFloat(this.value); if(!isNaN(val)) { jsonData.quote.eurToSekRate = val; saveToLocal(); reRenderAll(); }
});

function toggleMultipleCurrencyUI(isMultiActive) {
    document.getElementById('multipleCurrencyRatesDiv').style.display = isMultiActive ? 'block' : 'none';
    document.getElementById('singleCurrencyMultiplierDiv').style.display = isMultiActive ? 'none' : 'block';
    if(isMultiActive) {
        updateMultiCurrencyInputsFromLiveRates(false); 
    }
}


document.getElementById('showDecimals').addEventListener('change', function(){ jsonData.quote.showDecimals = this.checked; saveToLocal(); reRenderAll(); });

document.getElementById('addItemButton').addEventListener('click',()=>{ jsonData.items.push({ type: 'item', name:translations[currentLanguage].newArticleName, itemDescription:translations[currentLanguage].newDescription, quantity:1, originalPrice:0, targetPrice:0, marginPercentage: 0, subItems:[], isPriceBakedIn: false, isHiddenFromPrint: false, vendorNotes: "" }); saveToLocal(); reRenderAll(); });
document.getElementById('addSeparatorButton').addEventListener('click', () => addSeparator('itemsList'));
document.getElementById('addOptionalItemButton').addEventListener('click',()=>{ jsonData.optionalItems.push({ type: 'item', name:translations[currentLanguage].newAltArticleName, itemDescription:translations[currentLanguage].newOptionalItemDescription, quantity:1, originalPrice:0, targetPrice:0, marginPercentage: 0, subItems:[], isHiddenFromPrint: false, vendorNotes: "" }); saveToLocal(); reRenderAll(); });
document.getElementById('addOptionalSeparatorButton').addEventListener('click', () => addSeparator('optionalItemsList'));
document.getElementById('addTermButton').addEventListener('click',()=>{ if (!jsonData.terms) jsonData.terms = []; jsonData.terms.push(translations[currentLanguage].newTermText); saveToLocal(); reRenderAll(); });

function addSeparator(containerId) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    list.push({ type: 'separator', id: 'sep-' + Date.now() + Math.random() });
    saveToLocal();
    reRenderAll();
}

function parseFileName(fileName){ const match = fileName.replace(/\.json$/i,'').match(/^(.*)_(\d{6})_v(\d+)$/); return match ? { prefix: match[1], datePart: match[2], version: parseInt(match[3],10) } : null; }
document.getElementById('fileInput').addEventListener('change',function(ev){
    const f=ev.target.files[0];
    if(f && (f.type==='application/json' || f.name.endsWith('.json'))){
        const r=new FileReader();
        r.onload=(e)=>{ 
            let fileContent = e.target.result;
            // Strip BOM if present
            if (fileContent.charCodeAt(0) === 0xFEFF) {
                fileContent = fileContent.slice(1);
            }
            
            try {
                // Attempt 1: Parse as plain JSON
                // If it's plain JSON, we can safely replace dashes here if needed, 
                // but usually better to do it after parsing or not at all if not needed.
                // For compatibility with the original request, we apply replace ONLY if it parses successfully as plain JSON first?
                // No, the original code applied replace globally. 
                // The FIX is to try parsing plain JSON first WITHOUT replace.
                
                loadQuoteData(JSON.parse(fileContent), f.name);
                saveToLocal();
            } catch (err) {
                try {
                    // Attempt 2: Decrypt then parse
                    // Do NOT replace dashes before decryption!
                    const decryptedContent = decryptCaesar(fileContent, caesarShift);
                    // Now we can parse
                    loadQuoteData(JSON.parse(decryptedContent), f.name);
                    saveToLocal();
                } catch (err2) {
                    // Fallback: Maybe it was the dash replacement issue on a plain file?
                    // Try the original logic as a last resort
                    try {
                         const replacedContent = fileContent.replace(/–/g, '-');
                         loadQuoteData(JSON.parse(replacedContent), f.name);
                         saveToLocal();
                    } catch (err3) {
                        alert('JSON-formatet verkar vara felaktigt eller krypterat med en annan nyckel: ' + err2);
                    }
                }
            }
        };
        r.readAsText(f);
    } else { alert('Vänligen ladda upp en giltig JSON-fil.'); }
});

document.getElementById("toggleLanguageBtn").addEventListener('click', ()=>{ 
    currentLanguage = currentLanguage === 'sv' ? 'en' : 'sv';
    jsonData.quote.language = currentLanguage;
    saveToLocal();
    reRenderAll();
});
document.getElementById("useCustomCurrencyChk").addEventListener('change', (e) => { document.getElementById("customCurrencyInput").style.display = e.target.checked ? 'inline-block' : 'none'; jsonData.quote.useCustomCurrency = e.target.checked; saveToLocal(); reRenderAll(); });
document.getElementById("customCurrencyInput").addEventListener('input', function(){ jsonData.quote.customCurrency = this.value.trim(); saveToLocal(); reRenderAll(); });
document.getElementById('removeTotalCheck').addEventListener('change', function() {
    jsonData.quote.removeTotal = this.checked;
    saveToLocal();
    calculateTotalPrice();
});


let itemsSortable, optionalItemsSortable, termsSortable, infoSortable, signatureSortable;
function initializeDragAndDrop(){
    if(itemsSortable) itemsSortable.destroy(); if(optionalItemsSortable) optionalItemsSortable.destroy();
    if(termsSortable) termsSortable.destroy(); if(infoSortable) infoSortable.destroy();
    if(signatureSortable) signatureSortable.destroy();
    
    const onSortEnd = (arr, evt) => { 
        if (evt.oldIndex === undefined || evt.newIndex === undefined) return;
        const [moved] = arr.splice(evt.oldIndex, 1); 
        arr.splice(evt.newIndex, 0, moved); 
        saveToLocal(); 
        reRenderAll(); 
    };

    itemsSortable = Sortable.create(document.getElementById('itemsList'),{ 
        group:'sharedItems', 
        animation:150, 
        handle: '.item-meta', 
        onEnd: (evt) => { if(evt.to === evt.from) onSortEnd(jsonData.items, evt); },
        onAdd: (evt) => { 
            if (evt.from.id === 'optionalItemsList') { 
                const [moved] = jsonData.optionalItems.splice(evt.oldIndex, 1); 
                jsonData.items.splice(evt.newIndex, 0, moved); 
                saveToLocal(); reRenderAll(); 
            } 
        }
    });
    optionalItemsSortable=Sortable.create(document.getElementById('optionalItemsList'),{ 
        group:'sharedItems', 
        animation:150, 
        handle: '.item-meta', 
        onEnd: (evt) => { if(evt.to === evt.from) onSortEnd(jsonData.optionalItems, evt); },
        onAdd: (evt) => { 
            if (evt.from.id === 'itemsList') { 
                const [moved] = jsonData.items.splice(evt.oldIndex, 1); 
                jsonData.optionalItems.splice(evt.newIndex, 0, moved); 
                saveToLocal(); reRenderAll(); 
            } 
        }
    });
    termsSortable=Sortable.create(document.getElementById('termsList'),{ animation:150, handle:'.drag-handle', onEnd: (evt) => onSortEnd(jsonData.terms, evt) });
    infoSortable=Sortable.create(document.getElementById('infoImagesList'),{ 
        animation:150, 
        handle:'.drag-handle', 
        onEnd: (evt) => onSortEnd(jsonData.infoImages, evt) 
    });
     signatureSortable=Sortable.create(document.getElementById('signatureBlocksContainer'), {
        animation: 150,
        handle: '.drag-handle',
        onEnd: (evt) => {
            const parent = evt.from;
            const item = parent.children[evt.oldIndex];
            const other = parent.children[evt.newIndex];
            if (evt.oldIndex > evt.newIndex) {
               parent.insertBefore(item, other);
            } else {
               parent.insertBefore(item, other.nextSibling);
            }
        }
    });
}

let activeEditingElement = null;
function makeEditable(){
    document.querySelectorAll('.editable').forEach(el=> {
        el.removeEventListener('input', onEditableInput); 
        el.removeEventListener('blur', onEditableBlur);
        el.addEventListener('input', onEditableInput);
        el.addEventListener('blur', onEditableBlur);
    });
}

function onEditableInput(e){
    const target = e.target; 
    const field=target.dataset.field;

    if (field && (field.endsWith('Heading') || field.endsWith('Header') || field.endsWith('Label') || field === 'quoteTitle')) {
        if (!jsonData.quote.labels) jsonData.quote.labels = {};
        jsonData.quote.labels[field] = target.textContent;
        saveToLocal();
        if (field.includes('Price')) updatePriceHeaders();
        if (field === 'quoteTitle') updateDocumentTitle();
        return;
    }

    if(!field) { 
        const id=target.id;
        if(id === 'companyA' || id === 'companyB') {
            const lines = target.innerHTML.split(/<br\s*\/?>/gi).map(line => line.trim()).filter(Boolean); 
            let data = {};
            lines.forEach((line, index) => { data[`line${index + 1}`] = line; }); 
            jsonData[id] = data;
            if (id === 'companyA') updatePdfFileNameInput();
        }
        else if(id === 'reference' || id === 'quoteNumber'){
            jsonData.quote[id]=target.textContent;
            updateDocumentTitle();
        } 
        else if (id === 'signatureDate') { jsonData.signature.date = target.innerHTML; }
        else { jsonData.quote[id] = target.textContent; }
        saveToLocal(); return;
    }

    if(field === 'term'){ jsonData.terms[target.dataset.index] = target.innerHTML; saveToLocal(); return; }

    if (field.startsWith('signature')) {
        if(field === 'signatureLessorLine') jsonData.signature.lessorLine = target.innerHTML;
        if(field === 'signatureLesseeLine') jsonData.signature.lesseeLine = target.innerHTML;
        if(field === 'signatureLessorText') jsonData.signature.lessorText = target.innerHTML;
        if(field === 'signatureLesseeText') jsonData.signature.lesseeText = target.innerHTML;
        saveToLocal();
        return;
    }

    const {item: cId, index: idx, includedIndex: sIdx} = target.dataset;
    const arr = (cId === 'itemsList') ? jsonData.items : jsonData.optionalItems; if(!arr[idx])return;
    let item = sIdx !== undefined ? arr[idx].subItems[sIdx] : arr[idx]; if (!item) return;
    
    let val = target.classList.contains('p-editable') || field.includes('Description') || field === 'vendorNotes' ? target.innerHTML : target.textContent;

    if(field === "itemNumber" || field === "subItemNumber") {
        item[field] = val; 
    } else if (field === 'marginPercentage') {
        const marginValue = parseFloat(val.replace(/[+%]/g, ''));
        if (!isNaN(marginValue)) item.marginPercentage = marginValue;
    } else if (field === 'originalPriceAndCurrency') {
        const match = val.match(/([0-9.,]+)\s*([a-zA-Z]{3})/);
        if (match){
            const price = parseFloat(match[1].replace(',','.')); const currency = match[2].toUpperCase();
            if(!isNaN(price) && currency.length === 3){
                if(sIdx !== undefined){ item.subItemOriginalPrice = price; item.currencyOrigin = currency; }
                else { item.originalPrice = price; item.currencyOrigin = currency; }
            }
        }
    } else if (field === 'targetPrice' || field === 'subItemTargetPrice') {
        // Handle manual price entry: Reverse calculate originalPrice
        const valFloat = parseFloat(val.replace(/[^0-9.-]/g, ''));
        if (!isNaN(valFloat)) {
            const qty = (sIdx !== undefined ? item.subItemQuantity : item.quantity) || 1;
            if (sIdx !== undefined) {
                item.subItemTargetPrice = valFloat;
                item.subItemOriginalPrice = valFloat / qty;
            } else {
                item.targetPrice = valFloat;
                item.originalPrice = valFloat / qty;
            }
        }
    } else if (field.includes('Description') || field === 'vendorNotes'){ item[field] = target.innerHTML.replace(/<br\s*\/?>/gi,'\n');
    } else { item[field] = val.replace(/<span.*>.*<\/span>$/, '').trim(); } 
    
    saveToLocal();
    if (field === 'marginPercentage' || field === 'originalPriceAndCurrency' || field === 'targetPrice' || field === 'subItemTargetPrice') {
        updatePrices(); 
        calculateTotalPrice();
        updateLiveDOMPrices(cId, idx, sIdx);
    }
}

function onEditableBlur(e) {
    activeEditingElement = null;
    hideFormattingToolbar();
    const field = e.target.dataset.field;
    if (field === 'originalPriceAndCurrency' || field === 'marginPercentage' || field === 'targetPrice' || field === 'subItemTargetPrice') {
        reRenderAll();
    }
}
function updateLiveDOMPrices(containerId, mainIndex, subIndex) {
    const arr = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    if (!arr[mainIndex]) return;
    const item = (subIndex !== undefined) ? arr[mainIndex].subItems[subIndex] : arr[mainIndex];
    if (!item) return;

    const priceField = (subIndex !== undefined) ? 'subItemTargetPrice' : 'targetPrice';
    const selector = `[data-item="${containerId}"][data-index="${mainIndex}"]` + (subIndex !== undefined ? `[data-included-index="${subIndex}"]` : '') + ` div[data-field="${priceField}"] span`;
    const priceSpan = document.querySelector(selector);
    if(priceSpan) priceSpan.textContent = formatPrice((item[priceField] || 0));
}
function buildFileName(ref, version){ const datePart= new Date().toISOString().slice(2,10).replace(/-/g,''); const safeRef = (ref||'').trim().replace(/[^\w\s\-]/gi, '').replace(/\s+/g,'-').substring(0, 50); return `${safeRef || 'offert'}_${datePart}_v${version}.json`; }
function doDownloadJson(fileName){ const dl=document.createElement('a'); dl.href = "data:text/plain;charset=utf-8," + encodeURIComponent(encryptCaesar(JSON.stringify(jsonData,null,2), caesarShift)); dl.download = fileName; document.body.appendChild(dl); dl.click(); dl.remove(); }
document.getElementById('saveJson').addEventListener('click',()=>{ if (checkQuoteDate(true)) { doDownloadJson(buildFileName(jsonData.quote.reference,1)); } });

function copyJsonToClipboard(){
    const dataToCopy = JSON.parse(JSON.stringify(jsonData));
    if (dataToCopy.infoImages) {
        dataToCopy.infoImages.forEach(img => { if(img.type === 'image') delete img.src });
    }
    navigator.clipboard.writeText(JSON.stringify(dataToCopy, null, 2)).then(() => {
        const msgEl = document.getElementById('statusMessage');
        msgEl.textContent = translations[currentLanguage].statusJsonCopied;
        setTimeout(() => { msgEl.textContent = '' }, 3000);
    });
}
document.getElementById('printBtn').addEventListener('click', () => { if (checkQuoteDate(true)) { window.print(); } });
function saveToLocal(){ localStorage.setItem('quoteData', encryptCaesar(JSON.stringify(jsonData), caesarShift)); }

window.onload=()=>{ 
    loadQuoteData(jsonData); 
    fetchLiveCurrencyRates();
    setupLogo();

    const compressChk = document.getElementById('compressImagesChk');
    const compressOpts = document.getElementById('compressionOptions');
    const toggleCompressionOpts = () => {
        compressOpts.style.display = compressChk.checked ? 'inline-flex' : 'none';
    };
    compressChk.addEventListener('change', toggleCompressionOpts);
    toggleCompressionOpts();
};

function updateMultiCurrencyInputsFromLiveRates(overwriteManual = false) {
    const usdInput = document.getElementById('usdRateInput');
    const eurInput = document.getElementById('eurRateInput');
    const currentJsonUsd = parseFloat(jsonData.quote.usdToSekRate).toFixed(2);
    const currentJsonEur = parseFloat(jsonData.quote.eurToSekRate).toFixed(2);

    if (window.liveExchangeRates.usd !== null) {
        const liveUsdRateWithMargin = (parseFloat(window.liveExchangeRates.usd) + 0.4).toFixed(2);
        if (overwriteManual || parseFloat(usdInput.value).toFixed(2) === currentJsonUsd || usdInput.value === "") { 
             usdInput.value = liveUsdRateWithMargin;
             jsonData.quote.usdToSekRate = parseFloat(liveUsdRateWithMargin);
        }
    }
    if (window.liveExchangeRates.eur !== null) {
        const liveEurRateWithMargin = (parseFloat(window.liveExchangeRates.eur) + 0.4).toFixed(2);
         if (overwriteManual || parseFloat(eurInput.value).toFixed(2) === currentJsonEur || eurInput.value === "") {
            eurInput.value = liveEurRateWithMargin;
            jsonData.quote.eurToSekRate = parseFloat(liveEurRateWithMargin);
        }
    }
    if (jsonData.quote.useMultipleCurrencies && (parseFloat(jsonData.quote.usdToSekRate).toFixed(2) !== currentJsonUsd || parseFloat(jsonData.quote.eurToSekRate).toFixed(2) !== currentJsonEur ) ) { 
        saveToLocal(); 
        reRenderAll(); 
    }
}

async function fetchLiveCurrencyRates() {
    const container = document.getElementById('liveCurrencyRates');
    container.innerHTML = 'Laddar kurser...';
    let displayHtml = [];

    const fetchRate = async (base) => {
        for (let i = 0; i < 10; i++) { 
            const date = new Date(); date.setDate(date.getDate() - i); const dateStr = date.toISOString().split("T")[0];
            try {
                const res = await fetch(`https://${dateStr}.currency-api.pages.dev/v1/currencies/${base.toLowerCase()}.json`); 
                if (!res.ok) continue;
                const data = await res.json(); 
                const rate = data?.[base.toLowerCase()]?.['sek'];
                if (rate) {
                    window.liveExchangeRates[base.toLowerCase()] = parseFloat(rate);
                    return `1 ${base.toUpperCase()} = ${parseFloat(rate).toFixed(2)} SEK (${dateStr.slice(5)})`;
                }
            } catch (err) { console.warn(`Failed to fetch ${base} for ${dateStr}:`, err); continue; }
        }
        return `Kurs för ${base.toUpperCase()} otillgänglig`;
    };

    displayHtml = await Promise.all(['usd', 'eur'].map(fetchRate));
    container.innerHTML = displayHtml.join('<br/>');
    if (jsonData.quote.useMultipleCurrencies) { 
      updateMultiCurrencyInputsFromLiveRates(false); 
    }
}


document.addEventListener('DOMContentLoaded', function () {
    const savePdfBtn = document.getElementById('savePdfBtn');
    savePdfBtn.addEventListener('click', async () => {
        if (!checkQuoteDate(true)) return;
        const bodyEl = document.body;
        const wasInVendorMode = bodyEl.classList.contains('vendor-print-mode');
        if (wasInVendorMode) {
            bodyEl.classList.remove('vendor-print-mode');
        }
        
        let container;
        try {
            const quoteContent = document.getElementById('quoteContent'); if (!quoteContent) return alert("Innehåll saknas.");
            const clone = quoteContent.cloneNode(true); clone.querySelectorAll('.screen-only').forEach(el => el.style.display = 'none');
            createHiddenJsonDiv(clone); 
            container = document.createElement('div'); container.style.cssText = 'position:fixed; left:-9999px; top:0; width:210mm;';
            container.appendChild(clone); document.body.appendChild(container);
            
            const fileName = document.getElementById('pdfFileNameInput').value || buildPdfFileName();

            await html2pdf().set({ margin: 10, filename: fileName, image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollX: 0, scrollY: 0, windowWidth: document.documentElement.scrollWidth, windowHeight: document.documentElement.scrollHeight },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(clone).save();
        } catch (err) { 
            console.error("PDF generation failed:", err); 
        } finally { 
            if (wasInVendorMode) {
                bodyEl.classList.add('vendor-print-mode');
            }
            if(container) container.remove(); 
        }
    });

    document.addEventListener('keydown', function(event) {
        if ((event.ctrlKey || event.metaKey) && event.key === 's') {
            event.preventDefault();
            if (jsonData && jsonData.quote && typeof buildFileName === 'function' && typeof doDownloadJson === 'function') {
                if (checkQuoteDate(true)) {
                    doDownloadJson(buildFileName(jsonData.quote.reference, 1));
                }
            } else {
                console.warn("Cannot save: jsonData or helper functions not ready.");
            }
        }
         if (event.ctrlKey || event.metaKey) { 
            if (event.key.toLowerCase() === 'b' && document.activeElement.isContentEditable) { event.preventDefault(); document.execCommand('bold'); }
            if (event.key.toLowerCase() === 'i' && document.activeElement.isContentEditable) { event.preventDefault(); document.execCommand('italic'); }
        }
    });

    document.addEventListener('touchstart', function(e) {
        const activeContainers = document.querySelectorAll('.input-container.mobile-active');
        const tappedContainer = e.target.closest('.input-container');

        activeContainers.forEach(container => {
            if (container !== tappedContainer) {
                container.classList.remove('mobile-active');
            }
        });

        if (tappedContainer) {
            tappedContainer.classList.add('mobile-active');
        }
    }, { passive: true });
});

function updatePrintMultiplier(){ 
    const multiplierSpan = document.getElementById('multiplierValue');
    if (!multiplierSpan) return;

    if (jsonData.quote.useMultipleCurrencies) {
        let ratesText = [];
        if (jsonData.quote.usdToSekRate) ratesText.push(`USD: ${parseFloat(jsonData.quote.usdToSekRate).toFixed(2)}`);
        if (jsonData.quote.eurToSekRate) ratesText.push(`EUR: ${parseFloat(jsonData.quote.eurToSekRate).toFixed(2)}`);
        multiplierSpan.textContent = ratesText.length > 0 ? `Kurser: ${ratesText.join(', ')} SEK` : "Multipla kurser aktiva";
    } else {
        multiplierSpan.textContent = `Valutakurs: ${jsonData.quote.currencyMultiplicator ?? 1}`; 
    }
}

window.addEventListener('load', () => { 
    const q = jsonData.quote;
    q.language = q.language || currentLanguage; q.customCurrency = q.customCurrency || '';
    q.useCustomCurrency = q.useCustomCurrency === undefined ? !!q.customCurrency : q.useCustomCurrency;
    currentLanguage = q.language;
    document.getElementById('customCurrencyInput').value = q.customCurrency;
    document.getElementById('useCustomCurrencyChk').checked = q.useCustomCurrency;
    document.getElementById('useCustomCurrencyChk').dispatchEvent(new Event('change')); 
    
    document.getElementById('useMultipleCurrenciesChk').checked = q.useMultipleCurrencies;
    toggleMultipleCurrencyUI(q.useMultipleCurrencies);
    document.getElementById('usdRateInput').value = parseFloat(q.usdToSekRate || 10.50).toFixed(2);
    document.getElementById('eurRateInput').value = parseFloat(q.eurToSekRate || 11.50).toFixed(2);

    document.getElementById('addSignatureCheck').checked = q.showSignature;
    document.getElementById('addSignatureCheck').dispatchEvent(new Event('change'));
    
    document.getElementById('toggleTillSectionChk').checked = q.showTillSection;
    applyTillSectionVisibility();

    updatePrintMultiplier();
    setupFormattingToolbar();
    reRenderAll(); 
});
document.getElementById('uploadPdfBtn').addEventListener('click', () => document.getElementById('pdfUploadInput').click());
document.getElementById('pdfUploadInput').addEventListener('change', async function(ev) {
  const file = ev.target.files[0]; if (!file) return;
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let fullText = '';
  for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const content = await page.getTextContent(); fullText += content.items.map(it => it.str).join(''); }
  const start = fullText.indexOf('{"quote"'); const end = fullText.lastIndexOf('}');
  if (start >= 0 && end > start) { 
    try { 
        let extractedJson = fullText.substring(start, end + 1);
        try {
            loadQuoteData(JSON.parse(extractedJson), file.name);
        } catch (e) {
            extractedJson = decryptCaesar(extractedJson, caesarShift);
            loadQuoteData(JSON.parse(extractedJson), file.name);
        }
        saveToLocal(); 
    } catch (err) { alert('Fel vid avkodning av PDF-data: ' + err); }
  } else { alert('Ingen inbäddad offertdata hittades i PDF-filen.'); }
});

// --- Formatting & Hierarchy Logic ---
const toolbar = document.getElementById('formatting-toolbar');
function setupFormattingToolbar() {
    document.addEventListener('selectionchange', () => {
        const selection = window.getSelection();
        if (selection.rangeCount > 0 && !selection.isCollapsed) {
            const range = selection.getRangeAt(0);
            const parentEditable = range.startContainer.parentElement.closest('.editable');
            if (parentEditable && parentEditable.isContentEditable) { 
                const rect = range.getBoundingClientRect();
                toolbar.style.left = `${rect.right + window.scrollX + 5}px`;
                toolbar.style.top = `${rect.top + window.scrollY}px`;
                toolbar.style.display = 'flex';
                return;
            }
        }
        hideFormattingToolbar();
    });

    document.getElementById('bold-btn').addEventListener('mousedown', (e) => { e.preventDefault(); document.execCommand('bold'); });
    document.getElementById('italic-btn').addEventListener('mousedown', (e) => { e.preventDefault(); document.execCommand('italic'); });
    document.getElementById('bullet-btn').addEventListener('mousedown', (e) => { e.preventDefault(); toggleListStyle('•'); });
    document.getElementById('dash-btn').addEventListener('mousedown', (e) => { e.preventDefault(); toggleListStyle('-'); });
    document.getElementById('ul-btn').addEventListener('mousedown', (e) => { e.preventDefault(); document.execCommand('insertUnorderedList'); });
    document.getElementById('ol-btn').addEventListener('mousedown', (e) => { e.preventDefault(); document.execCommand('insertOrderedList'); });
}
function hideFormattingToolbar() {
    if (toolbar) toolbar.style.display = 'none';
}

function toggleListStyle(prefix) {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const tempDiv = document.createElement('div');
    tempDiv.appendChild(range.cloneContents());

    let html = tempDiv.innerHTML;
    const fullPrefix = prefix + ' ';
    const regex = new RegExp(`^${prefix}\\s?`, 'gm');

    const isPrefixed = html.split(/<br\s*\/?>/g).find(line => line.trim() !== '')?.trim().startsWith(prefix);

    let newHtml;
    if (isPrefixed) {
        newHtml = html.split(/<br\s*\/?>/g).map(line => line.replace(regex, '')).join('<br>');
    } else {
        newHtml = html.split(/<br\s*\/?>/g).map(line => {
            const trimmed = line.trim();
            return trimmed ? fullPrefix + trimmed : line;
        }).join('<br>');
    }

    document.execCommand('insertHTML', false, newHtml);
}


function mapItemToSubItem(item) {
    return {
        subItemName: item.name,
        subItemDescription: item.itemDescription,
        subItemQuantity: item.quantity,
        subItemOriginalPrice: item.originalPrice,
        marginPercentage: item.marginPercentage,
        currencyOrigin: item.currencyOrigin,
        subItems: item.subItems || [],
        isPriceBakedIn: false,
        isHiddenFromPrint: false,
        vendorNotes: item.vendorNotes || "",
    };
}
function mapSubItemToItem(subItem) {
    return {
        name: subItem.subItemName,
        itemDescription: subItem.subItemDescription,
        quantity: subItem.subItemQuantity,
        originalPrice: subItem.subItemOriginalPrice,
        marginPercentage: subItem.marginPercentage,
        currencyOrigin: subItem.currencyOrigin,
        subItems: subItem.subItems || [] ,
        isPriceBakedIn: false,
        isHiddenFromPrint: false,
        vendorNotes: subItem.vendorNotes || "",
    };
}


function toggleItemHierarchy(containerId, mainIndex, subIndex) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    if (subIndex !== undefined) { 
        const [subItem] = list[mainIndex].subItems.splice(subIndex, 1);
        const newMainItem = mapSubItemToItem(subItem);
        list.splice(mainIndex + 1, 0, newMainItem);
    } else { 
        if (mainIndex > 0) {
            const [itemToMove] = list.splice(mainIndex, 1);
            const parentItem = list[mainIndex - 1];
            if (!parentItem.subItems) parentItem.subItems = [];
            
            const newSubItem = mapItemToSubItem(itemToMove);
            parentItem.subItems.push(newSubItem);
        } else {
            alert("Första artikeln kan inte göras om till en underpost utan en huvudpost ovanför.");
        }
    }
    saveToLocal();
    reRenderAll();
}

function renumberAllItems() {
    const processList = (list, prefix, isOptional, isTopLevel) => {
        let itemCounter = 0;
        (list || []).filter(it => it.type !== 'separator').forEach(item => {
            itemCounter++;
            let baseNumber;
            if (isTopLevel) {
                baseNumber = (isOptional ? 'A' : '') + itemCounter + ".1";
                item.itemNumber = baseNumber;
            } else {
                baseNumber = prefix + "." + itemCounter;
                item.subItemNumber = baseNumber;
            }

            if (item.subItems && item.subItems.length > 0) {
                processList(item.subItems, baseNumber, false, false);
            }
        });
    };

    processList(jsonData.items, '', false, true);
    processList(jsonData.optionalItems, '', true, true);
    saveToLocal();
}

function toggleItemOptionality(containerId, mainIndex) {
    const sourceList = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    const destinationList = (containerId === 'itemsList') ? jsonData.optionalItems : jsonData.items;
    
    if (sourceList[mainIndex]) {
        const [movedItem] = sourceList.splice(mainIndex, 1);
        destinationList.push(movedItem); 
        saveToLocal();
        reRenderAll(); 
    }
}

function moveItemUp(containerId, index) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    if (index > 0) {
        [list[index], list[index - 1]] = [list[index - 1], list[index]];
        saveToLocal();
        reRenderAll(); 
    }
}
function moveItemDown(containerId, index) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    if (index < list.length - 1) {
        [list[index], list[index + 1]] = [list[index + 1], list[index]];
        saveToLocal();
        reRenderAll(); 
    }
}
function moveSubItemUp(containerId, mainIndex, subIndex) {
    const parentItem = (containerId === 'itemsList') ? jsonData.items[mainIndex] : jsonData.optionalItems[mainIndex];
    if (parentItem && parentItem.subItems && subIndex > 0) {
        const subList = parentItem.subItems;
        [subList[subIndex], subList[subIndex - 1]] = [subList[subIndex - 1], subList[subIndex]];
        saveToLocal();
        reRenderAll(); 
    }
}
function moveSubItemDown(containerId, mainIndex, subIndex) {
    const parentItem = (containerId === 'itemsList') ? jsonData.items[mainIndex] : jsonData.optionalItems[mainIndex];
    if (parentItem && parentItem.subItems) {
        const subList = parentItem.subItems;
        if (subIndex < subList.length - 1) {
            [subList[subIndex], subList[subIndex + 1]] = [subList[subIndex + 1], subList[subIndex]];
            saveToLocal();
            reRenderAll(); 
        }
    }
}

function moveTermUp(idx){
    if(idx > 0 && jsonData.terms){
        [jsonData.terms[idx], jsonData.terms[idx-1]] = [jsonData.terms[idx-1], jsonData.terms[idx]];
        saveToLocal();
        reRenderAll();
    }
}
function moveTermDown(idx){
    if(jsonData.terms && idx < jsonData.terms.length - 1){
        [jsonData.terms[idx], jsonData.terms[idx+1]] = [jsonData.terms[idx+1], jsonData.terms[idx]];
        saveToLocal();
        reRenderAll();
    }
}

function adjustImageSize(index, factor) {
    if (jsonData.infoImages && jsonData.infoImages[index] && jsonData.infoImages[index].type === 'image') {
        const imgData = jsonData.infoImages[index];
        let currentWidth = parseFloat(imgData.width) || 400;
        let newWidth = currentWidth * factor;
        if (newWidth < 50) newWidth = 50;
        imgData.width = newWidth;
        saveToLocal();
        reRenderAll();
    }
}

function addSubItemToParent(containerId, parentIndex) {
    const parentList = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    const parentItem = parentList[parentIndex];
    if (parentItem) {
        if (!parentItem.subItems) {
            parentItem.subItems = [];
        }
        const newSubItem = {
            subItemName: translations[currentLanguage].newSubItemName,
            subItemDescription: translations[currentLanguage].newSubItemDescription,
            subItemQuantity: 1,
            subItemOriginalPrice: 0,
            marginPercentage: 0,
            isPriceBakedIn: false,
            isHiddenFromPrint: false,
            vendorNotes: "",
        };
        parentItem.subItems.push(newSubItem);
        saveToLocal();
        reRenderAll();
    }
}

function removeAllSubItems(containerId, parentIndex) {
    const parentList = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    const parentItem = parentList[parentIndex];
    if (parentItem && parentItem.subItems && parentItem.subItems.length > 0) {
        if (confirm(`Är du säker på att du vill ta bort alla underposter för "${parentItem.name}"?`)) {
            parentItem.subItems = [];
            saveToLocal();
            reRenderAll();
        }
    }
}

function applyTillSectionVisibility() {
    const show = document.getElementById('toggleTillSectionChk').checked;
    const tillWrapper = document.getElementById('companyA_wrapper');
    const swapButton = document.getElementById('swapButton');
    const quoteSection = document.getElementById('quoteSection');
    
    tillWrapper.style.display = show ? '' : 'none';
    swapButton.style.display = show ? '' : 'none';
    quoteSection.style.justifyContent = show ? 'space-between' : 'flex-end';
}
function toggleBakeInPrice(containerId, index) {
    if (containerId !== 'itemsList') return;
    const item = jsonData.items[index];
    item.isPriceBakedIn = !item.isPriceBakedIn;
    saveToLocal();
    reRenderAll();
}

function toggleBakeInSubItemPrice(containerId, mainIndex, subIndex) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    const subItem = list[mainIndex]?.subItems?.[subIndex];
    if (subItem) {
        subItem.isPriceBakedIn = !subItem.isPriceBakedIn;
        saveToLocal();
        reRenderAll();
    }
}

function toggleHiddenFromPrint(containerId, index) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    const item = list[index];
    if (item) {
        item.isHiddenFromPrint = !item.isHiddenFromPrint;
        saveToLocal();
        reRenderAll();
    }
}

function toggleHiddenFromPrintSubItem(containerId, mainIndex, subIndex) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    const subItem = list[mainIndex]?.subItems?.[subIndex];
    if (subItem) {
        subItem.isHiddenFromPrint = !subItem.isHiddenFromPrint;
        saveToLocal();
        reRenderAll();
    }
}


function applySectionVisibility() {
    const visibility = jsonData.quote.visibility || {};
    document.getElementById('optionalSectionContainer').style.display = visibility.optional ? '' : 'none';
    document.getElementById('infoSectionContainer').style.display = visibility.info ? '' : 'none';
    document.getElementById('termsSectionContainer').style.display = visibility.terms ? '' : 'none';
}

function updateSectionVisibilityCheckboxes() {
    const visibility = jsonData.quote.visibility || {};
    document.getElementById('showOptionalSectionChk').checked = !!visibility.optional;
    document.getElementById('showInfoSectionChk').checked = !!visibility.info;
    document.getElementById('showTermsSectionChk').checked = !!visibility.terms;
}

document.getElementById('sectionVisibilityControls').addEventListener('change', (e) => {
    if (e.target.type === 'checkbox') {
        const section = e.target.dataset.section;
        if (section && jsonData.quote.visibility.hasOwnProperty(section)) {
            jsonData.quote.visibility[section] = e.target.checked;
            saveToLocal();
            applySectionVisibility();
        }
    }
});

function setupLogo() {
    const logoContainer = document.getElementById('logoContainer');
    const logoImg = document.getElementById('companyLogo');
    const removeBtn = document.getElementById('removeLogoBtn');
    const uploadBtn = document.getElementById('uploadLogoBtn');
    const fileInput = document.getElementById('logoUpload');
    const resizeHandle = logoContainer.querySelector('.image-resize-handle');
    const resetBtn = document.getElementById('resetLogoSizeBtn');

    const savedLogo = localStorage.getItem('companyLogo');
    const manualWidth = localStorage.getItem('logoWidth');
    const defaultWidth = jsonData.quote.defaultLogoWidth || 200;

    if (savedLogo) {
        logoImg.src = savedLogo;
        logoContainer.style.display = 'inline-block';
        uploadBtn.style.display = 'none';
        logoImg.style.width = (manualWidth || defaultWidth) + 'px';
    } else if (logoImg.getAttribute('src')) {
        logoContainer.style.display = 'inline-block';
        uploadBtn.style.display = 'none';
        logoImg.style.width = (manualWidth || defaultWidth) + 'px';
    } else {
        logoContainer.style.display = 'none';
        uploadBtn.style.display = 'inline-block';
    }

    removeBtn.addEventListener('click', () => {
        logoImg.src = '';
        localStorage.removeItem('companyLogo');
        localStorage.removeItem('logoWidth');
        logoContainer.style.display = 'none';
        uploadBtn.style.display = 'inline-block';
    });

    resetBtn.addEventListener('click', () => {
        localStorage.removeItem('logoWidth');
        logoImg.style.width = (jsonData.quote.defaultLogoWidth || 200) + 'px';
    });

    uploadBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const dataUrl = event.target.result;
                logoImg.src = dataUrl;
                localStorage.setItem('companyLogo', dataUrl);
                logoContainer.style.display = 'inline-block';
                uploadBtn.style.display = 'none';
                localStorage.removeItem('logoWidth');
                logoImg.style.width = (jsonData.quote.defaultLogoWidth || 200) + 'px';
            };
            reader.readAsDataURL(file);
        }
    });

    initializeResize(resizeHandle, logoImg, 'logo');
}

document.getElementById('showBakedItemPrices').addEventListener('change', function() {
    document.body.classList.toggle('show-baked-item-prices', this.checked);
});
document.getElementById('showBakedSubItemPrices').addEventListener('change', function() {
    document.body.classList.toggle('show-baked-subitem-prices', this.checked);
});
document.getElementById('vendorModeCheck').addEventListener('change', function() {
    document.body.classList.toggle('vendor-print-mode', this.checked);
});

document.getElementById('saveJsonUnencrypted').addEventListener('click', () => {
    if (!checkQuoteDate(true)) return;
    const fileName = buildFileName(jsonData.quote.reference, 1).replace('.json', '_unencrypted.json');
    const dl = document.createElement('a');
    dl.href = "data:text/plain;charset=utf-8," + encodeURIComponent(JSON.stringify(jsonData, null, 2));
    dl.download = fileName;
    document.body.appendChild(dl);
    dl.click();
    dl.remove();
});

document.getElementById('saveJsonUnencryptedNoImg').addEventListener('click', () => {
    if (!checkQuoteDate(true)) return;
    const dataToSave = JSON.parse(JSON.stringify(jsonData));
    if (dataToSave.infoImages) {
        dataToSave.infoImages.forEach(img => {
            if (img.type === 'image' && img.src) {
                img.src = `DELETED_FOR_EXPORT_SIZE:${(img.src.length / 1024).toFixed(1)}kB`;
            }
        });
    }
    const fileName = buildFileName(jsonData.quote.reference, 1).replace('.json', '_unencrypted_no-images.json');
    const dl = document.createElement('a');
    dl.href = "data:text/plain;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToSave, null, 2));
    dl.download = fileName;
    document.body.appendChild(dl);
    dl.click();
    dl.remove();
});

function getTodaysDateString() {
    return new Date().toLocaleDateString('sv-SE');
}

function checkQuoteDate(isAction = false) {
    const warningContainer = document.getElementById('dateWarningContainer');
    const warningText = document.getElementById('dateWarningText');
    const quoteDateStr = document.getElementById('quoteDate').textContent.trim();
    const todayStr = getTodaysDateString();

    if (!quoteDateStr || quoteDateStr === todayStr) {
        warningContainer.style.display = 'none';
        return true;
    }

    warningText.textContent = `Offertens datum (${quoteDateStr}) är inte dagens datum.`;
    warningContainer.style.display = 'block';

    const quoteDateParts = quoteDateStr.split('-').map(Number);
    const quoteDate = new Date(quoteDateParts[0], quoteDateParts[1] - 1, quoteDateParts[2]);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const diffTime = today - quoteDate;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (isAction && diffDays > 30) {
        if (sessionStorage.getItem('dateWarningShown') !== 'true') {
            const proceed = confirm(`Varning: Offertens datum är mer än 30 dagar gammalt. Vill du fortsätta?`);
            if (proceed) {
                sessionStorage.setItem('dateWarningShown', 'true');
                return true;
            } else {
                return false;
            }
        }
    }
    return true;
}

document.getElementById('updateDateBtn').addEventListener('click', () => {
    const todayStr = getTodaysDateString();
    document.getElementById('quoteDate').textContent = todayStr;
    jsonData.quote.date = todayStr;
    saveToLocal();
    checkQuoteDate();
});

// --- New Features Logic ---
document.getElementById('marginModeChk').addEventListener('change', function() {
    jsonData.quote.marginCalculationMode = this.checked ? 'margin' : 'markup';
    saveToLocal();
    reRenderAll();
});

function updateMarginLabel() {
    const isMarginMode = document.getElementById('marginModeChk').checked;
    const label = document.getElementById('marginLabel');
    const t = translations[currentLanguage];
    label.textContent = isMarginMode ? t.marginLabel : t.markupLabel;
}

function toggleInfoItemCentering(index) {
    const item = jsonData.infoImages[index];
    if (!item) return;
    const current = item.centering || 'center';
    // Cycle: left -> center -> left
    if (current === 'left') {
        item.centering = 'center';
    } else {
        item.centering = 'left';
    }
    saveToLocal();
    reRenderAll();
}

// --- Cropper Logic ---
function openCropper(index) {
    const imgObj = jsonData.infoImages[index];
    if (!imgObj || imgObj.type !== 'image') return;
    
    currentCropIndex = index;
    const modal = document.getElementById('cropperModal');
    const imageElement = document.getElementById('imageToCrop');
    
    imageElement.src = imgObj.src;
    modal.style.display = 'block';
    
    if (cropper) {
        cropper.destroy();
    }
    cropper = new Cropper(imageElement, {
        viewMode: 1,
        autoCropArea: 1,
    });
}

function closeCropperModal() {
    document.getElementById('cropperModal').style.display = 'none';
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    currentCropIndex = -1;
}

function saveCroppedImage() {
    if (!cropper || currentCropIndex === -1) return;
    
    const canvas = cropper.getCroppedCanvas();
    if (canvas) {
        const croppedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
        jsonData.infoImages[currentCropIndex].src = croppedDataUrl;
        saveToLocal();
        reRenderAll();
        closeCropperModal();
    }
}

// --- Smart Layout Logic ---
function autoLayoutImages() {
    if (!jsonData.infoImages) return;
    
    let imageIndices = [];
    jsonData.infoImages.forEach((item, idx) => {
        if (item.type === 'image') imageIndices.push(idx);
    });
    
    for (let i = 0; i < imageIndices.length; i++) {
        const item = jsonData.infoImages[imageIndices[i]];
        item.width = 340; 
        item.centering = 'left'; 
    }
    
    saveToLocal();
    reRenderAll();
    alert("Smart Layout: Bilder har justerats för att passa 2 per rad.");
}

</script>
</body>
</html>
