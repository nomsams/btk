<!-- Version 84 -- Sub-item Price Baking, Bullet Points -->
<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8"/>
<title>Offert</title>
<style>
/* ------------------ PRINT STYLES ------------------ */
@media print {
    @page { size: A4; margin: 10mm; }
    body { font-family: 'Arial', sans-serif; font-size: 10.5pt; line-height: 1.2; }
    body * { visibility: hidden; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    #quoteContent, #quoteContent * { visibility: visible; }
    #quoteContent { position: absolute; left: 0; top: 0; width: 100%; padding: 0; margin: 0; }
    b { font-weight: bold; }
    i { font-style: italic; }
    .print-only { display: block !important; }
    #printMultiplier { position: relative !important; bottom: auto !important; right: auto !important; margin-top: 1mm !important; font-size: 8pt !important; color: white !important; text-align: right; width:100%; }
    .quote-section { margin: 5mm 0; page-break-inside: avoid !important; }

    /* Print alignment: Nr(50px) Name(1fr) Qty(80px) Price(100px) Gap(5mm) */
    .item-header, .item-meta {
        display: grid;
        grid-template-columns: 50px 1fr 80px 100px; /* Main item columns for print */
        gap: 5mm;
        align-items: start;
        padding-bottom: 1.5mm;
    }
    .item-header {
        border-bottom: 1pt solid #000;
        margin-top: 3mm;
        font-weight: bold;
    }
     .item-header > div, .item-meta > div {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    .item-number { text-align: left; }
    .item-name { text-align: left; }
    .quantity, .quantity-header { text-align: center; justify-content: center; padding-right:0; }
    .targetPrice, .price-header, .subItemTargetPrice { text-align: right; justify-content: flex-end; padding-right: 2mm; box-sizing: border-box; }

    .included-item {
        background-color: rgba(248, 248, 248, 0.85) !important;
        margin: 2px 0 2px 10mm !important;
        padding: 2mm !important;
        border-radius: 0 !important;
        width: calc(100% - 10mm);
        box-sizing: border-box;
    }
    .included-item .item-meta {
        margin-left: 0;
        grid-template-columns: 40px 1fr 75px 95px; /* Fine-tuned sub-item columns */
        gap: 2.5mm; /* Smaller gap for subitems */
        padding-left: 0;
    }
    .included-item.baked-in .subItemTargetPrice {
        display: none !important; /* Hide price of baked-in sub-items on print */
    }


    .item-details, .included-item .item-details {
        word-wrap: break-word !important; overflow-wrap: break-word !important;
        white-space: normal !important;
        max-width: calc(100% - (50px + 5mm)); 
        margin-left: calc(50px + 5mm); 
        margin-right: 0;
        padding: 1mm 0;
    }
     .included-item .item-details {
        margin-left: calc(40px + 2.5mm); 
        max-width: calc(100% - (40px + 2.5mm));
    }

    .term-item { margin: 0.2mm 0; padding-bottom: 0.2mm; padding-left: 0 !important; } /* Very tight terms, remove indentation for print */
    .term-item .editable { width: 100% !important; } 

    .info-text { word-wrap: break-word !important; overflow-wrap: break-word !important; }
    .total-price { margin-top: 4mm; padding-top: 2mm; border-top: 1pt solid #000; text-align: right; padding-right: 0; page-break-inside: avoid !important; }
    h3 { page-break-before: auto !important; page-break-after: avoid !important; margin-top: 6mm; margin-bottom: 3mm !important; }
    .info-image-container { page-break-inside: avoid !important; margin: 3mm 0; }
    .info-image-container img { max-width: 100% !important; height: auto !important; }
    
    .screen-only { display: none !important; }

    .controls-row .remove-icon { display: none !important; }
    #infoImagesList .info-block { padding-left: 0 !important; }
    #infoImagesList .info-block-image .info-image-container { margin-left: 0 !important; }
    #projectNumberDiv { /* Style if needed based on showProjectNumber state for print */ }
    #signatureSection { margin-top: 10mm; page-break-before: auto; }
}

@media screen {
  .print-only { display: none !important; }
}

/* ------------------ SCREEN STYLES ------------------ */
body { font-family: 'Arial', sans-serif; margin: 0; padding: 20px; max-width: 210mm; margin: auto; font-size: 12pt; background-color: #fff; }
.targetPrice span, .subItemTargetPrice span { width: 90% !important; }
.bold, b { font-weight: bold; } 
i { font-style: italic; }
.zero-text { color: white !important; }
.header { display: flex; align-items: center; justify-content: space-between; margin-top: 20px; }
.header img { max-width: 200px; margin-right: 20px; }
.quote-title { font-size: 24px; font-weight: bold; text-align: right; width: 100%; }
.quote-number, .date, .project-number { text-align: right; }
.quote-section { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: flex-start; }
.quote-section strong { display: block; margin-bottom: 2px; }
.quote-section p { margin-top: 2px; }
.swap-button { font-size: 24px; cursor: pointer; margin: 0 20px; user-select: none; }
.quote-item { position: relative; width: 100%; box-sizing: border-box; padding: 5px 0; }
.included-item { 
    position: relative; width: calc(100% - 30px); box-sizing: border-box;
    font-weight: normal; 
    background-color: rgba(249, 249, 249, 0.85); 
    margin-left: 30px; 
    margin-top: 5px; 
    margin-bottom: 5px; 
    padding: 8px; 
    border-radius: 4px; 
}
.included-item.baked-in .subItemTargetPrice span {
    color: #ccc !important; /* Make price less prominent on screen if baked in */
    text-decoration: line-through;
}
.quote-item:hover .item-actions, .included-item:hover .item-actions { display: flex; }
.item-header { display: grid; grid-template-columns: 70px minmax(200px, 1fr) 100px 120px; gap: 10px; font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 10px; margin-top: 20px; align-items: center; }
.item-header > div { padding: 5px; }
.item-meta { display: grid; grid-template-columns: 70px minmax(200px,1fr) 100px 120px; gap: 10px; align-items: center; position: relative; margin: 5px 0; padding-left: 0; }

.included-item .item-meta { 
    background-color: transparent; 
    margin-left: 0; 
    grid-template-columns: 70px minmax(170px,1fr) 100px 120px; 
    padding-left: 0; 
} 

.item-meta div { display: flex; align-items: center; padding: 5px; justify-content: flex-start; }
.item-number { text-align: left; width: 100%; user-select: text; }
.item-name { text-align: left; padding-right: 10px; word-wrap: break-word; }
.item-name.bold { font-weight: 700; } 
.subitem-name-style { font-weight: 600; } 
.baked-in-icon { margin-left: 8px; cursor: help; }

.targetPrice, .price-header, .subItemTargetPrice { text-align: right; padding-right: 15px; font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; min-width: 80px; white-space: nowrap; position: relative; justify-content: flex-end; }
.quantity, .quantity-header { text-align: center; justify-content: center; font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; min-width: 80px; white-space: nowrap; position: relative; }
.input-container { display: inline-flex; align-items: center; position: relative; }
.button-container { position: absolute; bottom: 100%; right: 0; display: none; flex-direction: row; gap: 1px; }
.input-container:hover .button-container, .input-container.mobile-active .button-container { display: flex; }
.button-container button { 
    width: 20px; height: 20px; 
    font-size: 12px; 
    line-height: 18px; 
    cursor: pointer; border: 1px solid #ccc; background-color: #f8f8f8; border-radius: 3px; display: flex; align-items: center; justify-content: center; 
}
.button-container button:hover { background-color: #e8e8e8; }
input[type="number"] { width: 60px; padding: 5px; text-align: right; border: none; background-color: transparent; font-size: 12pt; vertical-align: middle; }
input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; display: none; }
input[type="number"] { -moz-appearance: textfield; }
.item-details, .included-item .item-details { margin-top: 5px; font-weight: normal; position: relative; grid-column: 2 / 5; padding-left: 5px; padding-right: 260px; max-width: calc(100% - (70px + 10px + 260px)); word-wrap: break-word; margin-left: calc(70px + 10px); }
.included-item .item-details { 
    margin-left: calc(70px + 10px); 
    max-width: calc(100% - (70px + 10px + 260px));
}
.editable { border: 1px solid transparent; padding: 5px; width: 100%; word-wrap: break-word; }
.editable:hover { border: 1px solid #ddd; background-color: #f9f9f9; }
.editable:focus { outline: 2px solid #007bff; border-radius: 3px; background-color: #fff; }
.p-editable { white-space: pre-wrap; min-height: 1.2em; }
.terms, .footer { margin-top: 20px; }
.footer { text-align: center; }
#fileInput { margin-bottom: 20px; }
.add-button, .remove-button, .add-optional-button, .add-term-button, .footer-button { cursor: pointer; padding: 5px 10px; background-color: green; color: white; border: none; border-radius: 5px; margin: 5px; font-size: 12pt; }
.remove-button { background-color: red; }
.footer-button:hover { background-color: #45a049; }
.remove-icon { display: none; color: white; background-color: red; font-size: 16px; cursor: pointer; position: absolute; right: 10px; top: 10px; width: 20px; height: 20px; border-radius: 10px; text-align: center; line-height: 18px; }
.term-item:hover .remove-icon { display: block; }
.status-message { margin-top: 10px; font-weight: bold; color: green; font-size: 12pt; }
.total-price { text-align: right; font-weight: bold; margin-top: 20px; font-size: 12pt; padding-right: 15px; margin-right: 0; border-top: 2px solid #000; padding-top: 10px; font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; width: 100%; position: relative; }
.term-item {
    position: relative;
    padding-left: 30px; /* Space for controls */
    min-height: 30px;
    display: flex;
    align-items: center;
    margin-bottom: 1px;
}
.term-item:hover { background-color: #fafafa; }
.term-item .controls-row {
    display: none; /* Hide by default */
    position:absolute; left:2px; top: 50%; transform: translateY(-50%); flex-direction:column;
}
.term-item:hover .controls-row {
    display: inline-flex; /* Show on hover */
}
.term-item .content-wrapper { width: 100%; }
.term-item .editable { width: 100% !important; }
.reference { margin: 20px 0; }
.currency-multiplier { margin-top: 20px; margin-bottom: 20px; text-align: right; }
.currency-multiplier label { font-weight: bold; }
.currency-multiplier input { width: 60px; padding: 5px; font-size: 12pt; text-align: right; }
#multipleCurrencyRatesDiv input { width: 80px; }
#multipleCurrencyRatesDiv div { margin-bottom: 5px;}
.description-remove-icon { display: none; color: white; background-color: red; font-size: 16px; cursor: pointer; width: 20px; height: 20px; border-radius: 10px; text-align: center; line-height: 18px; position: absolute; right: 10px; top: 10px; }
.item-details:hover .description-remove-icon, .included-item:hover .description-remove-icon { display: block; }
.checkbox-group { display: flex; gap: 20px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
#optionalItemsList { margin-top: 0; padding-top: 0; }
#termsList { margin-top: 0px; padding-top: 10px;}
h3.name.editable { margin-bottom: 0 !important; }

.info-images { margin: 20px 0; }
.info-block { position: relative; min-height: 30px; box-sizing: border-box; }
#infoImagesList .info-block-image {
    display: inline-block !important; vertical-align: top !important; width: auto !important;
    margin: 0 10px 10px 0 !important; padding-left: 0;
}
#infoImagesList .info-block-fullwidth {
    display: block !important; width: 100% !important; margin: 0 0 10px !important;
    padding-left: 30px; 
}
.info-block:hover { background-color: #fafafa; }
.info-block .content-wrapper { position: relative; } 

#infoImagesList .info-block-image .info-image-container {
    display: inline-block; line-height: 0; margin: 0; position: relative;
}
#infoImagesList .info-block-image .info-image-container img {
    display: block; max-width: 100%; width: auto; height: auto; object-fit: cover; border:1px solid transparent;
}
#infoImagesList .info-block-image:hover .info-image-container img { border:1px solid #ddd; }


.info-text-block { min-height: 30px; padding: 5px; border: 1px solid transparent; }
.info-text-block:hover { background-color: #f9f9f9; border: 1px solid #ddd; }
.info-image-container img { max-width: 100%; height: auto; display: block; }

.image-resize-handle {
    width: 20px; height: 20px; background-color: rgba(255,255,255,0.8); border: 2px solid #007bff;
    border-radius: 50%; position: absolute; bottom: 5px; right: 5px;
    cursor: se-resize; z-index: 15; pointer-events: all; display:none;
}
.info-image-container:hover .image-resize-handle { display: block; }


.controls-row { display: none; align-items: center; gap: 5px; z-index: 10; background: rgba(230,230,230,0.85); padding:3px; border-radius: 3px; border:1px solid #ccc; }
.info-block:hover .controls-row { display: inline-flex; }

#infoImagesList .info-block-image .controls-row {
    position: absolute; top: 5px; right: 5px; flex-direction: row;
}
#infoImagesList .info-block-fullwidth .controls-row {
    position:absolute; left:2px; top: 50%; transform: translateY(-50%); flex-direction:column;
}

.controls-row .remove-icon { 
    position: static; display: inline-flex; align-items:center; justify-content:center;
    width: 20px; height: 20px; font-size: 14px; line-height: 20px;
}
.info-block:hover .controls-row .remove-icon { display: inline-flex; } 


.drag-handle { background-color: #333; color: white; border-radius: 50%; text-align: center; line-height: 18px; cursor: move; width:20px; height:20px; display:inline-flex; align-items:center; justify-content:center; user-select:none;}
.info-image-up, .info-image-down { border-radius: 50%; text-align: center; line-height: 18px; cursor: pointer; font-size: 16px; background-color: #f0f0f0; width:20px; height:20px; display:inline-flex; align-items:center; justify-content:center; border: 1px solid #ccc;}
.info-image-up:hover, .info-image-down:hover { background-color: #e0e0e0; }

#mainItemsSectionContainer, #optionalSectionContainer, #infoSectionContainer, #termsSectionContainer { position: relative; }
.section-remove-icon { display: none; position: absolute; left:10px; top:5px; background-color:red; width:20px; height:20px; border-radius:10px; text-align:center; line-height:18px; color:white; cursor:pointer; font-size:16px; z-index:100; }
#mainItemsSectionContainer:hover .section-remove-icon, #optionalSectionContainer:hover .section-remove-icon, #infoSectionContainer:hover .section-remove-icon, #termsSectionContainer:hover .section-remove-icon { display: block; }
.horizontal-line { border: none; border-top: 2px solid black; margin: 5px 0; width: 100%; }
.info-table { width: 100%; border-collapse: collapse; background-color: white; margin-top: 10px; }
.info-table td { border: 1px solid #ccc; padding: 8px; min-width: 50px; position: relative; }
.info-table td[contenteditable="true"]:hover { background-color: #f9f9f9; }
.info-table td[contenteditable="true"]:focus { outline: 2px solid #007bff; background-color: #fff; }
.image-upload-button { background-color: green; color: white; padding: 5px 10px; border: none; border-radius: 5px; margin: 5px; font-size: 12pt; cursor: pointer; }
.image-upload-button:hover { background-color: #45a049; }
#liveCurrencyRates { font-size: 12px !important; }
#infoImagesList { display: block !important; }

.item-meta .item-tooltip { display: none; position: absolute; top: -18px; right: 5px; background: rgba(255, 255, 255, 0.95); border-radius: 4px; padding: 2px 5px; font-size: 11px; display: flex; gap: 8px; align-items: center; z-index: 10; border: 1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.item-meta:hover .item-tooltip { display: flex; }
.item-tooltip .original-price-display, .item-tooltip .margin-display { white-space: nowrap; border: 1px solid transparent; border-radius: 3px; padding: 1px 3px; min-width: 40px; text-align: right; }
.item-tooltip .original-price-display { color: blue; }
.item-tooltip .margin-display { color: green; font-weight: bold; }
.item-tooltip .margin-display.discount { color: #b78a00; }
.item-tooltip .editable:hover { border-color: #ccc; background-color: #f9f9f9; }
.item-tooltip .editable:focus { border-color: #007bff; background-color: white; box-shadow: 0 0 0 1px #007bff; }
.item-actions { display: none; position: absolute; right: -260px; top: 50%; transform: translateY(-50%); flex-direction: row; gap: 4px; z-index: 10; }
.item-actions .control-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight:bold; }
.item-actions .control-btn:hover { background-color: #e0e0e0; border-color: #999; }
#formatting-toolbar { position: absolute; display: none; z-index: 1000; background: #333; border-radius: 5px; padding: 5px; }
#formatting-toolbar button { background: #444; color: white; border: 1px solid #555; border-radius: 3px; padding: 5px 10px; cursor: pointer; font-size: 14px; }
#formatting-toolbar button.active { background: #007bff; border-color: #0056b3; }
#formatting-toolbar button:hover { background: #555; }
#signatureSection { display: none; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; }
.signature-date { margin-bottom: 40px; }
.signature-row { display: flex; justify-content: space-between; text-align: center; }
.signature-block { width: 40%; position: relative; }
.signature-line { border-bottom: 1px solid black; min-height: 40px; margin-bottom: 5px; }
#sectionVisibilityControls { border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; }
</style>
</head>
<body>

<div id="formatting-toolbar" class="screen-only">
  <button id="bold-btn" title="Fet (Ctrl+B)"><b>B</b></button>
  <button id="italic-btn" title="Kursiv (Ctrl+I)"><i>I</i></button>
  <button id="bullet-btn" title="Punktlista">‚Ä¢</button>
</div>

<div id="quoteContent">
    <div class="header">
        <img alt="Company Logo" src="logo.png"/>
        <div class="quote-title editable" contenteditable="true" id="quoteTitle" data-field="quoteTitle">Offert</div>
    </div>
    <div class="quote-number" id="quoteNumberLabel">Offert nr:
        <span class="editable" contenteditable="true" id="quoteNumber"></span>
    </div>
    <div class="date" id="dateLabel">Datum:
        <span class="editable" contenteditable="true" id="quoteDate"></span>
    </div>
    <div class="project-number screen-only" id="projectNumberDiv" style="display:none;">
        Projekt Nummer:
        <span class="editable" contenteditable="true" id="projectNumber"></span>
    </div>

    <div class="checkbox-group screen-only">
        <label><input type="checkbox" id="showProjectNumber" /> Visa Projekt Nummer</label>
        <label><input type="checkbox" id="showDecimals" /> Visa decimaler</label>
        <div id="compressionOptionsWrapper" style="display: inline-flex; align-items: center; gap: 5px;">
             <label><input type="checkbox" id="compressImagesChk" checked /> Komprimera bilder</label>
             <div id="compressionOptions" style="display: inline-flex; align-items: center; gap: 5px;">
                <label for="compressionQuality" style="font-size: 10pt;">Kvalitet:</label>
                <input type="number" id="compressionQuality" value="0.7" min="0.1" max="1.0" step="0.1" style="width: 50px; font-size: 10pt; padding: 2px;">
                <label for="compressionMaxWidth" style="font-size: 10pt;">Max bredd:</label>
                <input type="number" id="compressionMaxWidth" value="1280" min="100" step="100" style="width: 60px; font-size: 10pt; padding: 2px;">
             </div>
        </div>
        <label id="removeTotalCheckboxLabel">
            <input type="checkbox" id="removeTotalCheck" /> Ta bort totalen
        </label>
        <label id="addSignatureCheckboxLabel">
            <input type="checkbox" id="addSignatureCheck" /> L√§gg till signatur
        </label>
        <label id="toggleTillLabel">
            <input type="checkbox" id="toggleTillSectionChk" checked /> Visa 'Till'
        </label>
    </div>
    <div id="sectionVisibilityControls" class="checkbox-group screen-only">
        <span id="showSectionsLabel">Visa sektioner:</span>
        <label><input type="checkbox" id="showOptionalSectionChk" data-section="optional" /><span id="showOptionalLabel">Alternativ</span></label>
        <label><input type="checkbox" id="showInfoSectionChk" data-section="info" /><span id="showInfoLabel">Info/Bilder</span></label>
        <label><input type="checkbox" id="showTermsSectionChk" data-section="terms" /><span id="showTermsLabel">Villkor</span></label>
    </div>
    <div class="currency-multiplier screen-only" style="position: relative;">
        <div id="liveCurrencyRates" style="display:inline-block; margin-right:10px; font-size: 10px;"></div>
        <div id="singleCurrencyMultiplierDiv">
            <label for="currencyMultiplierInput">Valutakurs:</label>
            <input type="number" id="currencyMultiplierInput" value="11.8" step="0.01" />
        </div>
        <label for="marginPercentageInput" id="marginLabel" style="margin-left: 10px;">P√•slag (%):</label>
        <input type="number" id="marginPercentageInput" value="0" step="1" />

        <label style="display:block; margin-top:10px;">
            <input type="checkbox" id="useMultipleCurrenciesChk" />
            <span id="useMultipleCurrenciesLabel">Anv√§nd multipla valutakurser</span>
        </label>
        <div id="multipleCurrencyRatesDiv" style="display:none; margin-top:5px; text-align:left; padding-left:20px;">
            <div>
                <label for="usdRateInput" id="usdRateLabel">USD-SEK Kurs:</label>
                <input type="number" id="usdRateInput" step="0.01" />
            </div>
            <div>
                <label for="eurRateInput" id="eurRateLabel">EUR-SEK Kurs:</label>
                <input type="number" id="eurRateInput" step="0.01" />
            </div>
        </div>
    </div>


    <div class="screen-only" style="text-align:right; margin-bottom:20px;">
        <button id="toggleLanguageBtn">Byt Spr√•k (SV/EN)</button>
        <label style="margin-left:15px;">
            <input type="checkbox" id="useCustomCurrencyChk" />
            <span id="customCurrencyLabel">Anv√§nd egen valuta</span>
        </label>
        <input type="text" id="customCurrencyInput" value="EUR" style="width:80px; display:none; margin-left:10px;"/>
    </div>

    <div class="quote-section" id="quoteSection">
        <div id="companyA_wrapper"><strong id="toLabel">Till:</strong><p class="editable p-editable" contenteditable="true" id="companyA"></p></div>
        <div class="swap-button screen-only" id="swapButton"><-></div>
        <div><strong id="fromLabel">Fr√•n:</strong><p class="editable p-editable" contenteditable="true" id="companyB"></p></div>
    </div>

    <div class="reference"><strong id="refLabel">Ref:</strong><span class="editable" contenteditable="true" id="reference"></span></div>

    <div id="mainItemsSectionContainer">
        <span class="section-remove-icon screen-only" onclick="removeMainSection()">‚úñ</span>
        <div class="item-header">
            <div id="nrHeader" class="editable" contenteditable="true" data-field="nrHeader">Nr</div>
            <div id="articleNameHeader" class="editable" contenteditable="true" data-field="articleNameHeader">Artikel / Namn</div>
            <div id="quantityHeader" class="quantity-header editable" contenteditable="true" data-field="quantityHeader">Antal</div>
            <div id="priceHeader" class="price-header editable" contenteditable="true" data-field="priceHeader">Pris (SEK)</div>
        </div>
        <div id="itemsList"></div>
        <div class="total-price" id="totalPrice"><span id="totalLabel" class="editable" contenteditable="true" data-field="totalLabel">Total:</span><span id="totalValue">0 SEK</span></div>
        <button class="add-button screen-only" id="addItemButton">+ L√§gg till ny artikel</button>
    </div>

    <div id="optionalSectionContainer">
        <h3 id="optionalItemsHeading" class="name editable" contenteditable="true" data-field="optionalItemsHeading">Alternativ / Ytterligare Artiklar</h3>
        <span class="section-remove-icon screen-only" onclick="hideOptionalSection()">‚úñ</span>
        <div class="item-header">
            <div id="optNrHeader" class="editable" contenteditable="true" data-field="optNrHeader">Nr</div>
            <div id="optArticleHeader" class="editable" contenteditable="true" data-field="optArticleHeader">Artikel / Namn</div>
            <div id="optQuantityHeader" class="quantity-header editable" contenteditable="true" data-field="optQuantityHeader">Antal</div>
            <div id="optPriceHeader" class="price-header editable" contenteditable="true" data-field="optPriceHeader">Pris (SEK)</div>
        </div>
        <div id="optionalItemsList"></div>
        <button class="add-optional-button screen-only" id="addOptionalItemButton">+ L√§gg till ny artikel</button>
    </div>

    <div id="infoSectionContainer">
        <h3 id="infoImagesHeading" class="name editable" contenteditable="true" data-field="infoImagesHeading">Info / Bilder</h3>
        <hr class="horizontal-line" /><span class="section-remove-icon screen-only" onclick="hideInfoSection()">‚úñ</span>
        <div id="infoImagesList"></div>
        <div class="image-upload-container screen-only">
            <input type="file" id="imageUpload" accept="image/*" multiple style="display:none;" />
            <button class="image-upload-button" onclick="document.getElementById('imageUpload').click()">L√§gg till bild (fil)</button>
            <button class="image-upload-button" onclick="recompressAllImages()">Komprimera om bilder</button>
            <button class="image-upload-button" style="display:none;" onclick="addImageFromUrl()">L√§gg till bild (URL)</button>
            <button class="image-upload-button" onclick="addInfoText()">L√§gg till text</button>
            <button class="image-upload-button" onclick="addTable()">L√§gg till tabell</button>
        </div>
    </div>

    <div id="termsSectionContainer">
        <h3 id="termsHeading" class="name editable" contenteditable="true" data-field="termsHeading">Villkor</h3>
        <span class="section-remove-icon screen-only" onclick="hideTermsSection()">‚úñ</span>
        <hr class="horizontal-line" />
        <div id="termsList"></div>
        <button class="add-term-button screen-only" id="addTermButton">+ L√§gg till villkor</button>
    </div>

    <div id="signatureSection">
        <div class="signature-date">
            <span id="signatureDateLabel">Datum</span>:
            <span class="editable" contenteditable="true" id="signatureDate" style="border-bottom: 1px solid black; padding: 0 10px;">¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†</span>
        </div>
        <div id="signatureBlocksContainer" class="signature-row">
            <div class="signature-block info-block">
                 <div class="controls-row screen-only" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%);">
                    <span class="drag-handle">‚â°</span>
                    <span class="remove-icon" onclick="removeSignatureBlock(0)">‚úñ</span>
                </div>
                <div class="signature-line editable" contenteditable="true" data-field="signatureLessorLine"></div>
                <div id="signatureLessorLabel" class="editable" contenteditable="true" data-field="signatureLessorText">Uthyrare</div>
            </div>
            <div class="signature-block info-block">
                 <div class="controls-row screen-only" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%);">
                    <span class="drag-handle">‚â°</span>
                    <span class="remove-icon" onclick="removeSignatureBlock(1)">‚úñ</span>
                </div>
                <div class="signature-line editable" contenteditable="true" data-field="signatureLesseeLine"></div>
                <div id="signatureLesseeLabel" class="editable" contenteditable="true" data-field="signatureLesseeText">Hyrestagare</div>
            </div>
        </div>
    </div>


<div id="printMultiplier" class="print-only"><span id="multiplierValue"></span></div>

</div>

<div class="footer screen-only">
    <input type="file" id="fileInput" accept=".json" style="display: none;" />
    <button class="footer-button" onclick="document.getElementById('fileInput').click()">Ladda JSON</button>
    <button id="saveJson" class="footer-button">Spara JSON</button>
    <button id="copyJsonBtn" class="footer-button">Kopiera JSON (text)</button>
    <button class="footer-button" id="uploadPdfBtn">Ladda PDF-offert</button>
    <input type="file" id="pdfUploadInput" accept=".pdf" style="display:none;" />
    <button class="footer-button" id="savePdfBtn">Spara som PDF</button>
    <button id="printBtn" class="footer-button">Print</button>
    <div class="status-message" id="statusMessage"></div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
</script>

<script>
const translations = {
  sv: {
    quoteTitle: "Offert", quoteNumberLabel: "Offert nr:", dateLabel: "Datum:", projectNumberLabel: "Projekt Nummer:",
    toLabel: "Till:", fromLabel: "Fr√•n:", refLabel: "Ref:", nrHeader: "Nr", articleNameHeader: "Artikel / Namn",
    quantityHeader: "Antal", priceHeader: "Pris", addItemButton: "+ L√§gg till ny artikel",
    optionalItemsHeading: "Alternativ / Ytterligare Artiklar", infoImagesHeading: "Info / Bilder",
    termsHeading: "Villkor", addOptionalItemButton: "+ L√§gg till ny artikel", addTermButton: "+ L√§gg till villkor",
    customCurrencyLabelText: "Anv√§nd egen valuta", toggleLangBtn: "Byt Spr√•k (SV/EN)", newTermText: "Nytt villkor: Klicka f√∂r att redigera",
    newArticleName: "Artikel Namn", newAltArticleName: "Alternativ Artikel Namn", newDescription: "Beskrivning",
    newOptionalItemDescription: "Standardbeskrivning f√∂r alternativ artikel", 
    newSubItemName: "Underpost Namn", 
    newSubItemDescription: "Standardbeskrivning f√∂r underpost", 
    newInfoText: "Klicka f√∂r att redigera text", promptImageUrl: "Ange bildens URL:", removeTotalLabelText: "Ta bort totalen",
    addSignatureLabelText: "L√§gg till signatur",
    hideTillSectionLabelText: "Visa 'Till'", bakeInPriceLabel: "Baka in pris i andra artiklar",
    bakedInPriceTooltip: "Priset f√∂r denna artikel har f√∂rdelats p√• andra artiklar.",
    signatureDateLabel: "Datum", signatureLessorLabel: "Uthyrare", signatureLesseeLabel: "Hyrestagare",
    totalLabel: "Total:", marginLabel: "P√•slag (%):", copyJsonBtn: "Kopiera JSON (text)",
    statusJsonCopied: "Status: JSON kopierad till urklipp!",
    statusRecompressing: "Komprimerar om bilder...", statusRecompressDone: "Alla bilder har komprimerats om.",
    duplicateItem: "Duplicera rad", removeRow: "Ta bort rad",
    moveUp: "Flytta upp", moveDown: "Flytta ner",
    useMultipleCurrenciesLabelText: "Anv√§nd multipla valutakurser",
    usdRateLabelText: "USD-SEK Kurs:", eurRateLabelText: "EUR-SEK Kurs:",
    editItemNumberPrompt: "Ange nytt artikelnummer:",
    addSubItem: "L√§gg till underpost", 
    removeAllSubItems: "Ta bort alla underposter",
    showSectionsLabel: "Visa sektioner:", showOptionalLabel: "Alternativ", showInfoLabel: "Info/Bilder", showTermsLabel: "Villkor",
    optNrHeader: "Nr", optArticleHeader: "Artikel / Namn", optQuantityHeader: "Antal", optPriceHeader: "Pris",
  },
  en: {
    quoteTitle: "Quote", quoteNumberLabel: "Quote No:", dateLabel: "Date:", projectNumberLabel: "Project Number:",
    toLabel: "To:", fromLabel: "From:", refLabel: "Ref:", nrHeader: "No", articleNameHeader: "Article / Name",
    quantityHeader: "Quantity", priceHeader: "Price", addItemButton: "+ Add new item",
    optionalItemsHeading: "Alternative / Additional Items", infoImagesHeading: "Info / Images",
    termsHeading: "Terms", addOptionalItemButton: "+ Add new item", addTermButton: "+ Add a term",
    customCurrencyLabelText: "Use custom currency", toggleLangBtn: "Toggle Language (SV/EN)", newTermText: "New term: Click to edit",
    newArticleName: "Article Name", newAltArticleName: "Alternative Article Name", newDescription: "Description",
    newOptionalItemDescription: "Default description for optional item", 
    newSubItemName: "Sub Item Name", 
    newSubItemDescription: "Default description for sub item", 
    newInfoText: "Click to edit text", promptImageUrl: "Enter image URL:", removeTotalLabelText: "Remove total",
    addSignatureLabelText: "Add signature",
    hideTillSectionLabelText: "Show 'To'", bakeInPriceLabel: "Bake price into other items",
    bakedInPriceTooltip: "The price for this item has been distributed to other items.",
    signatureDateLabel: "Date", signatureLessorLabel: "Lessor", signatureLesseeLabel: "Lessee",
    totalLabel: "Total:", marginLabel: "Margin (%):", copyJsonBtn: "Copy JSON (text)",
    statusJsonCopied: "Status: JSON copied to clipboard!",
    statusRecompressing: "Re-compressing images...", statusRecompressDone: "All images have been re-compressed.",
    duplicateItem: "Duplicate item", removeRow: "Remove row",
    moveUp: "Move up", moveDown: "Move down",
    useMultipleCurrenciesLabelText: "Use multiple currency rates",
    usdRateLabelText: "USD-SEK Rate:", eurRateLabelText: "EUR-SEK Rate:",
    editItemNumberPrompt: "Enter new item number:",
    addSubItem: "Add Sub Item", 
    removeAllSubItems: "Remove All Sub Items",
    showSectionsLabel: "Show sections:", showOptionalLabel: "Optional", showInfoLabel: "Info/Images", showTermsLabel: "Terms",
    optNrHeader: "No", optArticleHeader: "Article / Name", optQuantityHeader: "Quantity", optPriceHeader: "Price",
  }
};

let currentLanguage = "sv"; 
let jsonData = null;
let currentFileName = null; 
window.liveExchangeRates = { usd: null, eur: null };


(function initData(){
    const localData = localStorage.getItem('quoteData');
    if(!localData){
        jsonData={ quote:{ currencyMultiplicator: 11.8, marginPercentage: 0, useMultipleCurrencies: false, usdToSekRate: 10.50, eurToSekRate: 11.50, showSignature: false, showTillSection: true, labels: {}, visibility: { optional: true, info: true, terms: true } }, companyA:{}, companyB:{}, items:[], optionalItems:[], terms:[], infoImages:[], signature: { date: "", lessorLine: "", lesseeLine: "", lessorText: translations.sv.signatureLessorLabel, lesseeText: translations.sv.signatureLesseeLabel } };
    } else {
        jsonData=JSON.parse(localData);
        if(!jsonData.quote)jsonData.quote={currencyMultiplicator:11.8, marginPercentage: 0, useMultipleCurrencies: false, usdToSekRate: 10.50, eurToSekRate: 11.50, showSignature: false, showTillSection: true, labels: {}, visibility: { optional: true, info: true, terms: true } };
        if(jsonData.quote.marginPercentage === undefined) jsonData.quote.marginPercentage = 0;
        if(jsonData.quote.currencyMultiplicator === undefined) jsonData.quote.currencyMultiplicator = 11.8;
        if(jsonData.quote.useMultipleCurrencies === undefined) jsonData.quote.useMultipleCurrencies = false;
        if(jsonData.quote.usdToSekRate === undefined) jsonData.quote.usdToSekRate = 10.50;
        if(jsonData.quote.eurToSekRate === undefined) jsonData.quote.eurToSekRate = 11.50;
        if(jsonData.quote.showSignature === undefined) jsonData.quote.showSignature = false;
        if(jsonData.quote.showTillSection === undefined) jsonData.quote.showTillSection = true;
        if(!jsonData.quote.labels) jsonData.quote.labels = {};
        if (jsonData.quote.totalLabel) { // Migrate old totalLabel
            jsonData.quote.labels.totalLabel = jsonData.quote.totalLabel;
            delete jsonData.quote.totalLabel;
        }
        if (!jsonData.quote.visibility) {
            jsonData.quote.visibility = { optional: true, info: true, terms: true };
        }
        if(!jsonData.companyA)jsonData.companyA={}; if(!jsonData.companyB)jsonData.companyB={};
        if(!Array.isArray(jsonData.items))jsonData.items=[]; 
        jsonData.items.forEach(it => { 
            if(it.isPriceBakedIn === undefined) it.isPriceBakedIn = false; 
            (it.subItems || []).forEach(sIt => { if(sIt.isPriceBakedIn === undefined) sIt.isPriceBakedIn = false; });
        });
        if(!Array.isArray(jsonData.optionalItems))jsonData.optionalItems=[];
        jsonData.optionalItems.forEach(it => { 
            if(it.isPriceBakedIn === undefined) it.isPriceBakedIn = false; 
            (it.subItems || []).forEach(sIt => { if(sIt.isPriceBakedIn === undefined) sIt.isPriceBakedIn = false; });
        });
        if(!Array.isArray(jsonData.terms))jsonData.terms=[]; if(!Array.isArray(jsonData.infoImages))jsonData.infoImages=[];
        if(!jsonData.signature) jsonData.signature = { date: "", lessorLine: "", lesseeLine: "", lessorText: translations.sv.signatureLessorLabel, lesseeText: translations.sv.signatureLesseeLabel };
    }
})();

function deepTraverseAndGetString(obj) {
    let result = [];
    if (typeof obj !== 'object' || obj === null) return [];
    for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
            const value = obj[key];
            if (typeof value === 'object' && value !== null) {
                result = result.concat(deepTraverseAndGetString(value));
            } else if (value) {
                result.push(value);
            }
        }
    }
    return result;
}

function formatCompanyInfo(companyObj) {
    if (!companyObj) return '';
    return deepTraverseAndGetString(companyObj).join('<br>');
}

function loadQuoteData(data, loadedFileName=null){
    jsonData=JSON.parse(JSON.stringify(data));
    const q = jsonData.quote || {};
    if(!q.quoteNumber)q.quoteNumber=Math.floor(Math.random()*100000).toString();
    if(q.marginPercentage === undefined) q.marginPercentage = 0;
    if(q.currencyMultiplicator === undefined) q.currencyMultiplicator = 11.8;
    if(q.useMultipleCurrencies === undefined) q.useMultipleCurrencies = false;
    if(q.usdToSekRate === undefined) q.usdToSekRate = 10.50; 
    if(q.eurToSekRate === undefined) q.eurToSekRate = 11.50; 
    if(q.showSignature === undefined) q.showSignature = false;
    if(q.showTillSection === undefined) q.showTillSection = true;
    if(!q.labels) q.labels = {};
    if (q.totalLabel) { // Migrate old totalLabel from loaded file
        q.labels.totalLabel = q.totalLabel;
        delete q.totalLabel;
    }
    if (!q.visibility) { // Backward compatibility for section visibility
        q.visibility = { optional: true, info: true, terms: true };
    }

    jsonData.quote = q;
    if(!Array.isArray(jsonData.terms))jsonData.terms=[];
    if(!jsonData.signature) jsonData.signature = { date: "", lessorLine: "", lesseeLine: "", lessorText: translations.sv.signatureLessorLabel, lesseeText: translations.sv.signatureLesseeLabel };
    
    // --- BACKWARD COMPATIBILITY FOR BAKED IN PRICES ---
    (jsonData.items || []).forEach(it => { 
        if(it.isPriceBakedIn === undefined) it.isPriceBakedIn = false; 
        (it.subItems || []).forEach(sIt => { if(sIt.isPriceBakedIn === undefined) sIt.isPriceBakedIn = false; });
    });
    (jsonData.optionalItems || []).forEach(it => { 
        if(it.isPriceBakedIn === undefined) it.isPriceBakedIn = false; 
        (it.subItems || []).forEach(sIt => { if(sIt.isPriceBakedIn === undefined) sIt.isPriceBakedIn = false; });
    });


    document.getElementById('quoteNumber').textContent = q.quoteNumber || '';
    document.getElementById('quoteDate').textContent = q.date || new Date().toLocaleDateString('sv-SE');
    document.getElementById('projectNumber').textContent = q.projectNumber || '';
    document.getElementById('companyA').innerHTML = formatCompanyInfo(jsonData.companyA);
    document.getElementById('companyB').innerHTML = formatCompanyInfo(jsonData.companyB);
    document.getElementById('reference').textContent = q.reference||'';
    
    document.getElementById('currencyMultiplierInput').value = q.currencyMultiplicator||11.8;
    document.getElementById('marginPercentageInput').value = q.marginPercentage || 0;
    
    document.getElementById('useMultipleCurrenciesChk').checked = q.useMultipleCurrencies || false;
    document.getElementById('usdRateInput').value = parseFloat(q.usdToSekRate || 10.50).toFixed(2);
    document.getElementById('eurRateInput').value = parseFloat(q.eurToSekRate || 11.50).toFixed(2);
    toggleMultipleCurrencyUI(q.useMultipleCurrencies || false);


    document.getElementById('showDecimals').checked=q.showDecimals || false;
    document.getElementById('showProjectNumber').checked = q.projectNumberVisible || false; 
    document.getElementById('projectNumberDiv').style.display = (q.projectNumberVisible) ? 'block' : 'none';
    document.getElementById('addSignatureCheck').checked = q.showSignature || false;
    document.getElementById('signatureSection').style.display = (q.showSignature) ? 'block' : 'none';
    document.getElementById('toggleTillSectionChk').checked = q.showTillSection;
    applyTillSectionVisibility();
    
    currentFileName = loadedFileName;
    currentLanguage = q.language || 'sv';
    reRenderAll();
    updateDocumentTitle();
}

function reRenderAll(){
    renumberAllItems(); 
    updatePrices();
    loadItems(jsonData.items,'itemsList');
    loadItems(jsonData.optionalItems,'optionalItemsList');
    loadTerms(jsonData.terms);
    loadInfoImages();
    loadSignature();
    calculateTotalPrice();
    makeEditable(); 
    initializeDragAndDrop();
    updateLanguageUI(currentLanguage);
    updatePrintMultiplier(); 
    applySectionVisibility();
    updateSectionVisibilityCheckboxes();
}

function updateDocumentTitle(){
    let baseTitle = (currentLanguage==='sv') ? 'Offert' : 'Quote';
    let refVal = document.getElementById('reference').textContent.trim();
    document.title = (refVal) ? `${baseTitle} - ${refVal}` : baseTitle;
}

function updateLanguageUI(lang){
    document.documentElement.setAttribute('lang', lang);
    const t = translations[lang];
    const labels = jsonData.quote.labels || {};

    if(!t)return;

    // Set labels from translations, with override from jsonData
    document.getElementById('quoteTitle').textContent = labels.quoteTitle || t.quoteTitle;
    document.getElementById('quoteNumberLabel').childNodes[0].nodeValue = `${t.quoteNumberLabel} `;
    document.getElementById('dateLabel').childNodes[0].nodeValue = `${t.dateLabel} `;
    document.getElementById('toLabel').textContent = t.toLabel;
    document.getElementById('fromLabel').textContent = t.fromLabel;
    document.getElementById('refLabel').textContent = t.refLabel;
    document.getElementById('articleNameHeader').textContent = labels.articleNameHeader || t.articleNameHeader;
    document.getElementById('nrHeader').textContent = labels.nrHeader || t.nrHeader;
    document.getElementById('quantityHeader').textContent = labels.quantityHeader || t.quantityHeader;
    document.getElementById('optionalItemsHeading').textContent = labels.optionalItemsHeading || t.optionalItemsHeading;
    document.getElementById('optArticleHeader').textContent = labels.optArticleHeader || t.optArticleHeader;
    document.getElementById('optNrHeader').textContent = labels.optNrHeader || t.optNrHeader;
    document.getElementById('optQuantityHeader').textContent = labels.optQuantityHeader || t.optQuantityHeader;
    document.getElementById('infoImagesHeading').textContent = labels.infoImagesHeading || t.infoImagesHeading;
    document.getElementById('termsHeading').textContent = labels.termsHeading || t.termsHeading;
    document.getElementById('totalLabel').textContent = labels.totalLabel || t.totalLabel;
    
    // Buttons and other static text
    document.getElementById('addItemButton').textContent = t.addItemButton;
    document.getElementById('addOptionalItemButton').textContent = t.addOptionalItemButton;
    document.getElementById('addTermButton').textContent = t.addTermButton;
    document.getElementById('toggleLanguageBtn').textContent = t.toggleLangBtn;
    document.getElementById('marginLabel').textContent = `${t.marginLabel} `;
    document.getElementById('copyJsonBtn').textContent = t.copyJsonBtn;
    
    // Checkbox labels
    document.querySelector('#removeTotalCheckboxLabel').lastChild.nodeValue = ` ${t.removeTotalLabelText}`;
    document.querySelector('#addSignatureCheckboxLabel').lastChild.nodeValue = ` ${t.addSignatureLabelText}`;
    document.querySelector('#toggleTillLabel').lastChild.nodeValue = ` ${t.hideTillSectionLabelText}`;
    document.querySelector('#customCurrencyLabel').textContent = ` ${t.customCurrencyLabelText}`;
    document.querySelector('#useMultipleCurrenciesLabel').textContent = ` ${t.useMultipleCurrenciesLabelText}`;
    document.querySelector('#usdRateLabel').textContent = `${t.usdRateLabelText} `;
    document.querySelector('#eurRateLabel').textContent = `${t.eurRateLabelText} `;

    // Section visibility controls
    document.getElementById('showSectionsLabel').textContent = t.showSectionsLabel;
    document.getElementById('showOptionalLabel').textContent = t.showOptionalLabel;
    document.getElementById('showInfoLabel').textContent = t.showInfoLabel;
    document.getElementById('showTermsLabel').textContent = t.showTermsLabel;

    // Signature (check if custom text exists, otherwise use translation)
    if (jsonData.signature) {
        if (!jsonData.signature.lessorText || jsonData.signature.lessorText === translations[lang === 'sv' ? 'en' : 'sv'].signatureLessorLabel) {
            jsonData.signature.lessorText = t.signatureLessorLabel;
        }
        if (!jsonData.signature.lesseeText || jsonData.signature.lesseeText === translations[lang === 'sv' ? 'en' : 'sv'].signatureLesseeLabel) {
            jsonData.signature.lesseeText = t.signatureLesseeLabel;
        }
    }

    updatePriceHeaders();
    calculateTotalPrice();
    updateDocumentTitle();
    loadSignature();
}

function updatePriceHeaders(){
    const customChk = document.getElementById("useCustomCurrencyChk");
    const currencyVal = document.getElementById("customCurrencyInput").value;
    const labels = jsonData.quote.labels || {};
    const t = translations[currentLanguage];
    
    const priceHeaderText = labels.priceHeader || t.priceHeader;
    const optPriceHeaderText = labels.optPriceHeader || t.optPriceHeader;

    const curSymbol = (customChk.checked && currencyVal) ? `(${currencyVal})` : "(SEK)";
    
    document.getElementById('priceHeader').textContent = `${priceHeaderText} ${curSymbol} `;
    document.getElementById('optPriceHeader').textContent = `${optPriceHeaderText} ${curSymbol} `;
}
function loadItems(items, containerId){
    const container = document.getElementById(containerId);
    if(!container) return;
    container.innerHTML = '';
    const fallbackCurrency = (jsonData.quote.useCustomCurrency && jsonData.quote.customCurrency) ? jsonData.quote.customCurrency : 'SEK';

    items.forEach((it, idx) => {
        if (it.isPriceBakedIn === undefined) it.isPriceBakedIn = false;
        if (it.marginPercentage === undefined) it.marginPercentage = 0;
        const margin = parseFloat(it.marginPercentage) || 0;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'quote-item'; itemDiv.dataset.index = idx; 
        itemDiv.dataset.itemId = it.id || `item-${containerId}-${idx}`; 

        const meta = document.createElement('div'); meta.className = 'item-meta';

        const bakeInButtonHTML = containerId === 'itemsList' ? `<button class="control-btn" title="${translations[currentLanguage].bakeInPriceLabel}" onclick="toggleBakeInPrice('${containerId}', ${idx})">üë®‚Äçüç≥</button>` : '';
        const bakedInIconHTML = it.isPriceBakedIn ? `<span class="screen-only baked-in-icon" title="${translations[currentLanguage].bakedInPriceTooltip}">üë®‚Äçüç≥</span>` : '';

        meta.innerHTML = `
            <div class="item-number editable" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-field="itemNumber" title="Klicka f√∂r att redigera nummer">${it.itemNumber}</div>
            <div class="item-name bold editable" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-field="name">${it.name||''} ${bakedInIconHTML}</div>
            <div class="quantity" data-item="${containerId}" data-index="${idx}" data-field="quantity"><div class="input-container"><input type="number" min="0" step="1" value="${it.quantity || 0}" class="${(it.quantity || 0) === 0 ? 'zero-text' : ''}"/><div class="button-container screen-only"><button type="button" class="increment-btn">+</button><button type="button" class="decrement-btn">-</button></div></div></div>
            <div class="targetPrice" data-item="${containerId}" data-index="${idx}" data-field="targetPrice" style="text-align:right;"><span class="${(it.targetPrice || 0) === 0 && !it.isPriceBakedIn ? 'zero-text' : ''}" style="text-align:right;display:inline-block;width:100%;">${formatPrice(it.targetPrice || 0)}</span></div>
            <div class="item-tooltip screen-only">
                <span class="original-price-display editable" contenteditable="true" data-field="originalPriceAndCurrency" data-item="${containerId}" data-index="${idx}">${it.originalPrice != null ? it.originalPrice : 0} ${it.currencyOrigin || fallbackCurrency}</span>
                <span class="margin-display editable ${margin < 0 ? 'discount' : ''}" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-field="marginPercentage">${margin >= 0 ? '+' : ''}${margin}%</span>
            </div>
            <div class="item-actions screen-only">
                <button class="control-btn control-btn-move" title="${translations[currentLanguage].moveUp}" onclick="moveItemUp('${containerId}', ${idx})">‚ñ≤</button>
                <button class="control-btn control-btn-move" title="${translations[currentLanguage].moveDown}" onclick="moveItemDown('${containerId}', ${idx})">‚ñº</button>
                <button class="control-btn" title="${translations[currentLanguage].addSubItem}" onclick="addSubItemToParent('${containerId}', ${idx})">‚äï</button>
                <button class="control-btn" title="${translations[currentLanguage].removeAllSubItems}" onclick="removeAllSubItems('${containerId}', ${idx})">üóëÔ∏è</button>
                ${bakeInButtonHTML}
                <button class="control-btn" title="G√∂r till underpost" onclick="toggleItemHierarchy('${containerId}', ${idx})">‚Ü≥</button>
                <button class="control-btn" title="Flytta till/fr√•n Alternativ" onclick="toggleItemOptionality('${containerId}', ${idx})">‚áÖ</button>
                <button class="control-btn" title="${translations[currentLanguage].duplicateItem}" onclick="duplicateItem('${containerId}', ${idx})">‚ùè</button>
                <button class="control-btn" title="${translations[currentLanguage].removeRow}" style="background-color:red; color:white;" onclick="removeItem('${containerId}', ${idx})">‚úñ</button>
            </div>
        `;
        itemDiv.appendChild(meta);
        if(it.itemDescription){
            const details = document.createElement('div');
            details.className = 'item-details editable'; details.contentEditable = true;
            details.dataset.item = containerId; details.dataset.index = idx; details.dataset.field = 'itemDescription';
            details.innerHTML = it.itemDescription.replace(/\n/g,'<br>');
            const descRemove = document.createElement('span');
            descRemove.className = 'description-remove-icon screen-only'; descRemove.textContent = '‚úñ'; descRemove.onclick = () => removeDescription(details);
            details.appendChild(descRemove); itemDiv.appendChild(details);
        }
        (it.subItems || []).forEach((sItem, sIdx) => { 
            if (sItem.marginPercentage === undefined) sItem.marginPercentage = 0;
            if (sItem.isPriceBakedIn === undefined) sItem.isPriceBakedIn = false;
            const subMargin = parseFloat(sItem.marginPercentage) || 0;
            const included = document.createElement('div'); 
            included.className = `included-item ${sItem.isPriceBakedIn ? 'baked-in' : ''}`;
            const sMeta = document.createElement('div'); sMeta.className = 'item-meta';
            const subBakedInIconHTML = sItem.isPriceBakedIn ? `<span class="screen-only baked-in-icon" title="${translations[currentLanguage].bakedInPriceTooltip}">üë®‚Äçüç≥</span>` : '';

            sMeta.innerHTML = `
                <div class="item-number editable" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}" data-field="subItemNumber" title="Klicka f√∂r att redigera nummer">${sItem.subItemNumber}</div>
                <div class="item-name editable subitem-name-style" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}" data-field="subItemName">${sItem.subItemName||''} ${subBakedInIconHTML}</div>
                <div class="quantity" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}" data-field="subItemQuantity"><div class="input-container"><input type="number" min="0" step="1" value="${sItem.subItemQuantity || 0}" class="${(sItem.subItemQuantity || 0) === 0 ? 'zero-text' : ''}"/><div class="button-container screen-only"><button type="button" class="increment-btn">+</button><button type="button" class="decrement-btn">-</button></div></div></div>
                <div class="subItemTargetPrice" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}" data-field="subItemTargetPrice" style="text-align:right;"><span class="${(sItem.subItemTargetPrice || 0) === 0 ? 'zero-text' : ''}" style="text-align:right;display:inline-block;width:100%;">${formatPrice(sItem.subItemTargetPrice || 0)}</span></div>
                <div class="item-tooltip screen-only">
                    <span class="original-price-display editable" contenteditable="true" data-field="originalPriceAndCurrency" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}">${sItem.subItemOriginalPrice != null ? sItem.subItemOriginalPrice : 0} ${sItem.currencyOrigin || it.currencyOrigin || fallbackCurrency}</span>
                    <span class="margin-display editable ${subMargin < 0 ? 'discount' : ''}" contenteditable="true" data-item="${containerId}" data-index="${idx}" data-included-index="${sIdx}" data-field="marginPercentage">${subMargin >= 0 ? '+' : ''}${subMargin}%</span>
                </div>
                <div class="item-actions screen-only">
                    <button class="control-btn control-btn-move" title="${translations[currentLanguage].moveUp}" onclick="moveSubItemUp('${containerId}', ${idx}, ${sIdx})">‚ñ≤</button>
                    <button class="control-btn control-btn-move" title="${translations[currentLanguage].moveDown}" onclick="moveSubItemDown('${containerId}', ${idx}, ${sIdx})">‚ñº</button>
                    <button class="control-btn" title="${translations[currentLanguage].bakeInPriceLabel}" onclick="toggleBakeInSubItemPrice('${containerId}', ${idx}, ${sIdx})">üë®‚Äçüç≥</button>
                    <button class="control-btn" title="G√∂r till huvudpost" onclick="toggleItemHierarchy('${containerId}', ${idx}, ${sIdx})">‚Ü∞</button>
                    <button class="control-btn" title="${translations[currentLanguage].duplicateItem}" onclick="duplicateSubItem('${containerId}', ${idx}, ${sIdx})">‚ùè</button>
                    <button class="control-btn" title="${translations[currentLanguage].removeRow}" style="background-color:red; color:white;" onclick="removeSubItem('${containerId}',${idx},${sIdx})">‚úñ</button>
                 </div>
            `;
            included.appendChild(sMeta);
            if(sItem.subItemDescription){
                const sDetails = document.createElement('div');
                sDetails.className = 'item-details editable'; sDetails.contentEditable = true;
                sDetails.dataset.item = containerId; sDetails.dataset.index = idx; sDetails.dataset.includedIndex = sIdx; sDetails.dataset.field = 'subItemDescription';
                sDetails.innerHTML = sItem.subItemDescription.replace(/\n/g,'<br>');
                const sDescRem = document.createElement('span');
                sDescRem.className = 'description-remove-icon screen-only'; sDescRem.textContent = '‚úñ'; sDescRem.onclick = () => removeDescription(sDetails);
                sDetails.appendChild(sDescRem); included.appendChild(sDetails);
            }
            itemDiv.appendChild(included);
        });
        container.appendChild(itemDiv);
    });
}
function removeItem(containerId, idx){ const arr = (containerId ==='itemsList') ? jsonData.items : jsonData.optionalItems; arr.splice(idx,1); saveToLocal(); reRenderAll(); }
function removeSubItem(containerId, idx, sIdx){ const arr=(containerId==='itemsList')?jsonData.items:jsonData.optionalItems; arr[idx].subItems.splice(sIdx,1); saveToLocal(); reRenderAll(); }

function duplicateItem(containerId, index) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    if (list && list[index]) {
        const itemToCopy = list[index];
        const newItem = JSON.parse(JSON.stringify(itemToCopy));
        delete newItem.id; 
        list.splice(index + 1, 0, newItem);
        saveToLocal();
        reRenderAll();
    }
}

function duplicateSubItem(containerId, mainIndex, subIndex) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    const parentItem = list[mainIndex];
    if (parentItem && parentItem.subItems) {
        const subItemsList = parentItem.subItems;
        if (subItemsList && subItemsList[subIndex]) {
            const subItemToCopy = subItemsList[subIndex];
            const newSubItem = JSON.parse(JSON.stringify(subItemToCopy));
            subItemsList.splice(subIndex + 1, 0, newSubItem);
            saveToLocal();
            reRenderAll();
        }
    }
}

function removeDescription(el){ const {item: cId, index: i, includedIndex: si, field} = el.dataset; const it = (cId==='itemsList' ? jsonData.items : jsonData.optionalItems)[i]; (si ? (it.subItems)[si] : it)[field] = ''; saveToLocal(); reRenderAll(); }

function loadTerms(terms){
    const list=document.getElementById('termsList'); list.innerHTML='';
    (terms || []).forEach((t, i)=>{
        const termDiv = document.createElement('div');
        termDiv.className = 'term-item info-block'; // Re-use info-block class for hover effects
        termDiv.dataset.index = i;
        termDiv.innerHTML = `
            <div class="controls-row screen-only">
                <span class="info-image-up" onclick="moveTermUp(${i})">‚ñ≤</span>
                <span class="drag-handle">‚â°</span>
                <span class="info-image-down" onclick="moveTermDown(${i})">‚ñº</span>
                <span class="remove-icon" onclick="removeTerm(${i})">‚úñ</span>
            </div>
            <div class="content-wrapper">
                <div class="editable" contenteditable="true" data-field="term" data-index="${i}">${t}</div>
            </div>
        `;
        list.appendChild(termDiv);
    });
}
function removeTerm(i){ jsonData.terms.splice(i,1); saveToLocal(); reRenderAll(); }

function loadInfoImages(){
    const c=document.getElementById('infoImagesList'); c.innerHTML='';
    (jsonData.infoImages||[]).forEach((obj, idx)=>{
        const block=document.createElement('div');
        block.className='info-block'; 
        block.dataset.index=idx;

        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'content-wrapper';

        if(obj.type==='text'){
            block.classList.add('info-block-fullwidth');
            const txt=document.createElement('div');
            txt.className='info-text-block editable'; txt.contentEditable=true; txt.dataset.index=idx; txt.innerHTML=obj.content||'';
            txt.addEventListener('input',()=>{ jsonData.infoImages[idx].content=txt.innerHTML; saveToLocal(); });
            contentWrapper.appendChild(txt);
        } else if(obj.type==='table'){
            block.classList.add('info-block-fullwidth');
            const table=document.createElement('table'); table.className='info-table';
            for(let r=0;r<obj.rows;r++){
                const row=document.createElement('tr');
                for(let cc=0;cc<obj.cols;cc++){
                    const cell=document.createElement('td');
                    cell.contentEditable=true; cell.innerHTML=obj.data[r]?.[cc]||'';
                    cell.addEventListener('input',()=>{ if(!obj.data[r])obj.data[r]=[]; obj.data[r][cc]=cell.innerHTML; saveToLocal(); });
                    row.appendChild(cell);
                }
                table.appendChild(row);
            }
            contentWrapper.appendChild(table);
        } else { // Image
            block.classList.add('info-block-image');
            const imgContainer=document.createElement('div');
            imgContainer.className='info-image-container';
            const img=document.createElement('img');
            img.src=obj.src; img.style.width=(obj.width||400)+'px';
            const resizeH=document.createElement('div');
            resizeH.className='image-resize-handle screen-only'; 
            imgContainer.append(img, resizeH); 
            contentWrapper.appendChild(imgContainer);
            initializeResize(resizeH,img,idx);
        }
        
        const controls = document.createElement('div');
        controls.className = 'controls-row screen-only';
        if (obj.type === 'image') {
            controls.innerHTML = `
                <span class="info-image-up" title="St√∂rre (+10%)" onclick="adjustImageSize(${idx}, 1.10)">+</span>
                <span class="info-image-down" title="Mindre (-5%)" onclick="adjustImageSize(${idx}, 0.95)">-</span>
                <span class="info-image-up" onclick="moveImageUp(${idx})">‚ñ≤</span>
                <span class="drag-handle">‚â°</span>
                <span class="info-image-down" onclick="moveImageDown(${idx})">‚ñº</span>
                <span class="remove-icon" onclick="removeInfoItem(${idx})">‚úñ</span>`;
        } else {
            controls.innerHTML = `
                <span class="info-image-up" onclick="moveImageUp(${idx})">‚ñ≤</span>
                <span class="drag-handle">‚â°</span>
                <span class="info-image-down" onclick="moveImageDown(${idx})">‚ñº</span>
                <span class="remove-icon" onclick="removeInfoItem(${idx})">‚úñ</span>`;
        }
        
        block.appendChild(controls); 
        block.appendChild(contentWrapper); 
        c.appendChild(block);
    });
}
function loadSignature() {
    if (!jsonData.signature) return;
    const sig = jsonData.signature;
    document.getElementById('signatureDateLabel').textContent = translations[currentLanguage].signatureDateLabel;
    document.getElementById('signatureDate').innerHTML = sig.date || '¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†';
    
    const lessorBlock = document.querySelector('.signature-block:first-child');
    if (lessorBlock) {
        lessorBlock.querySelector('.signature-line').innerHTML = sig.lessorLine || '';
        lessorBlock.querySelector('.editable[data-field="signatureLessorText"]').innerHTML = sig.lessorText || translations[currentLanguage].signatureLessorLabel;
    }

    const lesseeBlock = document.querySelector('.signature-block:last-child');
     if (lesseeBlock) {
        lesseeBlock.querySelector('.signature-line').innerHTML = sig.lesseeLine || '';
        lesseeBlock.querySelector('.editable[data-field="signatureLesseeText"]').innerHTML = sig.lesseeText || translations[currentLanguage].signatureLesseeLabel;
    }
}
function removeInfoItem(idx){ jsonData.infoImages.splice(idx,1); saveToLocal(); reRenderAll(); }
function addInfoText(){ jsonData.infoImages.push({ type:'text', content: translations[currentLanguage].newInfoText }); saveToLocal(); reRenderAll(); }
function addTable(){
    const rows=prompt('Antal rader','3'); const cols=prompt('Antal kolumner','3');
    if(rows && cols){
        jsonData.infoImages.push({ type:'table', rows:parseInt(rows)||2, cols:parseInt(cols)||2, data:Array.from({length: parseInt(rows)||2}, () => new Array(parseInt(cols)||2).fill('')) });
        saveToLocal(); reRenderAll();
    }
}
function addImageFromUrl(){
    const url=prompt(translations[currentLanguage].promptImageUrl);
    if(url){ jsonData.infoImages.push({ type:'image', src:url, width:400, description:'' }); saveToLocal(); reRenderAll(); }
}
document.getElementById('imageUpload').addEventListener('change',function(ev){
    for(let f of ev.target.files){
        const process = (src) => { jsonData.infoImages.push({ type:'image', src, width:400, description:'' }); saveToLocal(); reRenderAll(); };
        if(document.getElementById('compressImagesChk').checked){
            const quality = parseFloat(document.getElementById('compressionQuality').value) || 0.7;
            const maxWidth = parseInt(document.getElementById('compressionMaxWidth').value) || 1280;
            compressImageFromFile(f, quality, maxWidth, process); 
        } else { 
            const reader=new FileReader(); 
            reader.onload=(e)=>process(e.target.result); 
            reader.readAsDataURL(f); 
        }
    }
});
function initializeResize(handle,img,idx){
    let startWidth, startX, startY, startHeight;
    const onDown=(ev)=>{ 
        ev.preventDefault(); 
        startWidth=img.offsetWidth; 
        startX=ev.clientX;
        startY=ev.clientY;
        startHeight=img.offsetHeight;
        document.addEventListener('mousemove',onMove); 
        document.addEventListener('mouseup',onUp);
    };
    const onMove=(ev)=>{ 
        ev.preventDefault(); 
        const newWidth = startWidth+(ev.clientX-startX);
        if(newWidth>40){ 
            img.style.width=newWidth+'px'; 
            jsonData.infoImages[idx].width=newWidth; 
        }
    };
    const onUp=()=>{ 
        saveToLocal(); 
        document.removeEventListener('mousemove',onMove); 
        document.removeEventListener('mouseup',onUp);
    };
    handle.addEventListener('mousedown',onDown);
}

function hideInfoSection(){ jsonData.quote.visibility.info = false; saveToLocal(); applySectionVisibility(); updateSectionVisibilityCheckboxes(); }
function hideOptionalSection(){ jsonData.quote.visibility.optional = false; saveToLocal(); applySectionVisibility(); updateSectionVisibilityCheckboxes(); }
function hideTermsSection(){ jsonData.quote.visibility.terms = false; saveToLocal(); applySectionVisibility(); updateSectionVisibilityCheckboxes(); }
function removeMainSection(){ if(confirm('√Ñr du s√§ker p√• att du vill ta bort ALLA artiklar fr√•n huvudlistan?')) { jsonData.items = []; saveToLocal(); reRenderAll(); } }
function removeSignatureBlock(index) {
    alert("This block cannot be removed, only hidden by unchecking 'L√§gg till signatur'.");
}


function moveImageUp(idx){ if(idx>0){ [jsonData.infoImages[idx], jsonData.infoImages[idx-1]] = [jsonData.infoImages[idx-1], jsonData.infoImages[idx]]; saveToLocal(); reRenderAll(); } }
function moveImageDown(idx){ if(idx<jsonData.infoImages.length-1){ [jsonData.infoImages[idx], jsonData.infoImages[idx+1]] = [jsonData.infoImages[idx+1], jsonData.infoImages[idx]]; saveToLocal(); reRenderAll(); } }

function compressImageFromFile(file, quality, maxWidth, callback){
    const reader=new FileReader();
    reader.onload=(e)=>{
        compressImageDataUrl(e.target.result, quality, maxWidth).then(callback);
    };
    reader.readAsDataURL(file);
}

function compressImageDataUrl(dataUrl, quality, maxWidth) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
                height = Math.round(height * (maxWidth / width));
                width = maxWidth;
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, width, height);
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.onerror = (err) => {
            console.error("Image load error:", err);
            reject("Kunde inte ladda bild f√∂r komprimering.");
        };
        img.src = dataUrl;
    });
}

async function recompressAllImages() {
    const statusEl = document.getElementById('statusMessage');
    statusEl.textContent = translations[currentLanguage].statusRecompressing;

    const quality = parseFloat(document.getElementById('compressionQuality').value) || 0.7;
    const maxWidth = parseInt(document.getElementById('compressionMaxWidth').value) || 1280;

    const compressionPromises = jsonData.infoImages
        .map((imgObject, index) => {
            if (imgObject.type === 'image' && imgObject.src) {
                return compressImageDataUrl(imgObject.src, quality, maxWidth)
                    .then(newSrc => {
                        jsonData.infoImages[index].src = newSrc;
                    })
                    .catch(error => {
                        console.error(`Failed to recompress image at index ${index}:`, error);
                    });
            }
            return Promise.resolve(); // Resolve immediately for non-image types
        });

    await Promise.all(compressionPromises);

    saveToLocal();
    reRenderAll();
    
    statusEl.textContent = translations[currentLanguage].statusRecompressDone;
    setTimeout(() => { statusEl.textContent = '' }, 4000);
}

function updatePrices(){
    const globalMarginMultiplier = 1 + ((parseFloat(jsonData.quote.marginPercentage) || 0) / 100);
    const useMultiCurrency = jsonData.quote.useMultipleCurrencies;
    const singleMultiplier = parseFloat(jsonData.quote.currencyMultiplicator) || 1;
    const usdRate = parseFloat(jsonData.quote.usdToSekRate) || 10.5;
    const eurRate = parseFloat(jsonData.quote.eurToSekRate) || 11.5;

    const calculateEntityPrice = (item, parentCurrencyOrigin) => {
        const itemMarginMultiplier = 1 + ((item.marginPercentage || 0) / 100);
        let originalPrice = item.originalPrice ?? item.subItemOriginalPrice ?? 0;
        let currencyOrigin = (item.currencyOrigin || parentCurrencyOrigin || (jsonData.quote.useCustomCurrency && jsonData.quote.customCurrency) || 'SEK').toUpperCase();
        
        let basePriceInSEK = originalPrice;
        if (currencyOrigin !== 'SEK') {
            if (useMultiCurrency) {
                if (currencyOrigin === 'USD') basePriceInSEK *= usdRate;
                else if (currencyOrigin === 'EUR') basePriceInSEK *= eurRate;
                else basePriceInSEK *= singleMultiplier; 
            } else {
                basePriceInSEK *= singleMultiplier;
            }
        }
        return (basePriceInSEK * globalMarginMultiplier) * itemMarginMultiplier;
    };

    let totalToDistribute = 0;
    let distributionPoolTotal = 0;
    
    // First pass: Calculate all individual prices and identify main item distribution pool
    jsonData.items.forEach(item => {
        let itemOwnPrice = calculateEntityPrice(item, null) * (item.quantity || 0);
        let subItemsPrice = 0;
        (item.subItems || []).forEach(s => {
            s.subItemTargetPrice = calculateEntityPrice(s, item.currencyOrigin) * (s.subItemQuantity || 0);
            subItemsPrice += s.subItemTargetPrice;
        });
        item.preBakeTargetPrice = itemOwnPrice + subItemsPrice;

        if (item.isPriceBakedIn) {
            totalToDistribute += item.preBakeTargetPrice;
        } else {
            distributionPoolTotal += item.preBakeTargetPrice;
        }
    });
    
    const distributionRatio = distributionPoolTotal > 0 ? 1 + (totalToDistribute / distributionPoolTotal) : 1;

    // Second pass: Distribute baked-in main item prices and set final display prices
    jsonData.items.forEach(item => {
        if (item.isPriceBakedIn) {
            item.targetPrice = 0;
            (item.subItems || []).forEach(s => s.subItemTargetPrice = 0); // Their price is part of the distributed total
        } else {
            let itemOwnPrice = calculateEntityPrice(item, null) * (item.quantity || 0);
            let bakedInSubItemsPrice = 0;
            (item.subItems || []).forEach(s => {
                // Recalculate sub-item price as it might be affected by distribution
                s.subItemTargetPrice = calculateEntityPrice(s, item.currencyOrigin) * (s.subItemQuantity || 0) * distributionRatio;
                if (s.isPriceBakedIn) {
                    bakedInSubItemsPrice += s.subItemTargetPrice;
                }
            });
            item.targetPrice = (itemOwnPrice * distributionRatio) + bakedInSubItemsPrice;
        }
    });

    // Third pass: Calculate prices for optional items (no distribution)
    jsonData.optionalItems.forEach(item => {
        let itemOwnPrice = calculateEntityPrice(item, null) * (item.quantity || 0);
        let bakedInSubItemsPrice = 0;
        (item.subItems || []).forEach(s => {
            s.subItemTargetPrice = calculateEntityPrice(s, item.currencyOrigin) * (s.subItemQuantity || 0);
            if (s.isPriceBakedIn) {
                bakedInSubItemsPrice += s.subItemTargetPrice;
            }
        });
        item.targetPrice = itemOwnPrice + bakedInSubItemsPrice;
    });
}

function calculateTotalPrice(){
    let total = 0;
    const lists = [jsonData.items, jsonData.optionalItems];

    lists.forEach(list => {
        (list || []).forEach(item => {
            // Add the parent item's price, which already includes its own price and its baked-in sub-items.
            total += (item.targetPrice || 0);
            
            // Add prices of non-baked-in sub-items.
            (item.subItems || []).forEach(sItem => {
                if (!sItem.isPriceBakedIn) {
                    total += (sItem.subItemTargetPrice || 0);
                }
            });
        });
    });

    const dec = document.getElementById('showDecimals').checked;
    const formatted = dec ? total.toFixed(2) : Math.round(total).toString();
    const currencyVal = document.getElementById("useCustomCurrencyChk").checked ? (document.getElementById("customCurrencyInput").value.trim() || "SEK") : "SEK";
    document.getElementById('totalValue').textContent= `${formatNumber(formatted)} ${currencyVal}`;
    document.getElementById('totalPrice').style.display = document.getElementById('removeTotalCheck').checked ? 'none' : '';
}
function formatPrice(price){ return formatNumber((document.getElementById('showDecimals').checked ? (price || 0).toFixed(2) : Math.round(price || 0).toString())); }
function formatNumber(numStr){ return numStr.replace(/\B(?=(\d{3})+(?!\d))/g,' '); }

document.addEventListener('click',e=>{
    if (e.target.matches('#copyJsonBtn')) { copyJsonToClipboard(); return; }
    const par = e.target.closest('.quantity');
    if (!par) return;
    const inp = par.querySelector('input[type="number"]');
    let val = parseInt(inp.value) || 0;
    if(e.target.classList.contains('increment-btn')){ inp.value = val + 1; handleQuantityChange(inp); }
    else if(e.target.classList.contains('decrement-btn')){ inp.value = Math.max(0, val - 1); handleQuantityChange(inp); }
});

function createHiddenJsonDiv(container) { const div = document.createElement('div'); div.id = 'hidden-json'; div.style.display = 'none'; div.textContent = JSON.stringify(jsonData); (container || document.getElementById('quoteContent')).appendChild(div); }
function removeHiddenJsonDiv() { document.getElementById('hidden-json')?.remove(); }
window.addEventListener('beforeprint', () => createHiddenJsonDiv());
window.addEventListener('afterprint', () => removeHiddenJsonDiv());
function handleQuantityChange(inp){
    const {item: containerId, index: idx, includedIndex: sIdx} = inp.closest('.quantity').dataset;
    const item = (containerId === 'itemsList' ? jsonData.items : jsonData.optionalItems)[idx];
    (sIdx ? item.subItems[sIdx] : item)[sIdx ? 'subItemQuantity' : 'quantity'] = parseInt(inp.value) || 0;
    saveToLocal(); reRenderAll();
}

document.getElementById('swapButton').addEventListener('click',()=>{ [jsonData.companyA, jsonData.companyB] = [jsonData.companyB, jsonData.companyA]; saveToLocal(); loadQuoteData(jsonData, currentFileName); });
document.getElementById('showProjectNumber').addEventListener('change', function(){ document.getElementById('projectNumberDiv').style.display=this.checked?'block':'none'; jsonData.quote.projectNumberVisible = this.checked; saveToLocal(); });
document.getElementById('addSignatureCheck').addEventListener('change', function(){ document.getElementById('signatureSection').style.display=this.checked?'block':'none'; jsonData.quote.showSignature = this.checked; saveToLocal(); });
document.getElementById('toggleTillSectionChk').addEventListener('change', function(){ jsonData.quote.showTillSection = this.checked; applyTillSectionVisibility(); saveToLocal(); });

document.getElementById('currencyMultiplierInput').addEventListener('input',function(){ const val=parseFloat(this.value); if(!isNaN(val)){ jsonData.quote.currencyMultiplicator=val; saveToLocal(); reRenderAll(); }});
document.getElementById('marginPercentageInput').addEventListener('input', function() { const val = parseFloat(this.value); if (!isNaN(val)) { jsonData.quote.marginPercentage = val; saveToLocal(); reRenderAll(); }});

document.getElementById('useMultipleCurrenciesChk').addEventListener('change', function() {
    jsonData.quote.useMultipleCurrencies = this.checked;
    toggleMultipleCurrencyUI(this.checked);
    saveToLocal();
    reRenderAll();
});
document.getElementById('usdRateInput').addEventListener('input', function() {
    const val = parseFloat(this.value); if(!isNaN(val)) { jsonData.quote.usdToSekRate = val; saveToLocal(); reRenderAll(); }
});
document.getElementById('eurRateInput').addEventListener('input', function() {
    const val = parseFloat(this.value); if(!isNaN(val)) { jsonData.quote.eurToSekRate = val; saveToLocal(); reRenderAll(); }
});

function toggleMultipleCurrencyUI(isMultiActive) {
    document.getElementById('multipleCurrencyRatesDiv').style.display = isMultiActive ? 'block' : 'none';
    document.getElementById('singleCurrencyMultiplierDiv').style.display = isMultiActive ? 'none' : 'block';
    if(isMultiActive) {
        updateMultiCurrencyInputsFromLiveRates(false); 
    }
}


document.getElementById('showDecimals').addEventListener('change', function(){ jsonData.quote.showDecimals = this.checked; saveToLocal(); reRenderAll(); });

document.getElementById('addItemButton').addEventListener('click',()=>{ jsonData.items.push({ name:translations[currentLanguage].newArticleName, itemDescription:translations[currentLanguage].newDescription, quantity:1, originalPrice:0, targetPrice:0, marginPercentage: 0, subItems:[], isPriceBakedIn: false }); saveToLocal(); reRenderAll(); });
document.getElementById('addOptionalItemButton').addEventListener('click',()=>{ jsonData.optionalItems.push({ name:translations[currentLanguage].newAltArticleName, itemDescription:translations[currentLanguage].newOptionalItemDescription, quantity:1, originalPrice:0, targetPrice:0, marginPercentage: 0, subItems:[] }); saveToLocal(); reRenderAll(); });
document.getElementById('addTermButton').addEventListener('click',()=>{ if (!jsonData.terms) jsonData.terms = []; jsonData.terms.push(translations[currentLanguage].newTermText); saveToLocal(); reRenderAll(); });

function parseFileName(fileName){ const match = fileName.replace(/\.json$/i,'').match(/^(.*)_(\d{6})_v(\d+)$/); return match ? { prefix: match[1], datePart: match[2], version: parseInt(match[3],10) } : null; }
document.getElementById('fileInput').addEventListener('change',function(ev){
    const f=ev.target.files[0];
    if(f && (f.type==='application/json' || f.name.endsWith('.json'))){
        const r=new FileReader();
        r.onload=(e)=>{ try {
            const cleanedText = e.target.result.replace(/‚Äì/g, '-');
            loadQuoteData(JSON.parse(cleanedText), f.name);
            saveToLocal(); 
        } catch(err){ alert('JSON-formatet verkar vara felaktigt: ' + err); } };
        r.readAsText(f);
    } else { alert('V√§nligen ladda upp en giltig JSON-fil.'); }
});

document.getElementById("toggleLanguageBtn").addEventListener('click', ()=>{ 
    currentLanguage = currentLanguage === 'sv' ? 'en' : 'sv';
    jsonData.quote.language = currentLanguage;
    saveToLocal();
    reRenderAll();
});
document.getElementById("useCustomCurrencyChk").addEventListener('change', (e) => { document.getElementById("customCurrencyInput").style.display = e.target.checked ? 'inline-block' : 'none'; jsonData.quote.useCustomCurrency = e.target.checked; saveToLocal(); reRenderAll(); });
document.getElementById("customCurrencyInput").addEventListener('input', function(){ jsonData.quote.customCurrency = this.value.trim(); saveToLocal(); reRenderAll(); });
document.getElementById("removeTotalCheck").addEventListener('change', () => calculateTotalPrice());


let itemsSortable, optionalItemsSortable, termsSortable, infoSortable, signatureSortable;
function initializeDragAndDrop(){
    if(itemsSortable) itemsSortable.destroy(); if(optionalItemsSortable) optionalItemsSortable.destroy();
    if(termsSortable) termsSortable.destroy(); if(infoSortable) infoSortable.destroy();
    if(signatureSortable) signatureSortable.destroy();
    
    const onSortEnd = (arr, evt) => { 
        if (evt.oldIndex === undefined || evt.newIndex === undefined) return;
        const [moved] = arr.splice(evt.oldIndex, 1); 
        arr.splice(evt.newIndex, 0, moved); 
        saveToLocal(); 
        reRenderAll(); 
    };

    itemsSortable = Sortable.create(document.getElementById('itemsList'),{ 
        group:'sharedItems', 
        animation:150, 
        handle: '.item-meta', 
        onEnd: (evt) => { if(evt.to === evt.from) onSortEnd(jsonData.items, evt); },
        onAdd: (evt) => { 
            if (evt.from.id === 'optionalItemsList') { 
                const [moved] = jsonData.optionalItems.splice(evt.oldIndex, 1); 
                jsonData.items.splice(evt.newIndex, 0, moved); 
                saveToLocal(); reRenderAll(); 
            } 
        }
    });
    optionalItemsSortable=Sortable.create(document.getElementById('optionalItemsList'),{ 
        group:'sharedItems', 
        animation:150, 
        handle: '.item-meta', 
        onEnd: (evt) => { if(evt.to === evt.from) onSortEnd(jsonData.optionalItems, evt); },
        onAdd: (evt) => { 
            if (evt.from.id === 'itemsList') { 
                const [moved] = jsonData.items.splice(evt.oldIndex, 1); 
                jsonData.optionalItems.splice(evt.newIndex, 0, moved); 
                saveToLocal(); reRenderAll(); 
            } 
        }
    });
    termsSortable=Sortable.create(document.getElementById('termsList'),{ animation:150, handle:'.drag-handle', onEnd: (evt) => onSortEnd(jsonData.terms, evt) });
    infoSortable=Sortable.create(document.getElementById('infoImagesList'),{ 
        animation:150, 
        handle:'.drag-handle', 
        onEnd: (evt) => onSortEnd(jsonData.infoImages, evt) 
    });
     signatureSortable=Sortable.create(document.getElementById('signatureBlocksContainer'), {
        animation: 150,
        handle: '.drag-handle',
        onEnd: (evt) => {
            const parent = evt.from;
            const item = parent.children[evt.oldIndex];
            const other = parent.children[evt.newIndex];
            if (evt.oldIndex > evt.newIndex) {
               parent.insertBefore(item, other);
            } else {
               parent.insertBefore(item, other.nextSibling);
            }
        }
    });
}

let activeEditingElement = null;
function makeEditable(){
    document.querySelectorAll('.editable').forEach(el=> {
        el.removeEventListener('input', onEditableInput); 
        el.removeEventListener('blur', onEditableBlur);
        el.addEventListener('input', onEditableInput);
        el.addEventListener('blur', onEditableBlur);
    });
}

function onEditableInput(e){
    const target = e.target; 
    const field=target.dataset.field;

    // Handle custom labels for headings, titles, etc.
    if (field && (field.endsWith('Heading') || field.endsWith('Header') || field.endsWith('Label') || field === 'quoteTitle')) {
        if (!jsonData.quote.labels) jsonData.quote.labels = {};
        jsonData.quote.labels[field] = target.textContent;
        saveToLocal();
        if (field.includes('Price')) updatePriceHeaders(); // Update currency symbol if price header changes
        return;
    }

    if(!field) { 
        const id=target.id;
        if(id === 'companyA' || id === 'companyB') {
            const lines = target.innerHTML.split(/<br\s*\/?>/gi).map(line => line.trim()).filter(Boolean); 
            let data = {};
            lines.forEach((line, index) => { data[`line${index + 1}`] = line; }); 
            jsonData[id] = data;
        }
        else if(id === 'reference'){jsonData.quote.reference=target.textContent;updateDocumentTitle();} 
        else if (id === 'signatureDate') { jsonData.signature.date = target.innerHTML; }
        else { jsonData.quote[id] = target.textContent; }
        saveToLocal(); return;
    }

    if(field === 'term'){ jsonData.terms[target.dataset.index] = target.innerHTML; saveToLocal(); return; }

    if (field.startsWith('signature')) {
        if(field === 'signatureLessorLine') jsonData.signature.lessorLine = target.innerHTML;
        if(field === 'signatureLesseeLine') jsonData.signature.lesseeLine = target.innerHTML;
        if(field === 'signatureLessorText') jsonData.signature.lessorText = target.innerHTML;
        if(field === 'signatureLesseeText') jsonData.signature.lesseeText = target.innerHTML;
        saveToLocal();
        return;
    }

    const {item: cId, index: idx, includedIndex: sIdx} = target.dataset;
    const arr = (cId === 'itemsList') ? jsonData.items : jsonData.optionalItems; if(!arr[idx])return;
    let item = sIdx !== undefined ? arr[idx].subItems[sIdx] : arr[idx]; if (!item) return;
    
    let val = target.classList.contains('p-editable') || field.includes('Description') ? target.innerHTML : target.textContent;

    if(field === "itemNumber" || field === "subItemNumber") {
        item[field] = val; 
    } else if (field === 'marginPercentage') {
        const marginValue = parseFloat(val.replace(/[+%]/g, ''));
        if (!isNaN(marginValue)) item.marginPercentage = marginValue;
    } else if (field === 'originalPriceAndCurrency') {
        const match = val.match(/([0-9.,]+)\s*([a-zA-Z]{3})/);
        if (match){
            const price = parseFloat(match[1].replace(',','.')); const currency = match[2].toUpperCase();
            if(!isNaN(price) && currency.length === 3){
                if(sIdx !== undefined){ item.subItemOriginalPrice = price; item.currencyOrigin = currency; }
                else { item.originalPrice = price; item.currencyOrigin = currency; }
            }
        }
    } else if (field.includes('Description')){ item[field] = target.innerHTML.replace(/<br\s*\/?>/gi,'\n');
    } else { item[field] = val.replace(/<span.*>.*<\/span>$/, '').trim(); } 
    
    saveToLocal();
    if (field === 'marginPercentage' || field === 'originalPriceAndCurrency') {
        updatePrices(); 
        calculateTotalPrice();
        updateLiveDOMPrices(cId, idx, sIdx);
    }
}

function onEditableBlur(e) {
    activeEditingElement = null;
    hideFormattingToolbar();
    const field = e.target.dataset.field;
    if (field === 'originalPriceAndCurrency' || field === 'marginPercentage') {
        reRenderAll();
    }
}
function updateLiveDOMPrices(containerId, mainIndex, subIndex) {
    const arr = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    if (!arr[mainIndex]) return;
    const item = (subIndex !== undefined) ? arr[mainIndex].subItems[subIndex] : arr[mainIndex];
    if (!item) return;

    const priceField = (subIndex !== undefined) ? 'subItemTargetPrice' : 'targetPrice';
    const selector = `[data-item="${containerId}"][data-index="${mainIndex}"]` + (subIndex !== undefined ? `[data-included-index="${subIndex}"]` : '') + ` div[data-field="${priceField}"] span`;
    const priceSpan = document.querySelector(selector);
    if(priceSpan) priceSpan.textContent = formatPrice((item[priceField] || 0));
}
function buildFileName(ref, version){ const datePart= new Date().toISOString().slice(2,10).replace(/-/g,''); const safeRef = (ref||'').trim().replace(/[^\w\s\-]/gi, '').replace(/\s+/g,'-').substring(0, 50); return `${safeRef || 'offert'}_${datePart}_v${version}.json`; }
function doDownloadJson(fileName){ const dl=document.createElement('a'); dl.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(jsonData,null,2)); dl.download = fileName; document.body.appendChild(dl); dl.click(); dl.remove(); }
document.getElementById('saveJson').addEventListener('click',()=>{ doDownloadJson(buildFileName(jsonData.quote.reference,1)); });

function copyJsonToClipboard(){
    const dataToCopy = JSON.parse(JSON.stringify(jsonData));
    if (dataToCopy.infoImages) {
        dataToCopy.infoImages.forEach(img => { if(img.type === 'image') delete img.src });
    }
    navigator.clipboard.writeText(JSON.stringify(dataToCopy, null, 2)).then(() => {
        const msgEl = document.getElementById('statusMessage');
        msgEl.textContent = translations[currentLanguage].statusJsonCopied;
        setTimeout(() => { msgEl.textContent = '' }, 3000);
    });
}
document.getElementById('printBtn').addEventListener('click', () => window.print());
function saveToLocal(){ localStorage.setItem('quoteData', JSON.stringify(jsonData)); }

window.onload=()=>{ 
    loadQuoteData(jsonData); 
    fetchLiveCurrencyRates();

    const compressChk = document.getElementById('compressImagesChk');
    const compressOpts = document.getElementById('compressionOptions');
    const toggleCompressionOpts = () => {
        compressOpts.style.display = compressChk.checked ? 'inline-flex' : 'none';
    };
    compressChk.addEventListener('change', toggleCompressionOpts);
    toggleCompressionOpts();
};

function updateMultiCurrencyInputsFromLiveRates(overwriteManual = false) {
    const usdInput = document.getElementById('usdRateInput');
    const eurInput = document.getElementById('eurRateInput');
    const currentJsonUsd = parseFloat(jsonData.quote.usdToSekRate).toFixed(2);
    const currentJsonEur = parseFloat(jsonData.quote.eurToSekRate).toFixed(2);

    if (window.liveExchangeRates.usd !== null) {
        const liveUsdRateWithMargin = (parseFloat(window.liveExchangeRates.usd) + 0.4).toFixed(2);
        if (overwriteManual || parseFloat(usdInput.value).toFixed(2) === currentJsonUsd || usdInput.value === "") { 
             usdInput.value = liveUsdRateWithMargin;
             jsonData.quote.usdToSekRate = parseFloat(liveUsdRateWithMargin);
        }
    }
    if (window.liveExchangeRates.eur !== null) {
        const liveEurRateWithMargin = (parseFloat(window.liveExchangeRates.eur) + 0.4).toFixed(2);
         if (overwriteManual || parseFloat(eurInput.value).toFixed(2) === currentJsonEur || eurInput.value === "") {
            eurInput.value = liveEurRateWithMargin;
            jsonData.quote.eurToSekRate = parseFloat(liveEurRateWithMargin);
        }
    }
    if (jsonData.quote.useMultipleCurrencies && (parseFloat(jsonData.quote.usdToSekRate).toFixed(2) !== currentJsonUsd || parseFloat(jsonData.quote.eurToSekRate).toFixed(2) !== currentJsonEur ) ) { 
        saveToLocal(); 
        reRenderAll(); 
    }
}

async function fetchLiveCurrencyRates() {
    const container = document.getElementById('liveCurrencyRates');
    container.innerHTML = 'Laddar kurser...';
    let displayHtml = [];

    const fetchRate = async (base) => {
        for (let i = 0; i < 10; i++) { 
            const date = new Date(); date.setDate(date.getDate() - i); const dateStr = date.toISOString().split("T")[0];
            try {
                const res = await fetch(`https://${dateStr}.currency-api.pages.dev/v1/currencies/${base.toLowerCase()}.json`); 
                if (!res.ok) continue;
                const data = await res.json(); 
                const rate = data?.[base.toLowerCase()]?.['sek'];
                if (rate) {
                    window.liveExchangeRates[base.toLowerCase()] = parseFloat(rate);
                    return `1 ${base.toUpperCase()} = ${parseFloat(rate).toFixed(2)} SEK (${dateStr.slice(5)})`;
                }
            } catch (err) { console.warn(`Failed to fetch ${base} for ${dateStr}:`, err); continue; }
        }
        return `Kurs f√∂r ${base.toUpperCase()} otillg√§nglig`;
    };

    displayHtml = await Promise.all(['usd', 'eur'].map(fetchRate));
    container.innerHTML = displayHtml.join('<br/>');
    if (jsonData.quote.useMultipleCurrencies) { 
      updateMultiCurrencyInputsFromLiveRates(false); 
    }
}


document.addEventListener('DOMContentLoaded', function () {
    const savePdfBtn = document.getElementById('savePdfBtn');
    savePdfBtn.addEventListener('click', async () => {
		const quoteContent = document.getElementById('quoteContent'); if (!quoteContent) return alert("Inneh√•ll saknas.");
        const clone = quoteContent.cloneNode(true); clone.querySelectorAll('.screen-only').forEach(el => el.style.display = 'none');
		createHiddenJsonDiv(clone); 
        const container = document.createElement('div'); container.style.cssText = 'position:fixed; left:-9999px; top:0; width:210mm;';
        container.appendChild(clone); document.body.appendChild(container);
        const ref = (document.getElementById('reference')?.textContent || 'Offert').trim(), qNum = (document.getElementById('quoteNumber')?.textContent || '0000').trim();
        const fileName = `${ref.replace(/[^\w\s\-]/gi, '').replace(/\s+/g, '-')}_${qNum}_${new Date().toISOString().split("T")[0]}.pdf`;
        try {
            await html2pdf().set({ margin: 10, filename: fileName, image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollX: 0, scrollY: 0, windowWidth: document.documentElement.scrollWidth, windowHeight: document.documentElement.scrollHeight },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(clone).save();
        } catch (err) { console.error("PDF generation failed:", err); } finally { container.remove(); }
    });

    document.addEventListener('keydown', function(event) {
        if ((event.ctrlKey || event.metaKey) && event.key === 's') {
            event.preventDefault();
            if (jsonData && jsonData.quote && typeof buildFileName === 'function' && typeof doDownloadJson === 'function') {
                doDownloadJson(buildFileName(jsonData.quote.reference, 1));
            } else {
                console.warn("Cannot save: jsonData or helper functions not ready.");
            }
        }
         if (event.ctrlKey || event.metaKey) { 
            if (event.key.toLowerCase() === 'b' && document.activeElement.isContentEditable) { event.preventDefault(); document.execCommand('bold'); }
            if (event.key.toLowerCase() === 'i' && document.activeElement.isContentEditable) { event.preventDefault(); document.execCommand('italic'); }
        }
    });

    // Add touch listener for quantity buttons on mobile
    document.addEventListener('touchstart', function(e) {
        const activeContainers = document.querySelectorAll('.input-container.mobile-active');
        const tappedContainer = e.target.closest('.input-container');

        activeContainers.forEach(container => {
            if (container !== tappedContainer) {
                container.classList.remove('mobile-active');
            }
        });

        if (tappedContainer) {
            tappedContainer.classList.add('mobile-active');
        }
    }, { passive: true });
});

function updatePrintMultiplier(){ 
    const multiplierSpan = document.getElementById('multiplierValue');
    if (!multiplierSpan) return;

    if (jsonData.quote.useMultipleCurrencies) {
        let ratesText = [];
        if (jsonData.quote.usdToSekRate) ratesText.push(`USD: ${parseFloat(jsonData.quote.usdToSekRate).toFixed(2)}`);
        if (jsonData.quote.eurToSekRate) ratesText.push(`EUR: ${parseFloat(jsonData.quote.eurToSekRate).toFixed(2)}`);
        multiplierSpan.textContent = ratesText.length > 0 ? `Kurser: ${ratesText.join(', ')} SEK` : "Multipla kurser aktiva";
    } else {
        multiplierSpan.textContent = `Valutakurs: ${jsonData.quote.currencyMultiplicator ?? 1}`; 
    }
}

window.addEventListener('load', () => { 
    const q = jsonData.quote;
    q.language = q.language || currentLanguage; q.customCurrency = q.customCurrency || '';
    q.useCustomCurrency = q.useCustomCurrency === undefined ? !!q.customCurrency : q.useCustomCurrency;
    currentLanguage = q.language;
    document.getElementById('customCurrencyInput').value = q.customCurrency;
    document.getElementById('useCustomCurrencyChk').checked = q.useCustomCurrency;
    document.getElementById('useCustomCurrencyChk').dispatchEvent(new Event('change')); 
    
    document.getElementById('useMultipleCurrenciesChk').checked = q.useMultipleCurrencies;
    toggleMultipleCurrencyUI(q.useMultipleCurrencies);
    document.getElementById('usdRateInput').value = parseFloat(q.usdToSekRate || 10.50).toFixed(2);
    document.getElementById('eurRateInput').value = parseFloat(q.eurToSekRate || 11.50).toFixed(2);

    document.getElementById('addSignatureCheck').checked = q.showSignature;
    document.getElementById('addSignatureCheck').dispatchEvent(new Event('change'));
    
    document.getElementById('toggleTillSectionChk').checked = q.showTillSection;
    applyTillSectionVisibility();

    updatePrintMultiplier();
    setupFormattingToolbar();
    reRenderAll(); 
});
document.getElementById('uploadPdfBtn').addEventListener('click', () => document.getElementById('pdfUploadInput').click());
document.getElementById('pdfUploadInput').addEventListener('change', async function(ev) {
  const file = ev.target.files[0]; if (!file) return;
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let fullText = '';
  for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const content = await page.getTextContent(); fullText += content.items.map(it => it.str).join(''); }
  const start = fullText.indexOf('{"quote"'); const end = fullText.lastIndexOf('}');
  if (start >= 0 && end > start) { 
    try { 
        const extractedJson = fullText.substring(start, end + 1);
        loadQuoteData(JSON.parse(extractedJson), file.name); 
        saveToLocal(); 
    } catch (err) { alert('Fel vid avkodning av PDF-data: ' + err + '\nData:\n' + extractedJson.substring(0,200)); }
  } else { alert('Ingen inb√§ddad offertdata hittades i PDF-filen.'); }
});

// --- Formatting & Hierarchy Logic ---
const toolbar = document.getElementById('formatting-toolbar');
function setupFormattingToolbar() {
    document.addEventListener('selectionchange', () => {
        const selection = window.getSelection();
        if (selection.rangeCount > 0 && !selection.isCollapsed) {
            const range = selection.getRangeAt(0);
            const parentEditable = range.startContainer.parentElement.closest('.editable');
            if (parentEditable && parentEditable.isContentEditable) { 
                const rect = range.getBoundingClientRect();
                toolbar.style.left = `${rect.right + window.scrollX + 5}px`;
                toolbar.style.top = `${rect.top + window.scrollY}px`;
                toolbar.style.display = 'flex';
                return;
            }
        }
        hideFormattingToolbar();
    });

    document.getElementById('bold-btn').addEventListener('mousedown', (e) => { e.preventDefault(); document.execCommand('bold'); });
    document.getElementById('italic-btn').addEventListener('mousedown', (e) => { e.preventDefault(); document.execCommand('italic'); });
    document.getElementById('bullet-btn').addEventListener('mousedown', (e) => { e.preventDefault(); toggleBulletPoints(); });

}
function hideFormattingToolbar() {
    if (toolbar) toolbar.style.display = 'none';
}

function toggleBulletPoints() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;
    const editable = container.nodeType === 1 ? container.closest('.editable') : container.parentElement.closest('.editable');
    if (!editable) return;

    // Create a temporary div to manipulate the HTML of the selection
    const content = range.extractContents();
    const tempDiv = document.createElement('div');
    tempDiv.appendChild(content);
    
    let html = tempDiv.innerHTML;
    // Simple check to see if it's already a list
    const isBulleted = html.trim().startsWith('‚Ä¢') || html.includes('<br>‚Ä¢');

    let newHtml;
    if (isBulleted) {
        // Remove bullets
        newHtml = html.replace(/‚Ä¢\s?/g, '').replace(/<br>\s*<br>/g, '<br>');
    } else {
        // Add bullets
        const lines = html.split('<br>').filter(line => line.trim() !== '');
        newHtml = lines.map(line => '‚Ä¢ ' + line.trim()).join('<br>');
    }

    // Use execCommand to insert the modified HTML back
    document.execCommand('insertHTML', false, newHtml);
}


function mapItemToSubItem(item) {
    return {
        subItemName: item.name,
        subItemDescription: item.itemDescription,
        subItemQuantity: item.quantity,
        subItemOriginalPrice: item.originalPrice,
        marginPercentage: item.marginPercentage,
        currencyOrigin: item.currencyOrigin,
        subItems: item.subItems || [],
        isPriceBakedIn: false // Sub-items are not baked-in by default when converted
    };
}
function mapSubItemToItem(subItem) {
    return {
        name: subItem.subItemName,
        itemDescription: subItem.subItemDescription,
        quantity: subItem.subItemQuantity,
        originalPrice: subItem.subItemOriginalPrice,
        marginPercentage: subItem.marginPercentage,
        currencyOrigin: subItem.currencyOrigin,
        subItems: subItem.subItems || [] ,
        isPriceBakedIn: false
    };
}


function toggleItemHierarchy(containerId, mainIndex, subIndex) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    if (subIndex !== undefined) { 
        const [subItem] = list[mainIndex].subItems.splice(subIndex, 1);
        const newMainItem = mapSubItemToItem(subItem);
        list.splice(mainIndex + 1, 0, newMainItem);
    } else { 
        if (mainIndex > 0) {
            const [itemToMove] = list.splice(mainIndex, 1);
            const parentItem = list[mainIndex - 1];
            if (!parentItem.subItems) parentItem.subItems = [];
            
            const newSubItem = mapItemToSubItem(itemToMove);
            parentItem.subItems.push(newSubItem);
        } else {
            alert("F√∂rsta artikeln kan inte g√∂ras om till en underpost utan en huvudpost ovanf√∂r.");
        }
    }
    saveToLocal();
    reRenderAll();
}

function renumberAllItems() {
    const processList = (list, prefix, isOptional, isTopLevel) => {
        let itemCounter = 0;
        (list || []).forEach(item => {
            itemCounter++;
            let baseNumber;
            if (isTopLevel) {
                baseNumber = (isOptional ? 'A' : '') + itemCounter + ".1";
                item.itemNumber = baseNumber;
            } else {
                baseNumber = prefix + "." + itemCounter;
                item.subItemNumber = baseNumber;
            }

            if (item.subItems && item.subItems.length > 0) {
                processList(item.subItems, baseNumber, false, false);
            }
        });
    };

    processList(jsonData.items, '', false, true);
    processList(jsonData.optionalItems, '', true, true);
    saveToLocal();
}

function toggleItemOptionality(containerId, mainIndex) {
    const sourceList = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    const destinationList = (containerId === 'itemsList') ? jsonData.optionalItems : jsonData.items;
    
    if (sourceList[mainIndex]) {
        const [movedItem] = sourceList.splice(mainIndex, 1);
        destinationList.push(movedItem); 
        saveToLocal();
        reRenderAll(); 
    }
}

// Item/Sub-item Movement Functions
function moveItemUp(containerId, index) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    if (index > 0) {
        [list[index], list[index - 1]] = [list[index - 1], list[index]];
        saveToLocal();
        reRenderAll(); 
    }
}
function moveItemDown(containerId, index) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    if (index < list.length - 1) {
        [list[index], list[index + 1]] = [list[index + 1], list[index]];
        saveToLocal();
        reRenderAll(); 
    }
}
function moveSubItemUp(containerId, mainIndex, subIndex) {
    const parentItem = (containerId === 'itemsList') ? jsonData.items[mainIndex] : jsonData.optionalItems[mainIndex];
    if (parentItem && parentItem.subItems && subIndex > 0) {
        const subList = parentItem.subItems;
        [subList[subIndex], subList[subIndex - 1]] = [subList[subIndex - 1], subList[subIndex]];
        saveToLocal();
        reRenderAll(); 
    }
}
function moveSubItemDown(containerId, mainIndex, subIndex) {
    const parentItem = (containerId === 'itemsList') ? jsonData.items[mainIndex] : jsonData.optionalItems[mainIndex];
    if (parentItem && parentItem.subItems) {
        const subList = parentItem.subItems;
        if (subIndex < subList.length - 1) {
            [subList[subIndex], subList[subIndex + 1]] = [subList[subIndex + 1], subList[subIndex]];
            saveToLocal();
            reRenderAll(); 
        }
    }
}

// Term Movement Functions
function moveTermUp(idx){
    if(idx > 0 && jsonData.terms){
        [jsonData.terms[idx], jsonData.terms[idx-1]] = [jsonData.terms[idx-1], jsonData.terms[idx]];
        saveToLocal();
        reRenderAll();
    }
}
function moveTermDown(idx){
    if(jsonData.terms && idx < jsonData.terms.length - 1){
        [jsonData.terms[idx], jsonData.terms[idx+1]] = [jsonData.terms[idx+1], jsonData.terms[idx]];
        saveToLocal();
        reRenderAll();
    }
}

// Image Size Adjustment for Mobile
function adjustImageSize(index, factor) {
    if (jsonData.infoImages && jsonData.infoImages[index] && jsonData.infoImages[index].type === 'image') {
        const imgData = jsonData.infoImages[index];
        let currentWidth = parseFloat(imgData.width) || 400;
        let newWidth = currentWidth * factor;
        if (newWidth < 50) newWidth = 50; // Prevent disappearing
        imgData.width = newWidth;
        saveToLocal();
        reRenderAll();
    }
}

function addSubItemToParent(containerId, parentIndex) {
    const parentList = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    const parentItem = parentList[parentIndex];
    if (parentItem) {
        if (!parentItem.subItems) {
            parentItem.subItems = [];
        }
        const newSubItem = {
            subItemName: translations[currentLanguage].newSubItemName,
            subItemDescription: translations[currentLanguage].newSubItemDescription,
            subItemQuantity: 1,
            subItemOriginalPrice: 0,
            marginPercentage: 0,
            isPriceBakedIn: false
        };
        parentItem.subItems.push(newSubItem);
        saveToLocal();
        reRenderAll();
    }
}

function removeAllSubItems(containerId, parentIndex) {
    const parentList = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    const parentItem = parentList[parentIndex];
    if (parentItem && parentItem.subItems && parentItem.subItems.length > 0) {
        if (confirm(`√Ñr du s√§ker p√• att du vill ta bort alla underposter f√∂r "${parentItem.name}"?`)) {
            parentItem.subItems = [];
            saveToLocal();
            reRenderAll();
        }
    }
}

function applyTillSectionVisibility() {
    const show = document.getElementById('toggleTillSectionChk').checked;
    const tillWrapper = document.getElementById('companyA_wrapper');
    const swapButton = document.getElementById('swapButton');
    const quoteSection = document.getElementById('quoteSection');
    
    tillWrapper.style.display = show ? '' : 'none';
    swapButton.style.display = show ? '' : 'none';
    quoteSection.style.justifyContent = show ? 'space-between' : 'flex-end';
}
function toggleBakeInPrice(containerId, index) {
    if (containerId !== 'itemsList') return;
    const item = jsonData.items[index];
    item.isPriceBakedIn = !item.isPriceBakedIn;
    saveToLocal();
    reRenderAll();
}

function toggleBakeInSubItemPrice(containerId, mainIndex, subIndex) {
    const list = (containerId === 'itemsList') ? jsonData.items : jsonData.optionalItems;
    const subItem = list[mainIndex]?.subItems?.[subIndex];
    if (subItem) {
        subItem.isPriceBakedIn = !subItem.isPriceBakedIn;
        saveToLocal();
        reRenderAll();
    }
}

// --- Section Visibility ---
function applySectionVisibility() {
    const visibility = jsonData.quote.visibility || {};
    document.getElementById('optionalSectionContainer').style.display = visibility.optional ? '' : 'none';
    document.getElementById('infoSectionContainer').style.display = visibility.info ? '' : 'none';
    document.getElementById('termsSectionContainer').style.display = visibility.terms ? '' : 'none';
}

function updateSectionVisibilityCheckboxes() {
    const visibility = jsonData.quote.visibility || {};
    document.getElementById('showOptionalSectionChk').checked = !!visibility.optional;
    document.getElementById('showInfoSectionChk').checked = !!visibility.info;
    document.getElementById('showTermsSectionChk').checked = !!visibility.terms;
}

document.getElementById('sectionVisibilityControls').addEventListener('change', (e) => {
    if (e.target.type === 'checkbox') {
        const section = e.target.dataset.section;
        if (section && jsonData.quote.visibility.hasOwnProperty(section)) {
            jsonData.quote.visibility[section] = e.target.checked;
            saveToLocal();
            applySectionVisibility();
        }
    }
});

</script>
</body>
</html>
